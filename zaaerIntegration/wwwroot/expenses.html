<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة المصروفات - Expenses Management</title>
    
    <!-- Google Fonts - Cairo -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
    
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    
    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- SheetJS (xlsx) for Excel Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- jsPDF and jsPDF-AutoTable for PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <!-- html2canvas for better Arabic support -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- jQuery Calendars (Local Files) - Load in correct order -->
    <script src="js/jquery.plugin.js"></script>
    <script src="js/jquery.calendars.js"></script>
    <script src="js/jquery.calendars.plus.js"></script>
    <script src="js/jquery.calendars.picker.js"></script>
    <script src="js/jquery.calendars.ummalqura.js"></script>
    
    <!-- Calendar CSS -->
    <link rel="stylesheet" href="css/ummalqura.calendars.picker.css" />
    
    <!-- Local Calendar Convert JS -->
    <script src="js/calendar-convert.js"></script>
    
    <style>
        :root {
            --primary-blue: #007ACC;
            --dark-blue: #005A9E;
            --light-blue: #E3F2FD;
            --success-green: #28A745;
            --warning-orange: #FF9800;
            --danger-red: #DC3545;
            --gray-bg: #F5F5F5;
            --dark-gray: #333333;
            --light-gray: #E0E0E0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cairo', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 8px;
            direction: rtl;
            font-size: 13px;
        }

        /* Header - Compact */
        .page-header {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--dark-blue) 100%);
            color: white;
            padding: 10px 15px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 122, 204, 0.3);
            margin-bottom: 10px;
            animation: slideDown 0.6s ease-out;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        
        .page-header-content {
            text-align: center;
            flex: 1;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .page-header h1 {
            font-family: 'Cairo', sans-serif;
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .page-header p {
            font-family: 'Cairo', sans-serif;
            opacity: 0.9;
            font-size: 9px;
            margin: 0;
            margin-top: 2px;
            line-height: 1.2;
        }

        /* Logout Button */
        .logout-btn {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-50%) scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .logout-btn svg {
            width: 20px;
            height: 20px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
        }

        /* Session Timeout Warning */
        .session-warning {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.4);
            z-index: 10001;
            display: none;
            align-items: center;
            gap: 10px;
            animation: slideInRight 0.3s ease-out;
            max-width: 350px;
        }

        .session-warning.show {
            display: flex;
        }

        .session-warning svg {
            width: 24px;
            height: 24px;
            flex-shrink: 0;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Hotel Selector - Compact */
        .hotel-selector {
            position: fixed;
            top: 8px;
            left: 8px;
            z-index: 1000;
            background: white;
            padding: 8px 12px;
            border-radius: 6px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
            border: 2px solid var(--primary-blue);
            min-width: 180px;
        }

        .hotel-selector label {
            display: block;
            font-weight: 600;
            color: var(--dark-gray);
            margin-bottom: 4px;
            font-size: 11px;
        }

        /* Main Container */
        .main-container {
            max-width: 100%;
            margin: 0 auto;
            animation: fadeIn 0.8s ease-out;
            padding: 0 8px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Form Card - Compact and Professional */
        .form-card {
            background: white;
            border-radius: 8px;
            padding: 18px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            margin-bottom: 10px;
            border: 1px solid #f0f0f0;
        }

        /* All Expenses Tab - More Padding */
        #all-expenses-tab .form-card {
            padding: 24px 28px;
        }

        .add-expense-layout {
            display: flex;
            gap: 24px;
            align-items: stretch;
        }

        .add-expense-form {
            flex: 1;
        }

        .add-expense-visual {
            flex: 1;
            border-radius: 14px;
            padding: 28px;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #1b8fd8 100%);
            color: #f3f7ff;
            box-shadow: 0 20px 40px rgba(34, 103, 209, 0.35);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 100%;
        }

        .add-expense-visual::before,
        .add-expense-visual::after {
            content: '';
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.08);
            z-index: 1;
        }

        .add-expense-visual::before {
            width: 240px;
            height: 240px;
            bottom: -60px;
            left: -60px;
        }

        .add-expense-visual::after {
            width: 300px;
            height: 300px;
            top: -120px;
            right: -80px;
        }

        .add-expense-visual-content {
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
            gap: 20px;
            height: 100%;
        }

        .add-expense-visual-icon {
            width: 64px;
            height: 64px;
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.2);
        }

        .add-expense-visual-icon svg {
            width: 28px;
            height: 28px;
            color: #fff;
        }

        .add-expense-visual h3 {
            font-size: 24px;
            margin: 0;
            line-height: 1.4;
            font-weight: 700;
            color: #ffffff;
        }

        .add-expense-visual p {
            margin: 0;
            color: #e0e7ff;
            line-height: 1.7;
            font-size: 14px;
        }

        .add-expense-visual-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .add-expense-visual-list li {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #f3f7ff;
        }

        .add-expense-visual-list li svg {
            width: 18px;
            height: 18px;
            color: #00ffc6;
        }

        .add-expense-visual-stats {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 12px;
        }

        .visual-stat-card {
            background: rgba(255, 255, 255, 0.12);
            border-radius: 12px;
            padding: 14px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.1);
        }

        .visual-stat-card span {
            font-size: 12px;
            color: #dbeafe;
            letter-spacing: 0.5px;
        }

        .visual-stat-card strong {
            font-size: 18px;
            color: #fff;
        }

        .add-expense-visual-footer {
            margin-top: auto;
            padding-top: 10px;
            font-size: 13px;
            color: #dbeafe;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-title {
            font-family: 'Cairo', sans-serif;
            font-size: 14px;
            font-weight: 600;
            color: var(--primary-blue);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e8f0fe;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Form Groups - Very Close Together */
        .form-group {
            margin-bottom: 8px;
        }

        .form-group label {
            display: block;
            font-weight: 900;
            color: #000000;
            margin-bottom: 5px;
            font-size: 12px;
            font-family: 'Cairo', sans-serif;
        }

        .form-group.required label::after {
            content: ' *';
            color: var(--danger-red);
        }

        /* Tax Checkbox Styling */
        .tax-checkbox {
            margin-right: 8px;
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--primary-blue);
        }

        .tax-checkbox-label {
            font-weight: 400;
            font-size: 11px;
            color: #666;
            margin-right: 4px;
        }

        .tax-info {
            display: block;
            color: #666;
            font-size: 11px;
            margin-top: 4px;
        }

        /* Inputs - Compact & Professional */
        .form-control, .form-select {
            font-family: 'Cairo', sans-serif;
            font-size: 12px;
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            transition: all 0.2s ease;
            width: 100%;
            background: #ffffff;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 2px rgba(0, 122, 204, 0.1);
            outline: none;
            background: #ffffff;
        }

        textarea.form-control {
            resize: vertical;
            min-height: 60px;
            font-family: 'Cairo', sans-serif;
            border: 1px solid #e0e0e0;
        }

        textarea.form-control:focus {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 2px rgba(0, 122, 204, 0.1);
            outline: none;
        }

        /* Select2 Custom Styling - Professional Design */
        .select2-container {
            width: 100% !important;
            font-family: 'Cairo', sans-serif;
        }

        /* Select2 Selection Box */
        .select2-container--default .select2-selection--single,
        .select2-container--bootstrap-5 .select2-selection {
            min-height: 36px;
            height: 36px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            background-color: #ffffff;
            transition: all 0.2s ease;
            padding: 0;
            font-family: 'Cairo', sans-serif;
        }

        .select2-container--default .select2-selection--single .select2-selection__rendered,
        .select2-container--bootstrap-5 .select2-selection--single .select2-selection__rendered {
            line-height: 34px;
            padding-right: 12px;
            padding-left: 32px;
            color: #374151;
            font-size: 12px;
            font-weight: 400;
            font-family: 'Cairo', sans-serif;
        }

        .select2-container--default .select2-selection--single .select2-selection__arrow,
        .select2-container--bootstrap-5 .select2-selection--single .select2-selection__arrow {
            height: 36px;
            right: 10px;
            width: 20px;
        }

        .select2-container--default .select2-selection--single .select2-selection__arrow b,
        .select2-container--bootstrap-5 .select2-selection--single .select2-selection__arrow b {
            border-color: #6b7280 transparent transparent transparent;
            border-style: solid;
            border-width: 5px 4px 0 4px;
            height: 0;
            left: 50%;
            margin-left: -4px;
            margin-top: -2px;
            position: absolute;
            top: 50%;
            width: 0;
        }

        /* Focus and Open States */
        .select2-container--default.select2-container--focus .select2-selection--single,
        .select2-container--default.select2-container--open .select2-selection--single,
        .select2-container--bootstrap-5.select2-container--focus .select2-selection,
        .select2-container--bootstrap-5.select2-container--open .select2-selection {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(0, 122, 204, 0.1);
            outline: none;
        }

        /* Dropdown */
        .select2-dropdown {
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            direction: rtl;
            background-color: #ffffff;
            margin-top: 4px;
        }

        /* Search Field in Dropdown */
        .select2-search--dropdown {
            padding: 8px;
            background-color: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
        }

        .select2-search--dropdown .select2-search__field {
            border: 1px solid #d1d5db;
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 14px;
            direction: rtl;
            width: 100%;
            background-color: #ffffff;
            transition: all 0.2s ease;
        }

        .select2-search--dropdown .select2-search__field:focus {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(0, 122, 204, 0.1);
            outline: none;
        }

        .select2-search--dropdown .select2-search__field::placeholder {
            color: #9ca3af;
        }

        /* Results Container */
        .select2-results {
            max-height: 300px;
            overflow-y: auto;
            padding: 4px 0;
        }

        .select2-results__option {
            padding: 8px 14px;
            font-size: 12px;
            font-family: 'Cairo', sans-serif;
            direction: rtl;
            color: #374151;
            transition: all 0.15s ease;
            cursor: pointer;
        }

        .select2-results__option:hover {
            background-color: #f3f4f6;
            color: #111827;
        }

        .select2-results__option--highlighted {
            background-color: var(--primary-blue) !important;
            color: #ffffff !important;
        }

        .select2-results__option[aria-selected=true] {
            background-color: var(--light-blue);
            color: var(--dark-gray);
            font-weight: 500;
        }

        .select2-results__option[aria-selected=true]:hover {
            background-color: var(--primary-blue);
            color: #ffffff;
        }

        /* No Results Message */
        .select2-results__message {
            padding: 12px 16px;
            color: #6b7280;
            font-size: 14px;
            text-align: center;
        }

        /* Loading State */
        .select2-results__option--loading {
            padding: 12px 16px;
            color: #6b7280;
            text-align: center;
        }

        /* Hotel Selector Select2 - Smaller */
        .hotel-selector .select2-container--default .select2-selection--single,
        .hotel-selector .select2-container--bootstrap-5 .select2-selection {
            min-height: 32px;
            height: 32px;
            font-size: 13px;
        }

        .hotel-selector .select2-container--default .select2-selection--single .select2-selection__rendered,
        .hotel-selector .select2-container--bootstrap-5 .select2-selection--single .select2-selection__rendered {
            line-height: 30px;
            padding-right: 10px;
            padding-left: 28px;
            font-size: 13px;
        }

        .hotel-selector .select2-container--default .select2-selection--single .select2-selection__arrow,
        .hotel-selector .select2-container--bootstrap-5 .select2-selection--single .select2-selection__arrow {
            height: 30px;
            right: 8px;
        }

        /* Disabled State */
        .select2-container--default.select2-container--disabled .select2-selection--single,
        .select2-container--bootstrap-5.select2-container--disabled .select2-selection {
            background-color: #f3f4f6;
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* Placeholder */
        .select2-container--default .select2-selection--single .select2-selection__placeholder,
        .select2-container--bootstrap-5 .select2-selection--single .select2-selection__placeholder {
            color: #9ca3af;
        }

        /* Calendar Picker Styles */
        #expenseDate, #dueDate {
            position: relative;
        }
        
        /* Disabled input styling */
        input[disabled] {
            background-color: #f5f5f5;
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        input[disabled]:focus {
            background-color: #f5f5f5;
        }

        /* ✅ Move number inputs to right position (RTL) */
        #totalAmount,
        #taxAmount,
        .amount-input {
            text-align: right;
            direction: rtl;
        }

        .calendars-popup {
            z-index: 10000 !important;
            direction: rtl;
        }

        .calendars {
            font-family: 'Cairo', sans-serif;
            border: 1px solid #e0e0e0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .calendars-nav, .calendars-ctrl {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--dark-blue) 100%);
        }

        .calendars-cmd:hover {
            background-color: rgba(255, 255, 255, 0.2) !important;
        }

        .calendars-day-selected {
            background-color: var(--primary-blue) !important;
            color: white !important;
        }

        .calendars-day:hover {
            background-color: var(--light-blue) !important;
        }

        .calendars-day-today {
            border: 2px solid var(--primary-blue) !important;
            font-weight: bold;
        }


        /* Expense Rooms Section - Very Compact */
        .expense-rooms-section {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 2px solid var(--light-gray);
        }

        .expense-rooms-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .expense-rooms-header h3 {
            font-family: 'Cairo', sans-serif;
            font-size: 13px;
            font-weight: 600;
            color: var(--dark-gray);
            display: flex;
            align-items: center;
            gap: 6px;
            margin: 0;
        }

        .add-room-btn {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, var(--success-green) 0%, #218838 100%);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.3s ease;
        }

        .add-room-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
        }

        .expense-rooms-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 6px;
            overflow: hidden;
            font-size: 11px;
            margin-bottom: 8px;
        }

        .expense-rooms-table thead {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--dark-blue) 100%);
            color: white;
        }

        .expense-rooms-table th {
            padding: 6px 12px;
            text-align: right;
            font-weight: 600;
            font-size: 11px;
        }

        .expense-rooms-table th:first-child {
            min-width: 200px;
            width: 30%;
        }

        .expense-rooms-table td {
            padding: 6px 12px;
            border-bottom: 1px solid var(--light-gray);
        }

        .expense-rooms-table td:first-child {
            min-width: 200px;
            width: 30%;
        }

        .expense-rooms-table .select2-container {
            width: 100% !important;
            min-width: 180px;
        }

        .expense-rooms-table .select2-container .select2-selection--single {
            padding-right: 12px !important;
        }

        .expense-rooms-table .form-control,
        .expense-rooms-table .form-select {
            font-family: 'Cairo', sans-serif;
            font-size: 11px;
            padding: 4px 6px;
            border: 1px solid #e0e0e0;
        }

        /* Select2 in Expense Rooms Table - Reduced Right Padding */
        .expense-rooms-table .select2-container--default .select2-selection--single .select2-selection__rendered,
        .expense-rooms-table .select2-container--bootstrap-5 .select2-selection--single .select2-selection__rendered {
            padding-right: 8px !important;
            padding-left: 28px !important;
        }

        .expense-rooms-table .select2-container--default .select2-selection--single .select2-selection__arrow,
        .expense-rooms-table .select2-container--bootstrap-5 .select2-selection--single .select2-selection__arrow {
            right: 6px !important;
            width: 18px !important;
        }

        .expense-rooms-table tbody tr {
            transition: background-color 0.2s ease;
            animation: slideInRow 0.3s ease-out;
        }

        @keyframes slideInRow {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .expense-rooms-table tbody tr:hover {
            background-color: var(--light-blue);
        }

        /* Responsive styles for expense rooms table on mobile */
        @media (max-width: 768px) {
            .expense-rooms-table {
                display: block;
                overflow: visible;
                border: none;
                background: transparent;
            }

            .expense-rooms-table thead {
                display: none;
            }

            .expense-rooms-table tbody {
                display: block;
            }

            .expense-rooms-table tbody tr {
                display: block;
                margin-bottom: 16px;
                border: 1px solid #e0e0e0;
                border-radius: 12px;
                padding: 16px;
                background: #ffffff;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
                transition: box-shadow 0.2s ease;
            }

            .expense-rooms-table tbody tr:active {
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
            }

            .expense-rooms-table tbody tr td {
                display: block;
                border: none;
                padding: 0;
                margin-bottom: 14px;
                text-align: right;
                position: relative;
            }

            .expense-rooms-table tbody tr td:last-child {
                margin-bottom: 0;
                margin-top: 8px;
            }

            .expense-rooms-table tbody tr td:before {
                content: attr(data-label);
                display: block;
                font-weight: 600;
                color: #333;
                font-size: 12px;
                margin-bottom: 6px;
                padding-right: 0;
                position: static;
            }

            .expense-rooms-table .form-control,
            .expense-rooms-table .form-select {
                width: 100%;
                font-size: 14px;
                padding: 10px 12px;
                border: 1px solid #ddd;
                border-radius: 8px;
                background: #f9f9f9;
                transition: all 0.2s ease;
            }

            .expense-rooms-table .form-control:focus,
            .expense-rooms-table .form-select:focus {
                background: #fff;
                border-color: var(--primary-blue);
                box-shadow: 0 0 0 3px rgba(0, 122, 204, 0.1);
                outline: none;
            }

            .expense-rooms-table .select2-container {
                width: 100% !important;
                min-width: 100%;
            }

            .expense-rooms-table .select2-container--default .select2-selection--single {
                height: 42px;
                border: 1px solid #ddd;
                border-radius: 8px;
                background: #f9f9f9;
            }

            .expense-rooms-table .select2-container--default .select2-selection--single .select2-selection__rendered {
                line-height: 42px;
                padding-right: 12px;
                font-size: 14px;
            }

            .expense-rooms-table .select2-container--default .select2-selection--single .select2-selection__arrow {
                height: 42px;
                right: 8px;
            }

            .expense-rooms-table .remove-room-btn {
                width: 100%;
                padding: 12px;
                font-size: 13px;
                font-weight: 600;
                border-radius: 8px;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 6px;
                margin-top: 4px;
            }

            .expense-rooms-table .remove-room-btn i {
                font-size: 14px;
            }
        }

        @media (max-width: 480px) {
            .expense-rooms-table tbody tr {
                padding: 12px;
                margin-bottom: 12px;
                border-radius: 10px;
            }

            .expense-rooms-table tbody tr td {
                margin-bottom: 12px;
            }

            .expense-rooms-table tbody tr td:before {
                font-size: 11px;
                margin-bottom: 5px;
            }

            .expense-rooms-table .form-control,
            .expense-rooms-table .form-select {
                font-size: 13px;
                padding: 9px 10px;
            }

            .expense-rooms-table .select2-container--default .select2-selection--single {
                height: 40px;
            }

            .expense-rooms-table .select2-container--default .select2-selection--single .select2-selection__rendered {
                line-height: 40px;
                font-size: 13px;
            }

            .expense-rooms-table .select2-container--default .select2-selection--single .select2-selection__arrow {
                height: 40px;
            }

            .expense-rooms-table .remove-room-btn {
                padding: 10px;
                font-size: 12px;
            }
        }

        .remove-room-btn {
            background: var(--danger-red);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .remove-room-btn:hover {
            background: #C82333;
        }

        /* Images Upload Section - Compact */
        .images-upload-section {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 2px solid var(--light-gray);
        }

        .images-upload-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .images-upload-header h3 {
            font-family: 'Cairo', sans-serif;
            font-size: 13px;
            font-weight: 600;
            color: var(--dark-gray);
            display: flex;
            align-items: center;
            gap: 6px;
            margin: 0;
        }

        .upload-area {
            border: 2px dashed var(--light-gray);
            border-radius: 6px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--gray-bg);
        }

        .upload-area:hover {
            border-color: var(--primary-blue);
            background: var(--light-blue);
        }

        .upload-area.dragover {
            border-color: var(--success-green);
            background: rgba(40, 167, 69, 0.1);
        }

        .upload-icon {
            font-size: 24px;
            color: var(--primary-blue);
            margin-bottom: 6px;
        }

        .upload-text {
            font-size: 12px;
            color: var(--dark-gray);
            margin-bottom: 3px;
        }

        .upload-hint {
            font-size: 10px;
            color: #666;
        }

        #imageFiles {
            display: none;
        }

        .images-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 8px;
            margin-top: 10px;
        }

        .image-preview-item {
            position: relative;
            border: 1px solid var(--light-gray);
            border-radius: 6px;
            overflow: hidden;
            aspect-ratio: 1;
        }

        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-preview-item .remove-image {
            position: absolute;
            top: 5px;
            left: 5px;
            background: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .image-preview-item .remove-image:hover {
            background: var(--danger-red);
            transform: scale(1.1);
        }

        /* Action Buttons - Compact */
        .action-buttons {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            padding-top: 10px;
            border-top: 2px solid var(--light-gray);
            justify-content: flex-end;
        }

        .btn-primary, .btn-secondary {
            font-family: 'Cairo', sans-serif;
            padding: 7px 18px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 13px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s ease;
            border: 1px solid transparent;
            cursor: pointer;
        }

        .btn-secondary {
            border: 1px solid var(--primary-blue);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--dark-blue) 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(0, 122, 204, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 122, 204, 0.4);
        }

        .btn-secondary {
            background: white;
            color: var(--primary-blue);
            border: 2px solid var(--primary-blue);
        }

        .btn-secondary:hover {
            background: var(--light-blue);
        }

        /* Loading Overlay */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .loading-overlay.show {
            display: flex;
        }

        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-rooms-message, .empty-images-message {
            text-align: center;
            padding: 12px;
            color: #666;
            font-size: 11px;
            background: var(--gray-bg);
            border-radius: 6px;
        }

        /* Compact Form Layout - Grid for better organization */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 8px;
        }

        .form-row.three-columns {
            grid-template-columns: 1fr 1fr 1fr;
        }

        .form-row.full-width {
            grid-template-columns: 1fr;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .hotel-selector {
                position: relative;
                top: 0;
                left: 0;
                margin-bottom: 10px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .add-expense-layout {
                flex-direction: column;
            }

            .action-buttons {
                flex-direction: column;
            }

            .images-preview {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            }
        }

        /* Tabs Navigation - Professional Business Style */
        .tabs-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
            margin-bottom: 10px;
            overflow: hidden;
            border: 1px solid #f0f0f0;
        }

        .tabs-nav {
            display: flex;
            background: #fafbfc;
            border-bottom: 1px solid #e5e7eb;
            padding: 0;
            margin: 0;
            list-style: none;
        }

        .tabs-nav li {
            flex: 1;
        }

        .tabs-nav button {
            width: 100%;
            padding: 10px 16px;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            font-family: 'Cairo', sans-serif;
            color: #6b7280;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            position: relative;
        }

        .tabs-nav button:hover {
            background: rgba(0, 122, 204, 0.04);
            color: var(--primary-blue);
        }

        .tabs-nav button.active {
            background: white;
            color: var(--primary-blue);
            border-bottom-color: var(--primary-blue);
            font-weight: 700;
        }

        .tabs-nav button.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary-blue);
        }

        .tabs-nav button i {
            font-size: 14px;
        }

        .tab-content {
            display: none;
            padding: 0;
        }

        .tab-content.active {
            display: block;
            animation: fadeInTab 0.3s ease-out;
        }

        @keyframes fadeInTab {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Expenses Filter and Export Section */
        .expenses-filter-section {
            margin-bottom: 20px;
            padding: 20px 24px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .filter-dates-row {
            display: flex;
            gap: 8px;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .filter-date-group {
            min-width: 120px;
            max-width: 140px;
        }

        .filter-date-group label {
            display: block;
            font-family: 'Cairo', sans-serif;
            font-size: 11px;
            font-weight: 600;
            color: var(--dark-gray);
            margin-bottom: 3px;
        }

        .filter-date-input {
            font-family: 'Cairo', sans-serif;
            font-size: 11px;
            padding: 5px 8px;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
            width: 100%;
        }

        .btn-filter {
            font-family: 'Cairo', sans-serif;
            padding: 6px 14px;
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--dark-blue) 100%);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0, 122, 204, 0.2);
            white-space: nowrap;
            height: 32px;
        }

        .btn-filter:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0, 122, 204, 0.3);
        }

        .btn-filter svg {
            width: 14px;
            height: 14px;
        }

        .btn-export {
            font-family: 'Cairo', sans-serif;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            white-space: nowrap;
            height: 32px;
        }

        .btn-export svg {
            width: 14px;
            height: 14px;
        }

        @media (max-width: 768px) {
            .filter-date-group {
                min-width: 100px;
                max-width: 120px;
            }
            .filter-date-input {
                font-size: 10px;
                padding: 4px 6px;
            }
            .btn-filter, .btn-export {
                padding: 5px 10px;
                font-size: 10px;
                height: 30px;
            }
        }

        .btn-export-pdf {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
        }

        .btn-export-pdf:hover {
            background: linear-gradient(135deg, #c82333 0%, #bd2130 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
        }

        .btn-export-excel {
            background: linear-gradient(135deg, #28a745 0%, #218838 100%);
            color: white;
        }

        .btn-export-excel:hover {
            background: linear-gradient(135deg, #218838 0%, #1e7e34 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
        }

        .btn-export-print {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
            color: white;
        }

        .btn-export-print:hover {
            background: linear-gradient(135deg, #5a6268 0%, #545b62 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(108, 117, 125, 0.3);
        }

        /* Modern Expenses Table - Awesome Design */
        .expenses-table-container {
            padding: 24px 28px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .expenses-table-wrapper {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            background: white;
        }

        .expenses-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: white;
            font-family: 'Cairo', sans-serif;
            font-size: 12px;
            min-width: 1400px;
        }

        @media (max-width: 1600px) {
            .expenses-table {
                min-width: 1200px;
            }
        }

        .expenses-table thead {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .expenses-table th {
            padding: 10px 12px;
            text-align: right;
            font-weight: 600;
            font-size: 12px;
            white-space: nowrap;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            cursor: pointer;
            user-select: none;
            font-family: 'Cairo', sans-serif;
        }

        .expenses-table th:last-child {
            border-right: none;
        }

        .expenses-table th:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .expenses-table th .sort-icon {
            display: inline-block;
            margin-right: 5px;
            opacity: 0.5;
            font-size: 9px;
            transition: all 0.2s;
            font-family: 'Cairo', sans-serif;
        }

        .expenses-table th:hover .sort-icon {
            opacity: 1;
        }

        .expenses-table tbody tr {
            border-bottom: 1px solid #e5e7eb;
            transition: all 0.2s ease;
            background: white;
        }

        .expenses-table tbody tr:hover {
            background-color: #f0f9ff;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
        }

        .expenses-table tbody tr:last-child {
            border-bottom: none;
        }

        .expenses-table td {
            padding: 10px 12px;
            text-align: right;
            vertical-align: middle;
            border-right: 1px solid #f3f4f6;
            color: #374151;
            font-family: 'Cairo', sans-serif;
            font-size: 12px;
        }

        .expenses-table td:last-child {
            border-right: none;
        }

        .expenses-table tbody tr:nth-child(even) {
            background-color: #f9fafb;
        }

        .expenses-table tbody tr:nth-child(even):hover {
            background-color: #f0f9ff;
        }

        /* Image Link Label Style - Professional */
        .image-link-label {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            background: transparent;
            color: #3b82f6;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            font-family: 'Cairo', sans-serif;
            text-decoration: underline;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .image-link-label:hover {
            color: #2563eb;
            text-decoration: underline;
        }

        .image-link-label svg {
            width: 12px;
            height: 12px;
        }

        /* Approval Status Badge - Modern & Advanced */
        .approval-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            border-radius: 18px;
            font-size: 11px;
            font-weight: 600;
            font-family: 'Cairo', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .approval-status-badge::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s ease;
        }

        .approval-status-badge:hover::before {
            left: 100%;
        }

        .approval-status-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .approval-status-badge svg {
            width: 10px;
            height: 10px;
            display: inline-block;
            vertical-align: middle;
            margin-left: 4px;
        }

        .approval-status-badge.clickable {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .approval-status-badge.clickable:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        /* User Profile Dropdown */
        .user-profile-dropdown {
            position: absolute;
            right: 60px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1001;
        }

        .user-name-display {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.15);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .user-name-display:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-1px);
        }

        .user-name-display i {
            font-size: 18px;
        }

        .user-name-text {
            font-size: 13px;
            font-weight: 600;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .user-dropdown-menu {
            position: fixed;
            top: 60px;
            right: 60px;
            width: 250px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            display: none;
            overflow: hidden;
            border: 1px solid #e5e7eb;
            animation: slideDown 0.3s ease-out;
        }

        .user-dropdown-menu.active {
            display: block;
        }

        .user-dropdown-header {
            padding: 15px;
            background: var(--primary-blue);
            color: white;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .user-dropdown-header .user-email {
            font-size: 11px;
            opacity: 0.9;
            margin-top: 4px;
        }

        .user-dropdown-item {
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.2s ease;
            border-bottom: 1px solid #f3f4f6;
        }

        .user-dropdown-item:last-child {
            border-bottom: none;
        }

        .user-dropdown-item:hover {
            background: #f9fafb;
        }

        .user-dropdown-item i {
            width: 20px;
            color: var(--primary-blue);
            font-size: 16px;
        }

        .user-dropdown-item.logout {
            color: var(--danger-red);
        }

        .user-dropdown-item.logout i {
            color: var(--danger-red);
        }

        /* Notification Badge */
        .notification-badge {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            display: inline-block;
            cursor: pointer;
            z-index: 1000;
        }

        .notification-icon {
            font-size: 24px;
            color: white;
            position: relative;
            transition: all 0.3s ease;
        }

        .notification-badge:hover .notification-icon {
            transform: scale(1.1);
        }

        .notification-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--danger-red);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            border: 2px solid white;
            transition: all 0.3s ease;
        }

        .notification-count.read {
            background: var(--success-green);
        }

        /* Notifications Dropdown */
        .notifications-dropdown {
            position: fixed;
            top: 70px;
            right: 15px;
            width: 350px;
            max-height: 500px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            display: none;
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }

        .notifications-dropdown.active {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        .notifications-header {
            padding: 15px;
            background: var(--primary-blue);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .notifications-header h4 {
            margin: 0;
            font-size: 14px;
            font-weight: 700;
        }

        .notifications-close {
            background: transparent;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: background 0.2s ease;
        }

        .notifications-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .notifications-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .notification-item {
            padding: 12px 15px;
            border-bottom: 1px solid #f3f4f6;
            cursor: pointer;
            transition: background 0.2s ease;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .notification-item:hover {
            background: #f9fafb;
        }

        .notification-item.read {
            background: #f9fafb;
            opacity: 0.7;
        }

        .notification-item-title {
            font-weight: 600;
            font-size: 13px;
            color: var(--dark-gray);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .notification-item-title i {
            color: var(--primary-blue);
        }

        .notification-item-content {
            font-size: 12px;
            color: #6b7280;
            line-height: 1.5;
        }

        .notification-item-date {
            font-size: 11px;
            color: #9ca3af;
            margin-top: 4px;
        }

        .notifications-empty {
            padding: 40px 20px;
            text-align: center;
            color: #9ca3af;
        }

        .notifications-empty i {
            font-size: 48px;
            margin-bottom: 10px;
            color: #d1d5db;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--dark-blue) 100%);
            color: white;
            border-radius: 12px 12px 0 0;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 20px;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }

        .btn-cancel {
            padding: 10px 20px;
            background: #f3f4f6;
            color: #374151;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-cancel:hover {
            background: #e5e7eb;
        }

        .btn-submit {
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--dark-blue) 100%);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-submit:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 122, 204, 0.3);
        }

        /* Spinner SVG Animation */
        .spinner-svg {
            animation: spin 1s linear infinite;
            color: var(--primary-blue);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Auto-Approved Status */
        .status-auto-approved {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            animation: pulse-green 2s infinite;
        }

        @keyframes pulse-green {
            0%, 100% {
                box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
            }
            50% {
                box-shadow: 0 2px 8px rgba(16, 185, 129, 0.5);
            }
        }

        /* Pending Status */
        .status-pending {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            animation: pulse-orange 2s infinite;
        }

        @keyframes pulse-orange {
            0%, 100% {
                box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);
            }
            50% {
                box-shadow: 0 2px 8px rgba(245, 158, 11, 0.5);
            }
        }

        .status-awaiting-manager {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
        }

        .status-awaiting-accountant {
            background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);
            color: white;
        }

        .status-awaiting-admin {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: white;
        }

        /* Accepted Status */
        .status-accepted {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        /* Rejected Status */
        .status-rejected {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        /* Action Buttons in Table - Awesome Design */
        .action-buttons-cell {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }

        .action-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.12);
            position: relative;
            overflow: hidden;
        }

        .action-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.4s, height 0.4s;
        }

        .action-btn:hover::before {
            width: 100px;
            height: 100px;
        }

        .action-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.25);
        }

        .action-btn:active {
            transform: translateY(-1px) scale(1.02);
        }

        .action-btn svg {
            position: relative;
            z-index: 1;
            width: 14px;
            height: 14px;
        }

        .action-btn-view {
            background: #f3f4f6;
            color: #6b7280;
            border: 1px solid #e5e7eb;
        }

        .action-btn-view:hover {
            background: #e5e7eb;
            color: var(--primary-blue);
        }

        .action-btn-edit {
            background: #f3f4f6;
            color: #6b7280;
            border: 1px solid #e5e7eb;
        }

        .action-btn-edit:hover {
            background: #e5e7eb;
            color: #4b5563;
        }

        .action-btn-images {
            background: #f3f4f6;
            color: #6b7280;
            border: 1px solid #e5e7eb;
        }

        .action-btn-images:hover {
            background: #e5e7eb;
            color: #4b5563;
        }

        .action-btn-delete {
            background: #f3f4f6;
            color: #6b7280;
            border: 1px solid #e5e7eb;
        }

        .action-btn-delete:hover {
            background: #e5e7eb;
            color: #4b5563;
        }

        .action-btn svg {
            stroke: #6b7280;
        }

        .action-btn:hover svg {
            stroke: #4b5563;
        }

        /* Expense Details Modal */
        .expense-details-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10001;
            padding: 20px;
            overflow-y: auto;
        }

        .expense-details-modal.active {
            display: block;
        }

        .expense-details-content {
            max-width: 900px;
            margin: 20px auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            position: relative;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .expense-details-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
        }

        .expense-details-header h3 {
            margin: 0;
            color: var(--dark-gray);
            font-size: 22px;
            font-weight: 700;
        }

        .expense-details-close {
            background: var(--danger-red);
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s ease;
        }

        .expense-details-close:hover {
            transform: rotate(90deg);
            background: #b91c1c;
        }

        .expense-details-section {
            margin-bottom: 25px;
        }

        .expense-details-section-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--primary-blue);
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e8f0fe;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .expense-details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .expense-detail-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .expense-detail-label {
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .expense-detail-value {
            font-size: 14px;
            color: var(--dark-gray);
            font-weight: 500;
        }

        .expense-rooms-list, .expense-images-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .expense-room-item, .expense-image-item {
            padding: 12px;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .expense-image-item img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .expense-image-item img:hover {
            transform: scale(1.05);
        }

        /* Empty State */
        .empty-expenses {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .empty-expenses i {
            font-size: 64px;
            color: #d1d5db;
            margin-bottom: 16px;
        }

        .empty-expenses h3 {
            font-size: 18px;
            margin-bottom: 8px;
            color: #374151;
        }

        .empty-expenses p {
            font-size: 14px;
            color: #6b7280;
        }

        /* Images Modal */
        .images-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            padding: 20px;
            overflow-y: auto;
        }

        .images-modal.active {
            display: block;
        }

        .images-modal-content {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 20px;
            position: relative;
        }

        .images-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
        }

        .images-modal-header h3 {
            margin: 0;
            color: var(--dark-gray);
            font-size: 20px;
        }

        .images-modal-close {
            background: var(--danger-red);
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s ease;
        }

        .images-modal-close:hover {
            transform: rotate(90deg);
            background: #b91c1c;
        }

        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .image-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            aspect-ratio: 1;
        }

        .image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .image-item img:hover {
            transform: scale(1.05);
        }

        .no-images-message {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        /* SweetAlert2 RTL Support */
        .swal2-rtl {
            direction: rtl;
            text-align: right;
        }

        .swal2-rtl .swal2-title {
            text-align: right;
        }

        .swal2-rtl .swal2-content {
            text-align: right;
        }

        .swal2-rtl .swal2-actions {
            flex-direction: row-reverse;
        }

        /* SAR Currency Symbol */
        .sar-symbol {
            display: inline-block;
            width: 14px;
            height: 14px;
            vertical-align: middle;
            margin-right: 3px;
            margin-left: 2px;
        }

        .sar-symbol svg {
            width: 100%;
            height: 100%;
            display: block;
        }

        .sar-symbol-large {
            width: 18px;
            height: 18px;
        }

        /* Pagination Styles */
        .expenses-pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding: 15px 0;
            border-top: 1px solid #e5e7eb;
            font-family: 'Cairo', sans-serif;
        }

        .pagination-info {
            font-size: 13px;
            color: #6b7280;
            font-weight: 500;
        }

        .pagination-controls {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .pagination-btn {
            min-width: 36px;
            height: 36px;
            padding: 0 12px;
            border: 1px solid #e5e7eb;
            background: white;
            color: #374151;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            font-family: 'Cairo', sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .pagination-btn:hover:not(:disabled) {
            background: #f3f4f6;
            border-color: #d1d5db;
            color: var(--primary-blue);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-btn.active {
            background: var(--primary-blue);
            color: white;
            border-color: var(--primary-blue);
        }

        .pagination-btn.active:hover {
            background: var(--dark-blue);
            border-color: var(--dark-blue);
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Page Header -->
        <div class="page-header">
            <button class="logout-btn" onclick="handleLogout()" title="تسجيل الخروج والعودة لصفحة تسجيل الدخول">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                    <polyline points="16 17 21 12 16 7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
            </button>
            <div class="page-header-content">
                <h1>
                    <i class="fas fa-file-invoice-dollar"></i>
                    <span id="hotelNameTitle">إدارة المصروفات</span>
                </h1>
            </div>
            <div class="user-profile-dropdown">
                <div class="user-name-display" onclick="toggleUserDropdown(event)" title="الملف الشخصي">
                    <i class="fas fa-user-circle"></i>
                    <span class="user-name-text" id="userFullName">المستخدم</span>
                    <i class="fas fa-chevron-down" style="font-size: 11px;"></i>
                </div>
                <div class="user-dropdown-menu" id="userDropdownMenu" onclick="event.stopPropagation()">
                    <div class="user-dropdown-header">
                        <div id="dropdownUserName">المستخدم</div>
                        <div class="user-email" id="dropdownUserEmail">-</div>
                        <div class="user-employee-number" id="dropdownEmployeeNumber" style="font-size: 11px; opacity: 0.9; margin-top: 4px; display: none;"></div>
                    </div>
                    <div class="user-dropdown-item" onclick="openProfileModal()">
                        <i class="fas fa-user"></i>
                        <span>الملف الشخصي</span>
                    </div>
                    <div class="user-dropdown-item" onclick="openChangePasswordModal()">
                        <i class="fas fa-key"></i>
                        <span>تغيير كلمة المرور</span>
                    </div>
                    <div class="user-dropdown-item logout" onclick="handleLogout()">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>تسجيل الخروج</span>
                    </div>
                </div>
            </div>
            <div class="notification-badge" onclick="toggleNotifications()" title="الإشعارات">
                <i class="fas fa-bell notification-icon"></i>
                <span class="notification-count" id="notificationCount">0</span>
                <!-- Notifications Dropdown -->
                <div class="notifications-dropdown" id="notificationsDropdown" onclick="event.stopPropagation()">
                    <div class="notifications-header">
                        <h4><i class="fas fa-bell"></i> الإشعارات</h4>
                        <button class="notifications-close" onclick="closeNotifications(event)">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="notifications-list" id="notificationsList">
                        <!-- Notifications will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Session Timeout Warning -->
        <div id="sessionWarning" class="session-warning">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
            <div>
                <strong>تحذير: انتهت الجلسة</strong>
                <div style="font-size: 12px; margin-top: 3px;">سيتم توجيهك إلى صفحة تسجيل الدخول...</div>
            </div>
        </div>

        <!-- Profile Modal -->
        <div id="profileModal" class="modal-overlay" style="display: none;">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h3><i class="fas fa-user"></i> الملف الشخصي</h3>
                    <button class="modal-close" onclick="closeProfileModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="profileForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label>اسم المستخدم</label>
                                <input type="text" id="profileUsername" class="form-control" readonly>
                            </div>
                            <div class="form-group">
                                <label>الاسم الكامل</label>
                                <input type="text" id="profileFullName" class="form-control">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>البريد الإلكتروني</label>
                                <input type="email" id="profileEmail" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>رقم الجوال</label>
                                <input type="text" id="profilePhoneNumber" class="form-control" placeholder="966XXXXXXXXX">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>الرقم الوظيفي</label>
                                <input type="text" id="profileEmployeeNumber" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>الفندق</label>
                                <input type="text" id="profileTenantName" class="form-control" readonly>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn-cancel" onclick="closeProfileModal()">إلغاء</button>
                            <button type="submit" class="btn-submit">حفظ التغييرات</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Change Password Modal -->
        <div id="changePasswordModal" class="modal-overlay" style="display: none;">
            <div class="modal-content" style="max-width: 500px;">
                <div class="modal-header">
                    <h3><i class="fas fa-key"></i> تغيير كلمة المرور</h3>
                    <button class="modal-close" onclick="closeChangePasswordModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="changePasswordForm">
                        <div class="form-group">
                            <label>كلمة المرور الحالية <span style="color: red;">*</span></label>
                            <input type="password" id="currentPassword" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>كلمة المرور الجديدة <span style="color: red;">*</span></label>
                            <input type="password" id="newPassword" class="form-control" required minlength="6">
                        </div>
                        <div class="form-group">
                            <label>تأكيد كلمة المرور الجديدة <span style="color: red;">*</span></label>
                            <input type="password" id="confirmPassword" class="form-control" required minlength="6">
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn-cancel" onclick="closeChangePasswordModal()">إلغاء</button>
                            <button type="submit" class="btn-submit">تغيير كلمة المرور</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Tabs Navigation -->
        <div class="tabs-container">
            <ul class="tabs-nav">
                <li>
                    <button class="tab-btn active" data-tab="add-expense">
                        <i class="fas fa-plus-circle"></i>
                        إضافة مصروف جديد
                    </button>
                </li>
                <li>
                    <button class="tab-btn" data-tab="all-expenses">
                        <i class="fas fa-list"></i>
                        جميع المصروفات
                    </button>
                </li>
            </ul>
        </div>

        <!-- Tab Content: Add Expense -->
        <div class="tab-content active" id="add-expense-tab">
            <!-- Expense Form -->
            <div class="form-card add-expense-layout">
            <div class="add-expense-form">
                <div class="section-title">
                    <i class="fas fa-plus-circle"></i>
                    إضافة مصروف جديد
                </div>

                <form id="expenseForm">
                <!-- First Row: Date, Due Date and Category -->
                <div class="form-row three-columns">
                    <div class="form-group required">
                        <label>تاريخ المصروف:</label>
                        <input type="text" id="expenseDate" class="form-control" placeholder="اختر التاريخ الميلادي" disabled />
                    </div>

                    <div class="form-group">
                        <label>تاريخ الاستحقاق:</label>
                        <input type="text" id="dueDate" class="form-control" placeholder=" تاريخ الاستحقاق" />
                    </div>

                    <div class="form-group required">
                        <label>فئة المصروف:</label>
                        <select id="expenseCategorySelect" class="form-select" required>
                            <option value="">اختر فئة المصروف...</option>
                        </select>
                    </div>
                </div>

                <!-- Second Row: Total Amount and Tax -->
                <div class="form-row">
                    <div class="form-group required">
                        <label>
                            المبلغ الإجمالي:
                            <input type="checkbox" id="includeTaxCheckbox" class="tax-checkbox" />
                            <span class="tax-checkbox-label">يتضمن ضريبة</span>
                        </label>
                        <input type="number" id="totalAmount" class="form-control" placeholder="0.00" min="0" step="0.01" required />
                    </div>
                    <div class="form-group" id="taxInputGroup" style="display: none;">
                        <label>قيمة الضريبة:</label>
                        <input type="number" id="taxAmount" class="form-control" placeholder="0.00" min="0" step="0.01" />
                        <small class="tax-info" id="taxInfo" style="display: none; color: #666; font-size: 11px; margin-top: 4px;"></small>
                    </div>
                </div>

                <!-- Comment - Full Width -->
                <div class="form-group">
                    <label>الملاحظات:</label>
                    <textarea id="expenseComment" class="form-control" rows="2" placeholder="أدخل الملاحظات..."></textarea>
                </div>

                <!-- Images Upload Section -->
                <div class="images-upload-section">
                    <div class="images-upload-header">
                        <h3>
                            <i class="fas fa-images"></i>
                            صور المصروف
                        </h3>
                    </div>
                    <div class="upload-area" id="uploadArea">
                        <i class="fas fa-cloud-upload-alt upload-icon"></i>
                        <div class="upload-text">اضغط لاختيار الصور أو اسحبها هنا</div>
                        <div class="upload-hint">يمكنك رفع صور متعددة (JPG, PNG, GIF) - حد أقصى 1 ميجا</div>
                    </div>
                    <input type="file" id="imageFiles" multiple accept="image/*" />
                    <div class="images-preview" id="imagesPreview"></div>
                    <div id="emptyImagesMessage" class="empty-images-message" style="display: none; margin-top: 10px;">
                        لا توجد صور مرفوعة
                    </div>
                </div>

                <!-- Expense Rooms Section (like الهوية) -->
                <div class="expense-rooms-section">
                    <div class="expense-rooms-header">
                        <h3>
                            <i class="fas fa-map-marker-alt"></i>
                            المواقع المرتبطة بالمصروف
                        </h3>
                        <button type="button" class="add-room-btn" onclick="addExpenseRoomRow()">
                            <i class="fas fa-plus"></i>
                            إضافة موقع
                        </button>
                    </div>

                    <table class="expense-rooms-table" id="expenseRoomsTable" style="display: none;">
                        <thead>
                            <tr>
                                <th>الموقع</th>
                                <th>الغرض من المصروف</th>
                                <th>المبلغ</th>
                                <th>إزالة</th>
                            </tr>
                        </thead>
                        <tbody id="expenseRoomsBody">
                            <!-- Rows will be added dynamically -->
                        </tbody>
                    </table>

                    <div id="emptyRoomsMessage" class="empty-rooms-message" style="display: none;">
                        <i class="fas fa-info-circle" style="font-size: 20px; margin-bottom: 5px; display: block;"></i>
                        لا توجد مواقع مضافة. اضغط على "إضافة موقع" لإضافة موقع جديد.
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button type="button" class="btn-secondary" onclick="resetForm()">
                        <i class="fas fa-redo"></i>
                        إعادة ضبط
                    </button>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-paper-plane"></i>
                        إرسال المصروف
                    </button>
                </div>
                </form>
            </div>
            <div class="add-expense-visual">
                <div class="add-expense-visual-content">
                    <div class="add-expense-visual-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 1v22M5 6h14a2 2 0 0 1 2 2v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4V8a2 2 0 0 1 2-2z"></path>
                        </svg>
                    </div>
                    <h3>لوحة تحكم للمصروفات</h3>
                    <p>تابع مصروفات الفنادق لحظياً مع رؤية واضحة للضرائب والغرف المرتبطة بكل عملية.</p>
                    <ul class="add-expense-visual-list">
                        <li>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                            تتبع دقيق لحالات الاعتماد
                        </li>
                        <li>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                            ربط المصروفات بالغرف بسهولة
                        </li>
                        <li>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                            رفع المستندات والصور فوراً
                        </li>
                    </ul>
                    <div class="add-expense-visual-stats">
                        <div class="visual-stat-card" id="statMonthlyExpenses">
                            <span>المصروفات الشهرية</span>
                            <strong>0.00 <span class="sar-symbol"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1124.14 1256.39"><path fill="#231f20" d="M699.62,1113.02h0c-20.06,44.48-33.32,92.75-38.4,143.37l424.51-90.24c20.06-44.47,33.31-92.75,38.4-143.37l-424.51,90.24Z"/><path fill="#231f20" d="M1085.73,895.8c20.06-44.47,33.32-92.75,38.4-143.37l-330.68,70.33v-135.2l292.27-62.11c20.06-44.47,33.32-92.75,38.4-143.37l-330.68,70.27V66.13c-50.67,28.45-95.67,66.32-132.25,110.99v403.35l-132.25,28.11V0c-50.67,28.44-95.67,66.32-132.25,110.99v525.69l-295.91,62.88c-20.06,44.47-33.33,92.75-38.42,143.37l334.33-71.05v170.26l-358.3,76.14c-20.06,44.47-33.32,92.75-38.4,143.37l375.04-79.7c30.53-6.35,56.77-24.4,73.83-49.24l68.78-101.97v-.02c7.14-10.55,11.3-23.27,11.3-36.97v-149.98l132.25-28.11v270.4l424.53-90.28Z"/></svg></span></strong>
                        </div>
                        <div class="visual-stat-card" id="statPendingExpenses">
                            <span>طلبات الموافقة</span>
                            <strong>0 معلّقة</strong>
                        </div>
                        <div class="visual-stat-card" id="statRejectedExpenses">
                            <span>المصروفات المرفوضة</span>
                            <strong>0 مرفوضة</strong>
                        </div>
                    </div>
                    <div class="add-expense-visual-footer">
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 3h18v4H3z"></path>
                            <path d="M8 7v14"></path>
                            <path d="M16 7v14"></path>
                        </svg>
                        ادخل البيانات وثق المستندات ليتم اعتمادها بسرعة.
                    </div>
                </div>
            </div>
            </div>
        </div>

        <!-- Tab Content: All Expenses -->
        <div class="tab-content" id="all-expenses-tab">
            <div class="form-card">
                <div class="section-title">
                    <i class="fas fa-list"></i>
                    جميع المصروفات
                </div>
                
                <!-- Filter and Export Section -->
                <div class="expenses-filter-section">
                    <div class="filter-dates-row">
                        <div class="filter-date-group">
                            <label>من:</label>
                            <input type="text" id="filterDateFrom" class="form-control filter-date-input" placeholder="اختر التاريخ" />
                        </div>
                        <div class="filter-date-group">
                            <label>إلى:</label>
                            <input type="text" id="filterDateTo" class="form-control filter-date-input" placeholder="اختر التاريخ" />
                        </div>
                        <button type="button" class="btn-filter" onclick="applyDateFilter()" title="تصفية النتائج">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                            </svg>
                            تصفية
                        </button>
                        <button type="button" class="btn-export btn-export-pdf" onclick="exportToPDF()" title="تصدير إلى PDF">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                            </svg>
                            PDF
                        </button>
                        <button type="button" class="btn-export btn-export-excel" onclick="exportToExcel()" title="تصدير إلى Excel">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                            </svg>
                            Excel
                        </button>
                        <button type="button" class="btn-export btn-export-print" onclick="printExpenses()" title="طباعة">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="6 9 6 2 18 2 18 9"></polyline>
                                <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
                                <rect x="6" y="14" width="12" height="8"></rect>
                            </svg>
                            طباعة
                        </button>
                    </div>
                </div>
                
                <div class="expenses-table-container">
                    <div class="expenses-table-wrapper">
                        <table class="expenses-table" id="expensesTable">
                            <thead>
                                <tr>
                                    <th>
                                        <span class="sort-icon">⇅</span>
                                        رقم المصروف
                                    </th>
                                    <th>
                                        <span class="sort-icon">⇅</span>
                                        التاريخ
                                    </th>
                                    <th>
                                        <span class="sort-icon">⇅</span>
                                        تاريخ الاستحقاق
                                    </th>
                                    <th>
                                        <span class="sort-icon">⇅</span>
                                        فئة المصروف
                                    </th>
                                    <th>
                                        <span class="sort-icon">⇅</span>
                                        المبلغ الإجمالي
                                    </th>
                                    <th>
                                        <span class="sort-icon">⇅</span>
                                        حالة الموافقة
                                    </th>
                                    <th>الملاحظات</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="expensesTableBody">
                                <tr>
                                    <td colspan="7" class="empty-expenses">
                                        <i class="fas fa-spinner fa-spin"></i>
                                        <p>جاري التحميل...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    <div class="expenses-pagination" id="expensesPagination" style="display: none;">
                        <div class="pagination-info">
                            <span id="paginationInfo">عرض 0 إلى 0 من 0 نتيجة</span>
                        </div>
                        <div class="pagination-controls" id="paginationControls">
                            <!-- Pagination buttons will be added dynamically -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Images Modal -->
    <div class="images-modal" id="imagesModal">
        <div class="images-modal-content">
            <div class="images-modal-header">
                <h3><i class="fas fa-images"></i> صور المصروف</h3>
                <button class="images-modal-close" onclick="closeImagesModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="images-grid" id="imagesGrid">
                <!-- Images will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Expense Details Modal -->
    <div class="expense-details-modal" id="expenseDetailsModal">
        <div class="expense-details-content">
            <div class="expense-details-header">
                <h3><i class="fas fa-file-invoice"></i> تفاصيل المصروف</h3>
                <button class="expense-details-close" onclick="closeExpenseDetailsModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="expenseDetailsContent">
                <!-- Expense details will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Category Details Modal -->
    <div class="images-modal" id="categoryDetailsModal">
        <div class="images-modal-content" style="max-width: 600px;">
            <div class="images-modal-header">
                <h3><i class="fas fa-info-circle"></i> التفصيل</h3>
                <button class="images-modal-close" onclick="closeCategoryDetailsModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div style="padding: 20px;">
                <h4 id="categoryDetailsTitle" style="margin-bottom: 15px; color: var(--primary-blue); font-family: 'Cairo', sans-serif;"></h4>
                <p id="categoryDetailsText" style="line-height: 1.8; color: var(--dark-gray); font-family: 'Cairo', sans-serif; font-size: 14px; white-space: pre-wrap;"></p>
            </div>
            <div style="padding: 15px 20px; border-top: 1px solid var(--light-gray); text-align: left;">
                <button class="btn-primary" onclick="closeCategoryDetailsModal()" style="padding: 8px 20px;">
                    <i class="fas fa-check"></i> موافق
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize Select2 for RTL
        if (typeof $.fn.select2 !== 'undefined') {
            $.fn.select2.defaults.set('dir', 'rtl');
            $.fn.select2.defaults.set('language', {
                noResults: function() {
                    return "لا توجد نتائج";
                },
                searching: function() {
                    return "جاري البحث...";
                }
            });
        }
    </script>
    <script>
        const API_BASE_URL = window.location.origin;
        let availableHotels = [];
        let currentHotelCode = null;
        let currentHotelName = null;
        let apartments = [];
        let expenseCategories = [];
        let roomCategories = []; // ✅ فئات الغرف (Room Categories) من API
        const HIDDEN_EXPENSE_CATEGORY_CODES = new Set(['CAT_BUILDING', 'CAT_RECEPTION', 'CAT_CORRIDORS']);
        let expenseRoomRowCounter = 0;
        let selectedImages = [];
        let taxRate = 0; // Store tax rate from API

        // Wait for jQuery calendars to load
        function waitForCalendars(callback, maxAttempts = 100) {
            console.log('⏳ [waitForCalendars] Waiting for jQuery calendars to load...');
            let attempts = 0;
            const checkCalendars = setInterval(function() {
                attempts++;
                
                // Detailed checks
                const jqueryLoaded = typeof $ !== 'undefined' || typeof jQuery !== 'undefined';
                const calendarsLoaded = typeof $.calendars !== 'undefined';
                const instanceLoaded = typeof $.calendars !== 'undefined' && typeof $.calendars.instance !== 'undefined';
                const pickerLoaded = typeof $.fn !== 'undefined' && typeof $.fn.calendarsPicker !== 'undefined';
                
                if (attempts % 20 === 0) {
                    console.log(`⏳ [waitForCalendars] Attempt ${attempts}/${maxAttempts}: jQuery=${jqueryLoaded}, Calendars=${calendarsLoaded}, Instance=${instanceLoaded}, Picker=${pickerLoaded}`);
                }
                
                if (jqueryLoaded && calendarsLoaded && instanceLoaded && pickerLoaded) {
                    clearInterval(checkCalendars);
                    console.log(`✅ [waitForCalendars] jQuery calendars loaded successfully after ${attempts} attempts`);
                    // Wait a bit more to ensure everything is ready
                    setTimeout(callback, 100);
                } else if (attempts >= maxAttempts) {
                    clearInterval(checkCalendars);
                    console.error(`❌ [waitForCalendars] Failed to load after ${maxAttempts} attempts`);
                    console.error(`❌ [waitForCalendars] Final status: jQuery=${jqueryLoaded}, Calendars=${calendarsLoaded}, Instance=${instanceLoaded}, Picker=${pickerLoaded}`);
                    // Try to initialize anyway if jQuery is loaded
                    if (jqueryLoaded) {
                        console.warn('⚠️ [waitForCalendars] Attempting to initialize calendar anyway...');
                        setTimeout(callback, 200);
                    } else {
                        showNotification('⚠️ تعذر تحميل التقويم، يرجى إعادة تحميل الصفحة', 'warning');
                    }
                }
            }, 50);
        }

        // ==================== Session Management ====================
        const SESSION_TIMEOUT = 10 * 60 * 1000; // 10 minutes in milliseconds
        let sessionTimer = null;
        let sessionWarningTimer = null;

        // Check if user came from login page
        function checkSessionAccess() {
            const fromLogin = sessionStorage.getItem('fromLogin');
            const sessionValid = localStorage.getItem('sessionValid');
            const authToken = localStorage.getItem('authToken');
            
            // ✅ Priority 1: Check if user has valid auth token (most important)
            if (!authToken) {
                console.warn('⚠️ No auth token - redirecting to login');
                showNotification('⚠️ يجب تسجيل الدخول أولاً', 'warning');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 1500);
                return false;
            }
            
            // ✅ Priority 2: If user has authToken but no sessionValid flag, set it now
            // This handles the case where user logged in but sessionValid wasn't set properly
            if (authToken && sessionValid !== 'true') {
                console.log('✅ Auth token found but sessionValid missing - setting it now');
                localStorage.setItem('sessionValid', 'true');
                // Also set session start time if missing
                if (!localStorage.getItem('sessionStartTime')) {
                    localStorage.setItem('sessionStartTime', Date.now().toString());
                }
            }
            
            // ✅ Priority 3: Check for direct URL access (only if no fromLogin flag)
            // But allow if user has valid token (they might have refreshed the page)
            if (!fromLogin && !authToken) {
                console.warn('⚠️ Direct access denied - redirecting to login');
                showNotification('⚠️ يجب تسجيل الدخول أولاً', 'warning');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 1500);
                return false;
            }
            
            // Clear the fromLogin flag after checking (if it exists)
            if (fromLogin) {
                sessionStorage.removeItem('fromLogin');
            }
            
            console.log('✅ Session access granted - authToken exists');
            
            // Load user info and display name
            loadUserInfo();
            return true;
        }

        // Start session timer
        function startSessionTimer() {
            // Clear existing timers
            if (sessionTimer) clearTimeout(sessionTimer);
            if (sessionWarningTimer) clearTimeout(sessionWarningTimer);
            
            const sessionStartTime = parseInt(localStorage.getItem('sessionStartTime') || '0');
            const now = Date.now();
            const elapsed = now - sessionStartTime;
            const remaining = SESSION_TIMEOUT - elapsed;
            
            // If session already expired
            if (remaining <= 0) {
                handleSessionTimeout();
                return;
            }
            
            // Show warning 1 minute before timeout
            const warningTime = remaining - 60000; // 1 minute before timeout
            if (warningTime > 0) {
                sessionWarningTimer = setTimeout(() => {
                    showSessionWarning();
                }, warningTime);
            }
            
            // Set timeout for session expiration
            sessionTimer = setTimeout(() => {
                handleSessionTimeout();
            }, remaining);
            
            console.log(`✅ Session timer started. Timeout in ${Math.round(remaining / 1000)} seconds`);
        }

        // Show session warning
        function showSessionWarning() {
            const warning = document.getElementById('sessionWarning');
            if (warning) {
                warning.classList.add('show');
            }
        }

        // Handle session timeout
        function handleSessionTimeout() {
            console.warn('⏰ Session expired - redirecting to login');
            
            // Clear session data
            localStorage.removeItem('sessionStartTime');
            localStorage.removeItem('sessionValid');
            localStorage.removeItem('authToken');
            localStorage.removeItem('userInfo');
            sessionStorage.clear();
            
            // Show warning if not already shown
            const warning = document.getElementById('sessionWarning');
            if (warning) {
                warning.classList.add('show');
                warning.querySelector('div').innerHTML = '<strong>انتهت الجلسة</strong><div style="font-size: 12px; margin-top: 3px;">سيتم توجيهك إلى صفحة تسجيل الدخول...</div>';
            }
            
            // Redirect after short delay
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 2000);
        }

        // Reset session timer on user activity
        function resetSessionTimer() {
            localStorage.setItem('sessionStartTime', Date.now().toString());
            startSessionTimer();
        }

        // Logout handler
        async function handleLogout() {
            const result = await Swal.fire({
                title: 'هل أنت متأكد؟',
                text: 'هل أنت متأكد من تسجيل الخروج؟',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'نعم، سجل الخروج',
                cancelButtonText: 'إلغاء',
                reverseButtons: true,
                customClass: {
                    popup: 'swal2-rtl'
                }
            });
            
            if (result.isConfirmed) {
                // Clear all session data
                localStorage.removeItem('sessionStartTime');
                localStorage.removeItem('sessionValid');
                localStorage.removeItem('authToken');
                localStorage.removeItem('userInfo');
                sessionStorage.clear();
                
                // Clear timers
                if (sessionTimer) clearTimeout(sessionTimer);
                if (sessionWarningTimer) clearTimeout(sessionWarningTimer);
                
                // Redirect to login
                window.location.href = 'login.html';
            }
        }

        // Monitor user activity to reset session timer
        let activityEvents = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
        activityEvents.forEach(event => {
            document.addEventListener(event, resetSessionTimer, { passive: true });
        });

        // Initialize on page load
        $(document).ready(function() {
            console.log('🚀 Expenses page loaded - Starting initialization...');
            
            // ✅ Check session access first
            if (!checkSessionAccess()) {
                return; // Stop initialization if access denied
            }
            
            // Start session timer
            startSessionTimer();
            
            // Wait a bit for all scripts to load
            setTimeout(function() {
                // Hotel selector removed - hotel is auto-selected
                initializeImagesUpload();
                
                // Wait for calendars to load, then initialize form controls
                waitForCalendars(function() {
                    initializeFormControls();
                });
            }, 100);
            
            // ✅ استخدام tenantCode من userInfo فقط (مثل ZAAER) - بدون URL parameter
            const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
            const authToken = localStorage.getItem('authToken');
            
            // ✅ التحقق من وجود Token و userInfo
            if (!authToken || !userInfo.tenantCode) {
                console.error('❌ Missing authentication. Redirecting to login...');
                showNotification('⚠️ يرجى تسجيل الدخول أولاً', 'error');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
                return;
            }
            
            // ✅ استخدام tenantCode من userInfo فقط (من JWT Token)
            console.log(`✅ Hotel from user info (JWT Token): ${userInfo.tenantCode}`);
            currentHotelCode = userInfo.tenantCode;
            
            // ✅ إزالة ?hotel=... من URL إذا كان موجوداً (للمنطق القديم)
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('hotel')) {
                const newUrl = window.location.pathname;
                window.history.replaceState({}, '', newUrl);
                console.log('✅ Removed hotel parameter from URL');
            }
            
            // ✅ إزالة selectedHotelCode من localStorage (لا نحتاجه)
            localStorage.removeItem('selectedHotelCode');
            
            // ✅ تحميل البيانات
            loadHotels();
            
            // ✅ Removed automatic default row - users will add rows manually via "Add Room" button
            
            // ✅ Load and update visual stats on page load
            setTimeout(() => {
                updateVisualStats();
            }, 2000);
        });

        // Update Hotel Name in Header
        function updateHotelNameInHeader() {
            const hotelNameTitle = document.getElementById('hotelNameTitle');
            if (hotelNameTitle && currentHotelName) {
                hotelNameTitle.textContent = currentHotelName;
            }
        }

        // Load Hotels
        async function loadHotels() {
            try {
                showLoading();
                
                // ✅ إضافة Authorization header مع JWT Token
                const authToken = localStorage.getItem('authToken');
                if (!authToken) {
                    console.error('❌ [loadHotels] No auth token found');
                    showNotification('⚠️ يجب تسجيل الدخول أولاً', 'warning');
                    return;
                }
                
                const headers = {
                    'Authorization': `Bearer ${authToken}`,
                    'Accept': 'application/json'
                };
                
                const response = await fetch(`${API_BASE_URL}/api/tenant/hotels`, {
                    headers: headers
                });
                
                if (response.ok) {
                    availableHotels = await response.json();
                    
                    // ✅ التحقق من عدد الفنادق المتاحة
                    if (!availableHotels || availableHotels.length === 0) {
                        console.warn('⚠️ [loadHotels] No hotels available for this user');
                        showNotification('⚠️ لا توجد فنادق متاحة لك', 'warning');
                        return;
                    }
                    
                    // ✅ إذا كان المستخدم لديه فندق واحد فقط
                    if (availableHotels.length === 1) {
                        const singleHotel = availableHotels[0];
                        currentHotelCode = singleHotel.code;
                        currentHotelName = singleHotel.name;
                        console.log(`✅ [loadHotels] User has single hotel: ${singleHotel.code} - ${singleHotel.name}`);
                        // Update header with hotel name
                        updateHotelNameInHeader();
                        // Load apartments, categories, and tax rate
                        loadApartments();
                        loadExpenseCategories();
                        loadTaxRate();
                    } else if (availableHotels.length > 1) {
                        // If multiple hotels, use the first one or the one matching tenantCode
                        const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
                        const selectedHotel = availableHotels.find(h => h.code === userInfo.tenantCode) || availableHotels[0];
                        currentHotelCode = selectedHotel.code;
                        currentHotelName = selectedHotel.name;
                        console.log(`✅ [loadHotels] User has multiple hotels - using: ${selectedHotel.code} - ${selectedHotel.name}`);
                        // Update header with hotel name
                        updateHotelNameInHeader();
                        // Load apartments, categories, and tax rate
                        loadApartments();
                        loadExpenseCategories();
                        loadTaxRate();
                    }
                } else if (response.status === 401) {
                    console.error('❌ [loadHotels] Unauthorized - invalid or missing token');
                    showNotification('⚠️ يجب تسجيل الدخول أولاً', 'warning');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 1500);
                } else {
                    const errorText = await response.text();
                    console.error('❌ [loadHotels] Error loading hotels:', response.status, errorText);
                    showNotification('❌ خطأ في تحميل الفنادق', 'error');
                }
            } catch (error) {
                console.error('❌ [loadHotels] Exception:', error);
                showNotification('❌ خطأ في الاتصال بالخادم', 'error');
            } finally {
                hideLoading();
            }
        }

        // Load Apartments
        async function loadApartments() {
            if (!currentHotelCode) {
                console.warn('⚠️ [loadApartments] No hotel code selected, skipping...');
                return;
            }

            console.log(`📋 [loadApartments] Starting to load apartments for hotel: ${currentHotelCode}`);
            const startTime = performance.now();

            try {
                showLoading();
                
                // ✅ الحصول على tenantCode من userInfo (من JWT Token)
                const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
                const authToken = localStorage.getItem('authToken');
                
                if (!currentHotelCode || !authToken) {
                    showNotification('⚠️ يرجى تسجيل الدخول أولاً', 'warning');
                    return;
                }
                
                // ✅ SECURITY: التأكد من أن currentHotelCode يطابق tenantCode من JWT Token
                if (currentHotelCode !== userInfo.tenantCode) {
                    console.error(`⚠️ SECURITY: Hotel code mismatch. Current: ${currentHotelCode}, Expected: ${userInfo.tenantCode}`);
                    showNotification('⚠️ خطأ في الأمان: لا يمكنك الوصول إلى هذا الفندق', 'error');
                    return;
                }
                
                // Use lightweight lookup endpoint (limited fields for performance)
                const url = `${API_BASE_URL}/api/Apartment/lookup`;
                const requestHeaders = {
                    'Authorization': `Bearer ${authToken}`, // ✅ إضافة JWT Token
                    'X-Hotel-Code': currentHotelCode,
                    'Accept': 'application/json'
                };
                
                console.log(`📤 [loadApartments] ===== REQUEST PAYLOAD =====`);
                console.log(`📤 [loadApartments] URL: ${url}`);
                console.log(`📤 [loadApartments] Method: GET`);
                console.log(`📤 [loadApartments] Headers:`, JSON.stringify(requestHeaders, null, 2));
                console.log(`📤 [loadApartments] Current Hotel Code: ${currentHotelCode}`);
                console.log(`📤 [loadApartments] User Info:`, JSON.stringify(userInfo, null, 2));

                const response = await fetch(url, {
                    headers: requestHeaders
                });

                const endTime = performance.now();
                const duration = (endTime - startTime).toFixed(2);

                console.log(`📥 [loadApartments] ===== RESPONSE =====`);
                console.log(`📥 [loadApartments] Status: ${response.status} ${response.statusText}`);
                console.log(`📥 [loadApartments] Duration: ${duration}ms`);
                console.log(`📥 [loadApartments] Response Headers:`, [...response.headers.entries()]);

                if (response.ok) {
                    const data = await response.json();
                    console.log(`📦 [loadApartments] ===== RESPONSE PAYLOAD =====`);
                    console.log('📦 [loadApartments] Response type:', typeof data);
                    console.log('📦 [loadApartments] Is array?', Array.isArray(data));

                    if (Array.isArray(data)) {
                        apartments = data;
                        console.log(`✅ [loadApartments] Successfully loaded ${apartments.length} apartments via lookup endpoint`);

                        // ✅ Handle paginated response - use 'apartments' (lowercase) from updated controller
                    } else if (data.apartments && Array.isArray(data.apartments)) {
                        apartments = data.apartments;
                        console.log(`✅ [loadApartments] Successfully loaded ${apartments.length} apartments (legacy paged endpoint)`);
                        
                        // Update apartment dropdowns in existing rows
                        $('#expenseRoomsBody tr').each(function() {
                            const rowId = $(this).data('row-id');
                            const apartmentSelect = $(`.apartment-select[data-row-id="${rowId}"]`);
                            const currentZaaerId = apartmentSelect.val();
                            
                            // Get already selected room IDs from other rows (exclude current row)
                            const selectedRoomIds = new Set();
                            $('#expenseRoomsBody tr').each(function() {
                                const existingRowId = $(this).data('row-id');
                                if (existingRowId && existingRowId !== rowId) {
                                    const selectedValue = $(`.apartment-select[data-row-id="${existingRowId}"]`).val();
                                    if (selectedValue && selectedValue !== '' && !selectedValue.startsWith('CAT_')) {
                                        selectedRoomIds.add(selectedValue);
                                    }
                                }
                            });
                            
                            // Destroy Select2 if already initialized
                            if (apartmentSelect.hasClass('select2-hidden-accessible')) {
                                apartmentSelect.select2('destroy');
                            }
                            
                            apartmentSelect.empty().append('<option value="">اختر الغرفة...</option>');
                            
                            // ✅ Add room categories first (from API or fallback)
                            const categoryOptions = getRoomCategories();
                            categoryOptions.forEach(cat => {
                                apartmentSelect.append(`<option value="${cat.value}">${cat.text}</option>`);
                            });
                            
                            // Then add rooms (exclude already selected ones)
                            apartments.forEach(apt => {
                                // ✅ Use zaaerId as value and apartmentName as text
                                const zaaerId = apt.zaaerId || apt.zaaer_id || apt.ZaaerId || '';
                                const apartmentName = apt.apartmentName || apt.apartment_name || '';
                                if (zaaerId && apartmentName && !selectedRoomIds.has(zaaerId.toString())) {
                                    apartmentSelect.append(`<option value="${zaaerId}">${apartmentName}</option>`);
                                }
                            });
                            
                            // Re-initialize Select2
                            if (typeof $.fn.select2 !== 'undefined') {
                                apartmentSelect.select2({
                                    theme: 'default',
                                    dir: 'rtl',
                                    width: '100%',
                                    placeholder: 'اختر الغرفة...',
                                    allowClear: true,
                                    language: {
                                        noResults: function() { return "لا توجد نتائج"; },
                                        searching: function() { return "جاري البحث..."; }
                                    },
                                    dropdownCssClass: 'select2-dropdown-custom'
                                });
                                
                                // ✅ Update other dropdowns when a room is selected/deselected
                                apartmentSelect.off('change').on('change', function() {
                                    updateAllRoomDropdowns();
                                });
                            }
                            
                            apartmentSelect.val(currentZaaerId).trigger('change'); // Restore selection
                        });
                    } else if (data.Apartments && Array.isArray(data.Apartments)) {
                        // ✅ Fallback for old format (uppercase)
                        apartments = data.Apartments;
                        console.log(`✅ [loadApartments] Successfully loaded ${apartments.length} apartments (old format)`);
                        
                        // Update apartment dropdowns in existing rows
                        $('#expenseRoomsBody tr').each(function() {
                            const rowId = $(this).data('row-id');
                            const apartmentSelect = $(`.apartment-select[data-row-id="${rowId}"]`);
                            const currentZaaerId = apartmentSelect.val();
                            
                            // Get already selected room IDs from other rows (exclude current row)
                            const selectedRoomIds = new Set();
                            $('#expenseRoomsBody tr').each(function() {
                                const existingRowId = $(this).data('row-id');
                                if (existingRowId && existingRowId !== rowId) {
                                    const selectedValue = $(`.apartment-select[data-row-id="${existingRowId}"]`).val();
                                    if (selectedValue && selectedValue !== '' && !selectedValue.startsWith('CAT_')) {
                                        selectedRoomIds.add(selectedValue);
                                    }
                                }
                            });
                            
                            // Destroy Select2 if already initialized
                            if (apartmentSelect.hasClass('select2-hidden-accessible')) {
                                apartmentSelect.select2('destroy');
                            }
                            
                            apartmentSelect.empty().append('<option value="">اختر الغرفة...</option>');
                            
                            // ✅ Add room categories first (from API or fallback)
                            const categoryOptions = getRoomCategories();
                            categoryOptions.forEach(cat => {
                                apartmentSelect.append(`<option value="${cat.value}">${cat.text}</option>`);
                            });
                            
                            // Then add rooms (exclude already selected ones)
                            apartments.forEach(apt => {
                                // ✅ Use zaaerId as value and apartmentName as text
                                const zaaerId = apt.zaaerId || apt.zaaer_id || apt.ZaaerId || '';
                                const apartmentName = apt.apartmentName || apt.apartment_name || '';
                                if (zaaerId && apartmentName && !selectedRoomIds.has(zaaerId.toString())) {
                                    apartmentSelect.append(`<option value="${zaaerId}">${apartmentName}</option>`);
                                }
                            });
                            
                            // Re-initialize Select2
                            if (typeof $.fn.select2 !== 'undefined') {
                                apartmentSelect.select2({
                                    theme: 'default',
                                    dir: 'rtl',
                                    width: '100%',
                                    placeholder: 'اختر الغرفة...',
                                    allowClear: true,
                                    language: {
                                        noResults: function() { return "لا توجد نتائج"; },
                                        searching: function() { return "جاري البحث..."; }
                                    },
                                    dropdownCssClass: 'select2-dropdown-custom'
                                });
                                
                                // ✅ Update other dropdowns when a room is selected/deselected
                                apartmentSelect.off('change').on('change', function() {
                                    updateAllRoomDropdowns();
                                });
                            }
                            
                            apartmentSelect.val(currentZaaerId).trigger('change'); // Restore selection
                        });
                    } else if (Array.isArray(data)) {
                        apartments = data;
                        console.log(`✅ [loadApartments] Successfully loaded ${apartments.length} apartments (direct array fallback)`);
                        
                        // Update apartment dropdowns in existing rows
                        $('#expenseRoomsBody tr').each(function() {
                            const rowId = $(this).data('row-id');
                            const apartmentSelect = $(`.apartment-select[data-row-id="${rowId}"]`);
                            const currentZaaerId = apartmentSelect.val();
                            
                            // Get already selected room IDs from other rows (exclude current row)
                            const selectedRoomIds = new Set();
                            $('#expenseRoomsBody tr').each(function() {
                                const existingRowId = $(this).data('row-id');
                                if (existingRowId && existingRowId !== rowId) {
                                    const selectedValue = $(`.apartment-select[data-row-id="${existingRowId}"]`).val();
                                    if (selectedValue && selectedValue !== '' && !selectedValue.startsWith('CAT_')) {
                                        selectedRoomIds.add(selectedValue);
                                    }
                                }
                            });
                            
                            // Destroy Select2 if already initialized
                            if (apartmentSelect.hasClass('select2-hidden-accessible')) {
                                apartmentSelect.select2('destroy');
                            }
                            
                            apartmentSelect.empty().append('<option value="">اختر الغرفة...</option>');
                            
                            // ✅ Add room categories first (from API or fallback)
                            const categoryOptions = getRoomCategories();
                            categoryOptions.forEach(cat => {
                                apartmentSelect.append(`<option value="${cat.value}">${cat.text}</option>`);
                            });
                            
                            // Then add rooms (exclude already selected ones)
                            apartments.forEach(apt => {
                                // ✅ Use zaaerId as value and apartmentName as text
                                const zaaerId = apt.zaaerId || apt.zaaer_id || apt.ZaaerId || '';
                                const apartmentName = apt.apartmentName || apt.apartment_name || '';
                                if (zaaerId && apartmentName && !selectedRoomIds.has(zaaerId.toString())) {
                                    apartmentSelect.append(`<option value="${zaaerId}">${apartmentName}</option>`);
                                }
                            });
                            
                            // Re-initialize Select2
                            if (typeof $.fn.select2 !== 'undefined') {
                                apartmentSelect.select2({
                                    theme: 'default',
                                    dir: 'rtl',
                                    width: '100%',
                                    placeholder: 'اختر الغرفة...',
                                    allowClear: true,
                                    language: {
                                        noResults: function() { return "لا توجد نتائج"; },
                                        searching: function() { return "جاري البحث..."; }
                                    },
                                    dropdownCssClass: 'select2-dropdown-custom'
                                });
                                
                                // ✅ Update other dropdowns when a room is selected/deselected
                                apartmentSelect.off('change').on('change', function() {
                                    updateAllRoomDropdowns();
                                });
                            }
                            
                            apartmentSelect.val(currentZaaerId).trigger('change'); // Restore selection
                        });
                    } else {
                        apartments = [];
                        console.error('❌ [loadApartments] Unexpected response format:', data);
                        console.error('❌ [loadApartments] Expected "apartments" array or direct array, got:', typeof data);
                        showNotification('⚠️ تنسيق استجابة غير متوقع للغرف', 'warning');
                    }
                } else {
                    const errorText = await response.text();
                    console.error(`❌ [loadApartments] HTTP Error ${response.status}:`, errorText);
                    console.error(`❌ [loadApartments] Response headers:`, [...response.headers.entries()]);
                    
                    let errorMessage = `خطأ في تحميل الغرف (${response.status})`;
                    try {
                        const errorData = JSON.parse(errorText || '{}');
                        errorMessage = errorData.message || errorData.error || errorMessage;
                    } catch (parseError) {
                        errorMessage = errorText.substring(0, 100) || errorMessage;
                    }
                    
                    // Don't show error if it's just HotelSettings not found - this is expected for some hotels
                    if (errorMessage.includes('HotelSettings not found')) {
                        console.warn('⚠️ [loadApartments] HotelSettings not found - this hotel may not be configured yet');
                        console.warn('⚠️ [loadApartments] Hotel Code:', currentHotelCode);
                        console.warn('⚠️ [loadApartments] This means the hotel settings are not configured in the tenant database.');
                        showNotification('⚠️ إعدادات الفندق غير موجودة - يرجى التأكد من إعداد الفندق في قاعدة البيانات', 'warning');
                    } else {
                        showNotification(`❌ ${errorMessage}`, 'error');
                    }
                    apartments = [];
                }
            } catch (error) {
                const endTime = performance.now();
                const duration = (endTime - startTime).toFixed(2);
                console.error(`❌ [loadApartments] Exception after ${duration}ms:`, error);
                console.error(`❌ [loadApartments] Error name: ${error.name}, message: ${error.message}`);
                console.error(`❌ [loadApartments] Stack trace:`, error.stack);
                showNotification(`❌ خطأ في تحميل الغرف: ${error.message}`, 'error');
                apartments = [];
            } finally {
                hideLoading();
                console.log(`🏁 [loadApartments] Function completed`);
            }
        }

        // Load Expense Categories
        async function loadExpenseCategories() {
            if (!currentHotelCode) {
                console.warn('⚠️ [loadExpenseCategories] No hotel code selected, skipping...');
                return;
            }

            console.log(`📋 [loadExpenseCategories] Starting to load expense categories for hotel: ${currentHotelCode}`);
            const startTime = performance.now();

            try {
                showLoading();
                
                // ✅ الحصول على tenantCode من userInfo (من JWT Token)
                const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
                const authToken = localStorage.getItem('authToken');
                
                if (!currentHotelCode || !authToken) {
                    showNotification('⚠️ يرجى تسجيل الدخول أولاً', 'warning');
                    return;
                }
                
                // ✅ SECURITY: التأكد من أن currentHotelCode يطابق tenantCode من JWT Token
                if (currentHotelCode !== userInfo.tenantCode) {
                    console.error(`⚠️ SECURITY: Hotel code mismatch. Current: ${currentHotelCode}, Expected: ${userInfo.tenantCode}`);
                    showNotification('⚠️ خطأ في الأمان: لا يمكنك الوصول إلى هذا الفندق', 'error');
                    return;
                }
                
                // Load from Master DB - ExpenseCategories table
                // Use Master DB API endpoint (you may need to create this endpoint in your API)
                const url = `${API_BASE_URL}/api/Master/ExpenseCategories`;
                const requestHeaders = {
                    'Authorization': `Bearer ${authToken}`, // ✅ إضافة JWT Token
                    'X-Hotel-Code': currentHotelCode,
                    'Accept': 'application/json'
                };
                
                console.log(`📤 [loadExpenseCategories] ===== REQUEST PAYLOAD =====`);
                console.log(`📤 [loadExpenseCategories] URL: ${url}`);
                console.log(`📤 [loadExpenseCategories] Method: GET`);
                console.log(`📤 [loadExpenseCategories] Headers:`, JSON.stringify(requestHeaders, null, 2));
                console.log(`📤 [loadExpenseCategories] Current Hotel Code: ${currentHotelCode}`);
                console.log(`📤 [loadExpenseCategories] User Info:`, JSON.stringify(userInfo, null, 2));

                const response = await fetch(url, {
                    headers: requestHeaders
                });

                const endTime = performance.now();
                const duration = (endTime - startTime).toFixed(2);

                console.log(`📥 [loadExpenseCategories] ===== RESPONSE =====`);
                console.log(`📥 [loadExpenseCategories] Status: ${response.status} ${response.statusText}`);
                console.log(`📥 [loadExpenseCategories] Duration: ${duration}ms`);
                console.log(`📥 [loadExpenseCategories] Response Headers:`, [...response.headers.entries()]);

                if (response.ok) {
                    expenseCategories = await response.json();
                    console.log(`📦 [loadExpenseCategories] ===== RESPONSE PAYLOAD =====`);
                    console.log(`📦 [loadExpenseCategories] Response data:`, JSON.stringify(expenseCategories, null, 2));
                    console.log(`📦 [loadExpenseCategories] Response type:`, typeof expenseCategories);
                    console.log(`📦 [loadExpenseCategories] Is array?`, Array.isArray(expenseCategories));
                    console.log(`📦 [loadExpenseCategories] Array length:`, expenseCategories.length);
                    console.log(`✅ [loadExpenseCategories] Successfully loaded ${expenseCategories.length} expense categories`);
                    
                    // ✅ استخراج فئات الغرف (Room Categories) - الفئات التي لها categoryCode
                    roomCategories = [];
                    if (Array.isArray(expenseCategories)) {
                        roomCategories = expenseCategories.filter(cat => {
                            const categoryCode = cat.categoryCode || cat.CategoryCode;
                            return categoryCode && categoryCode.startsWith('CAT_');
                        });
                        console.log(`✅ [loadExpenseCategories] Extracted ${roomCategories.length} room categories:`, roomCategories.map(c => c.categoryCode || c.CategoryCode));
                    }

                    const categorySelect = $('#expenseCategorySelect');
                    
                    // Destroy Select2 if already initialized
                    if (categorySelect.hasClass('select2-hidden-accessible')) {
                        categorySelect.select2('destroy');
                    }
                    
                    categorySelect.empty().append('<option value="">اختر فئة المصروف...</option>');
                    
                    if (Array.isArray(expenseCategories)) {
                        expenseCategories.forEach(category => {
                            // Use Id as value and MainCategory (البند الرئيسي) as text
                            const categoryId = category.id || category.Id || category.expenseCategoryId || category.ExpenseCategoryId;
                            const mainCategory = category.mainCategory || category.MainCategory || category.categoryName || category.CategoryName;
                            const categoryCode = (category.categoryCode || category.CategoryCode || '').toUpperCase();
                            const hideFromExpenseSelect = HIDDEN_EXPENSE_CATEGORY_CODES.has(categoryCode);

                            if (hideFromExpenseSelect) {
                                console.log(`  ⚪ Skipping category ${categoryCode} from expense dropdown`);
                            }

                            if (categoryId && mainCategory && !hideFromExpenseSelect) {
                                console.log(`  ➕ Adding category: ${categoryId} - ${mainCategory}`);
                                categorySelect.append(`<option value="${categoryId}" data-details="${(category.details || category.Details || '').replace(/"/g, '&quot;')}">${mainCategory}</option>`);
                            }
                        });
                        
                        // Initialize Select2 for Expense Category
                        if (typeof $.fn.select2 !== 'undefined') {
                            categorySelect.select2({
                                theme: 'default',
                                dir: 'rtl',
                                width: '100%',
                                placeholder: ' فئة المصروف...',
                                allowClear: false, // Required field - no clear button
                                language: {
                                    noResults: function() { return "لا توجد نتائج"; },
                                    searching: function() { return "جاري البحث..."; }
                                },
                                dropdownCssClass: 'select2-dropdown-custom'
                            });
                            
                            // Show modal with التفصيل when category is selected
                            categorySelect.on('change', function() {
                                const selectedOption = $(this).find('option:selected');
                                const details = selectedOption.data('details');
                                if (details && details.trim() !== '') {
                                    showCategoryDetailsModal(selectedOption.text(), details);
                                }
                            });
                        }
                        
                        console.log(`✅ [loadExpenseCategories] Populated dropdown with ${expenseCategories.length} categories`);
                    } else {
                        console.error('❌ [loadExpenseCategories] Response is not an array:', typeof expenseCategories);
                        expenseCategories = [];
                    }
                } else {
                    const errorText = await response.text();
                    console.error(`❌ [loadExpenseCategories] HTTP Error ${response.status}:`, errorText);
                    console.error(`❌ [loadExpenseCategories] Response headers:`, [...response.headers.entries()]);
                    
                    expenseCategories = [];
                    let errorMessage = `خطأ في تحميل فئات المصروفات (${response.status})`;
                    try {
                        const errorData = JSON.parse(errorText || '{}');
                        errorMessage = errorData.error || errorData.message || errorMessage;
                    } catch (parseError) {
                        errorMessage = errorText.substring(0, 100) || errorMessage;
                    }
                    
                    // Don't show error if it's 404 or HotelSettings not found - categories might not exist yet
                    if (response.status === 404 || errorMessage.includes('HotelSettings not found')) {
                        console.warn('⚠️ [loadExpenseCategories] Categories endpoint not found or hotel not configured');
                        // Don't show error - categories are optional
                    } else {
                        showNotification(`❌ ${errorMessage}`, 'error');
                    }
                }
            } catch (error) {
                const endTime = performance.now();
                const duration = (endTime - startTime).toFixed(2);
                console.error(`❌ [loadExpenseCategories] Exception after ${duration}ms:`, error);
                console.error(`❌ [loadExpenseCategories] Error name: ${error.name}, message: ${error.message}`);
                console.error(`❌ [loadExpenseCategories] Stack trace:`, error.stack);
                
                expenseCategories = [];
                showNotification(`❌ خطأ في تحميل فئات المصروفات: ${error.message}`, 'error');
            } finally {
                hideLoading();
                console.log(`🏁 [loadExpenseCategories] Function completed`);
            }
        }

        // Initialize Form Controls (Gregorian Calendar only)
        function initializeFormControls() {
            console.log('📅 [initializeFormControls] Starting calendar initialization...');
            
            try {
                // Check if jQuery is loaded
                if (typeof $ === 'undefined' || typeof jQuery === 'undefined') {
                    console.error('❌ [initializeFormControls] jQuery is not loaded');
                    showNotification('❌ تعذر تحميل jQuery', 'error');
                    return;
                }
                console.log('✅ [initializeFormControls] jQuery loaded');

                // Check if calendars plugin is loaded
                if (typeof $.calendars === 'undefined') {
                    console.error('❌ [initializeFormControls] $.calendars is undefined');
                    console.error('❌ [initializeFormControls] Available jQuery plugins:', Object.keys($.fn));
                    showNotification('❌ تعذر تحميل مكتبة التقويم (calendars)', 'error');
                    // Fallback: use HTML5 date input
                    $('#expenseDate').attr('type', 'date').prop('disabled', true);
                    $('#dueDate').attr('type', 'date');
                    const today = new Date().toISOString().split('T')[0];
                    $('#expenseDate').val(today);
                    return;
                }
                console.log('✅ [initializeFormControls] $.calendars loaded');

                // Check if calendars instance method exists
                if (typeof $.calendars.instance === 'undefined') {
                    console.error('❌ [initializeFormControls] $.calendars.instance is undefined');
                    showNotification('❌ تعذر تحميل مكتبة التقويم (instance)', 'error');
                    // Fallback: use HTML5 date input
                    $('#expenseDate').attr('type', 'date').prop('disabled', true);
                    $('#dueDate').attr('type', 'date');
                    const today = new Date().toISOString().split('T')[0];
                    $('#expenseDate').val(today);
                    return;
                }
                console.log('✅ [initializeFormControls] $.calendars.instance loaded');

                // Check if calendarsPicker plugin is loaded
                if (typeof $.fn.calendarsPicker === 'undefined') {
                    console.error('❌ [initializeFormControls] calendarsPicker plugin is not loaded');
                    console.error('❌ [initializeFormControls] Available jQuery plugins:', Object.keys($.fn).filter(k => k.toLowerCase().includes('picker')));
                    showNotification('❌ تعذر تحميل أداة التقويم (calendarsPicker)', 'error');
                    // Fallback: use HTML5 date input
                    $('#expenseDate').attr('type', 'date').prop('disabled', true);
                    $('#dueDate').attr('type', 'date');
                    const today = new Date().toISOString().split('T')[0];
                    $('#expenseDate').val(today);
                    return;
                }
                console.log('✅ [initializeFormControls] calendarsPicker plugin loaded');

                console.log('📅 [initializeFormControls] Initializing Gregorian calendar...');

                // Initialize Gregorian Calendar only
                try {
                    const gregorianCalendar = $.calendars.instance();
                    console.log('✅ [initializeFormControls] Gregorian calendar instance created');
                    
                    // Get today's date
                    const today = gregorianCalendar.today();
                    const todayFormatted = today.formatDate('yyyy-mm-dd');
                    
                    // Initialize calendar picker for expense date (readonly - opens on click)
                    $('#expenseDate').calendarsPicker({
                        calendar: gregorianCalendar,
                        dateFormat: 'yyyy-mm-dd',
                        showOnFocus: true,
                        defaultDate: today,
                        onSelect: function(dates) {
                            console.log('📅 Date selected:', dates);
                            // dates is an array of CDate objects
                            if (dates && dates.length > 0 && dates[0]) {
                                const selectedDate = dates[0].formatDate('yyyy-mm-dd');
                                $('#expenseDate').val(selectedDate);
                                console.log('✅ Date formatted and set:', selectedDate);
                            }
                        }
                    });
                    
                    // Set today's date in the input
                    $('#expenseDate').val(todayFormatted);
                    
                    // Initialize calendar picker for due date
                    $('#dueDate').calendarsPicker({
                        calendar: gregorianCalendar,
                        dateFormat: 'yyyy-mm-dd',
                        showOnFocus: true,
                        onSelect: function(dates) {
                            console.log('📅 Due date selected:', dates);
                            if (dates && dates.length > 0 && dates[0]) {
                                const selectedDate = dates[0].formatDate('yyyy-mm-dd');
                                $('#dueDate').val(selectedDate);
                                console.log('✅ Due date formatted and set:', selectedDate);
                            }
                        }
                    });
                    
                    console.log('✅ [initializeFormControls] Gregorian calendar initialized with today\'s date:', todayFormatted);
                } catch (gregError) {
                    console.error('❌ [initializeFormControls] Error initializing Gregorian calendar:', gregError);
                    console.error('❌ [initializeFormControls] Error details:', gregError.message, gregError.stack);
                    // Fallback: use HTML5 date input
                    $('#expenseDate').attr('type', 'date');
                    const today = new Date().toISOString().split('T')[0];
                    $('#expenseDate').val(today);
                    showNotification('⚠️ تم استخدام تقويم HTML5 كبديل', 'warning');
                }

                console.log('✅ [initializeFormControls] Calendar initialization completed');
            } catch (error) {
                console.error('❌ [initializeFormControls] Exception:', error);
                console.error(`❌ [initializeFormControls] Error name: ${error.name}, message: ${error.message}`);
                console.error('❌ [initializeFormControls] Stack trace:', error.stack);
                // Fallback: use HTML5 date input
                $('#expenseDate').attr('type', 'date').prop('disabled', true);
                $('#dueDate').attr('type', 'date');
                const today = new Date().toISOString().split('T')[0];
                $('#expenseDate').val(today);
                showNotification('⚠️ تم استخدام تقويم HTML5 كبديل', 'warning');
            }
        }

        // Initialize Images Upload
        function initializeImagesUpload() {
            const uploadArea = $('#uploadArea');
            const imageFiles = $('#imageFiles');

            // Click to select files (only one handler)
            uploadArea.on('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                imageFiles.click();
            });

            // File selection
            imageFiles.on('change', function(e) {
                handleFiles(e.target.files);
            });

            // Drag and drop
            uploadArea.on('dragover', function(e) {
                e.preventDefault();
                $(this).addClass('dragover');
            });

            uploadArea.on('dragleave', function(e) {
                e.preventDefault();
                $(this).removeClass('dragover');
            });

            uploadArea.on('drop', function(e) {
                e.preventDefault();
                $(this).removeClass('dragover');
                handleFiles(e.originalEvent.dataTransfer.files);
            });
        }

        // Handle selected files
        function handleFiles(files) {
            const MAX_FILE_SIZE = 1 * 1024 * 1024; // 1MB in bytes
            Array.from(files).forEach(file => {
                if (file.type.startsWith('image/')) {
                    // Check file size (1MB limit)
                    if (file.size > MAX_FILE_SIZE) {
                        showNotification(`⚠️ حجم الصورة "${file.name}" أكبر من 1 ميجابايت. الحد الأقصى المسموح: 1 ميجابايت`, 'warning');
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        selectedImages.push({
                            file: file,
                            dataUrl: e.target.result,
                            id: Date.now() + Math.random(),
                            isExisting: false // ✅ Mark as new image (just added by user)
                        });
                        updateImagesPreview();
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        // Update images preview
        function updateImagesPreview() {
            const preview = $('#imagesPreview');
            preview.empty();

            if (selectedImages.length === 0) {
                $('#emptyImagesMessage').show();
            } else {
                $('#emptyImagesMessage').hide();
                selectedImages.forEach((image, index) => {
                    const item = $(`
                        <div class="image-preview-item">
                            <img src="${image.dataUrl}" alt="Preview ${index + 1}" />
                            <button type="button" class="remove-image" onclick="removeImage(${image.id})" title="إزالة">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `);
                    preview.append(item);
                });
            }
        }

        // Remove image
        function removeImage(id) {
            selectedImages = selectedImages.filter(img => img.id !== id);
            updateImagesPreview();
        }

        // Add Expense Room Row
        function addExpenseRoomRow() {
            expenseRoomRowCounter++;
            const rowId = `roomRow_${expenseRoomRowCounter}`;

            // ✅ Get already selected room IDs from other rows (exclude current row)
            const selectedRoomIds = new Set();
            $('#expenseRoomsBody tr').each(function() {
                const existingRowId = $(this).data('row-id');
                if (existingRowId && existingRowId !== expenseRoomRowCounter) {
                    const selectedValue = $(`.apartment-select[data-row-id="${existingRowId}"]`).val();
                    if (selectedValue && selectedValue !== '' && !selectedValue.startsWith('CAT_')) {
                        selectedRoomIds.add(selectedValue);
                    }
                }
            });

            // ✅ إنشاء options للغرف - استخدام zaaerId كـ value و apartmentName كنص
            let apartmentOptions = '<option value="">اختر الغرفة...</option>';
            
            // ✅ أولاً: إضافة فئات الغرف من API (تظهر في البداية - أول حاجة في dropdown)
            // هذه الفئات (مبنى كامل، الاستقبال، الممرات) تظهر قبل الغرف الفعلية
            // First: Add room categories from API (appear at the top of dropdown)
            if (roomCategories && roomCategories.length > 0) {
                roomCategories.forEach(cat => {
                    const categoryCode = cat.categoryCode || cat.CategoryCode;
                    const mainCategory = cat.mainCategory || cat.MainCategory;
                    if (categoryCode && mainCategory) {
                        apartmentOptions += `<option value="${categoryCode}">${mainCategory}</option>`;
                    }
                });
            } else {
                // ✅ Fallback: إذا لم يتم تحميل الفئات من API، استخدم القيم الثابتة
                const fallbackCategories = [
                    { value: 'CAT_BUILDING', text: 'مبنى كامل' },
                    { value: 'CAT_RECEPTION', text: 'الاستقبال' },
                    { value: 'CAT_CORRIDORS', text: 'الممرات' }
                ];
                fallbackCategories.forEach(cat => {
                    apartmentOptions += `<option value="${cat.value}">${cat.text}</option>`;
                });
            }
            
            // ✅ ثانياً: إضافة الغرف الفعلية (بعد الفئات)
            // Then add actual rooms (after categories - exclude already selected ones)
            if (apartments.length > 0) {
                apartments.forEach(apt => {
                    const zaaerId = apt.zaaerId || apt.zaaer_id || apt.ZaaerId || '';
                    const apartmentName = apt.apartmentName || apt.apartment_name || '';
                    if (zaaerId && apartmentName && !selectedRoomIds.has(zaaerId.toString())) {
                        apartmentOptions += `<option value="${zaaerId}">${apartmentName}</option>`;
                    }
                });
            } else {
                apartmentOptions += '<option value="">جاري تحميل الغرف...</option>';
            }

            const row = `
                <tr id="${rowId}" data-row-id="${expenseRoomRowCounter}">
                    <td data-label="الغرفة">
                        <select class="form-select form-select-sm apartment-select" data-row-id="${expenseRoomRowCounter}">
                            <option value="">اختر الغرفة...</option>
                            ${apartmentOptions}
                        </select>
                    </td>
                    <td data-label="الغرض من المصروف">
                        <input type="text" class="form-control form-control-sm purpose-input" data-row-id="${expenseRoomRowCounter}" placeholder="أدخل الغرض من المصروف..." />
                    </td>
                    <td data-label="المبلغ">
                        <input type="number" class="form-control form-control-sm amount-input" data-row-id="${expenseRoomRowCounter}" placeholder="0.00" min="0" step="0.01" oninput="calculateTotalFromRooms()" />
                    </td>
                    <td data-label="إزالة">
                        <button type="button" class="remove-room-btn" onclick="removeExpenseRoomRow('${rowId}')">
                            <i class="fas fa-trash"></i>
                            إزالة
                        </button>
                    </td>
                </tr>
            `;

            $('#expenseRoomsBody').append(row);
            $('#expenseRoomsTable').show();
            $('#emptyRoomsMessage').hide();

            // Animate row entry
            $(`#${rowId}`).css({ opacity: 0, transform: 'translateX(20px)' })
                .animate({ opacity: 1, transform: 'translateX(0)' }, 300);
            
            // ✅ إذا تم تحميل الغرف لاحقاً، قم بتحديث dropdown - استخدام zaaerId كـ value و apartmentName كنص
            // Exclude already selected rooms
            // ✅ Get categories first (always available)
            const categoryOptions = getRoomCategories();
            
            if (apartments.length > 0) {
                const apartmentSelect = $(`.apartment-select[data-row-id="${expenseRoomRowCounter}"]`);
                const currentSelectedValue = apartmentSelect.val();
                
                // Get already selected room IDs from other rows
                const selectedRoomIds = new Set();
                $('#expenseRoomsBody tr').each(function() {
                    const existingRowId = $(this).data('row-id');
                    if (existingRowId && existingRowId !== expenseRoomRowCounter) {
                        const selectedValue = $(`.apartment-select[data-row-id="${existingRowId}"]`).val();
                        if (selectedValue && selectedValue !== '' && !selectedValue.startsWith('CAT_')) {
                            selectedRoomIds.add(selectedValue);
                        }
                    }
                });
                
                apartmentSelect.empty().append('<option value="">اختر الغرفة...</option>');
                
                // ✅ Add categories first using getRoomCategories()
                categoryOptions.forEach(cat => {
                    apartmentSelect.append(`<option value="${cat.value}">${cat.text}</option>`);
                });
                
                // Add rooms (exclude already selected)
                apartments.forEach(apt => {
                    const zaaerId = apt.zaaerId || apt.zaaer_id || apt.ZaaerId || '';
                    const apartmentName = apt.apartmentName || apt.apartment_name || '';
                    if (zaaerId && apartmentName && !selectedRoomIds.has(zaaerId.toString())) {
                        apartmentSelect.append(`<option value="${zaaerId}">${apartmentName}</option>`);
                    }
                });
                
                // Restore selection if it was set
                if (currentSelectedValue) {
                    apartmentSelect.val(currentSelectedValue).trigger('change');
                }
            }
            
            // ✅ Initialize Select2 for the apartment selector (same style as expenseCategorySelect)
            const apartmentSelect = $(`.apartment-select[data-row-id="${expenseRoomRowCounter}"]`);
            if (typeof $.fn.select2 !== 'undefined') {
                // Destroy Select2 if already initialized
                if (apartmentSelect.hasClass('select2-hidden-accessible')) {
                    apartmentSelect.select2('destroy');
                }
                
                apartmentSelect.select2({
                    theme: 'default',
                    dir: 'rtl',
                    width: '100%',
                    placeholder: 'اختر الغرفة أو الموقع...',
                    allowClear: true,
                    language: {
                        noResults: function() { return "لا توجد نتائج"; },
                        searching: function() { return "جاري البحث..."; }
                    },
                    dropdownCssClass: 'select2-dropdown-custom'
                });
                
                // ✅ Update other dropdowns when a room is selected/deselected (don't trigger calculateTotalFromRooms)
                apartmentSelect.on('change', function() {
                    updateAllRoomDropdowns();
                    // Do NOT call calculateTotalFromRooms() here - only amount input should trigger it
                });
            }
            
            // ✅ Add event listener for amount input to calculate total
            $(`.amount-input[data-row-id="${expenseRoomRowCounter}"]`).on('input', function() {
                calculateTotalFromRooms();
            });
        }
        
        // ✅ Calculate total amount from all room amounts
        function calculateTotalFromRooms() {
            let total = 0;
            $('#expenseRoomsBody tr').each(function() {
                const rowId = $(this).data('row-id');
                const amountInput = $(`.amount-input[data-row-id="${rowId}"]`);
                const amountValue = parseFloat(amountInput.val()) || 0;
                total += amountValue;
            });
            
            // Update total amount field
            $('#totalAmount').val(total.toFixed(2));
            
            // If tax checkbox is checked, recalculate tax
            if ($('#includeTaxCheckbox').is(':checked')) {
                calculateTax();
            }
        }
        
        // ✅ Helper function to get room categories (from API or fallback)
        function getRoomCategories() {
            if (roomCategories && roomCategories.length > 0) {
                return roomCategories.map(cat => ({
                    value: cat.categoryCode || cat.CategoryCode,
                    text: cat.mainCategory || cat.MainCategory
                })).filter(cat => cat.value && cat.text);
            }
            // Fallback to static categories if API hasn't loaded yet
            return [
                { value: 'CAT_BUILDING', text: 'مبنى كامل' },
                { value: 'CAT_RECEPTION', text: 'الاستقبال' },
                { value: 'CAT_CORRIDORS', text: 'الممرات' }
            ];
        }

        // ✅ Function to update all room dropdowns (exclude already selected rooms)
        // Use debounce to prevent multiple rapid updates
        let updateDropdownsTimeout = null;
        function updateAllRoomDropdowns() {
            // Clear existing timeout
            if (updateDropdownsTimeout) {
                clearTimeout(updateDropdownsTimeout);
            }
            
            // Debounce the update to prevent rapid re-renders
            updateDropdownsTimeout = setTimeout(function() {
                // Update each dropdown
                $('#expenseRoomsBody tr').each(function() {
                    const rowId = $(this).data('row-id');
                    const apartmentSelect = $(`.apartment-select[data-row-id="${rowId}"]`);
                    const currentSelectedValue = apartmentSelect.val();
                    
                    // Get selected rooms excluding current row
                    const selectedRoomIds = new Set();
                    $('#expenseRoomsBody tr').each(function() {
                        const existingRowId = $(this).data('row-id');
                        if (existingRowId && existingRowId !== rowId) {
                            const selectedValue = $(`.apartment-select[data-row-id="${existingRowId}"]`).val();
                            if (selectedValue && selectedValue !== '' && !selectedValue.startsWith('CAT_')) {
                                selectedRoomIds.add(selectedValue);
                            }
                        }
                    });
                    
                    // Store if Select2 is initialized
                    const isSelect2Initialized = apartmentSelect.hasClass('select2-hidden-accessible');
                    
                    if (isSelect2Initialized) {
                        apartmentSelect.select2('destroy');
                    }
                    
                    apartmentSelect.empty().append('<option value="">اختر الغرفة...</option>');
                    
                    // ✅ Add room categories first (from API or fallback)
                    const categoryOptions = getRoomCategories();
                    categoryOptions.forEach(cat => {
                        apartmentSelect.append(`<option value="${cat.value}">${cat.text}</option>`);
                    });
                    
                    // Add rooms (exclude already selected)
                    apartments.forEach(apt => {
                        const zaaerId = apt.zaaerId || apt.zaaer_id || apt.ZaaerId || '';
                        const apartmentName = apt.apartmentName || apt.apartment_name || '';
                        if (zaaerId && apartmentName && !selectedRoomIds.has(zaaerId.toString())) {
                            apartmentSelect.append(`<option value="${zaaerId}">${apartmentName}</option>`);
                        }
                    });
                    
                    // Restore selection
                    if (currentSelectedValue) {
                        apartmentSelect.val(currentSelectedValue);
                    }
                    
                    // Re-initialize Select2 if it was initialized before
                    if (isSelect2Initialized && typeof $.fn.select2 !== 'undefined') {
                        apartmentSelect.select2({
                            theme: 'default',
                            dir: 'rtl',
                            width: '100%',
                            placeholder: 'اختر الغرفة...',
                            allowClear: true,
                            language: {
                                noResults: function() { return "لا توجد نتائج"; },
                                searching: function() { return "جاري البحث..."; }
                            },
                            dropdownCssClass: 'select2-dropdown-custom'
                        });
                        
                        // Restore selection after Select2 initialization (without triggering change event)
                        if (currentSelectedValue) {
                            apartmentSelect.val(currentSelectedValue);
                            // Manually update Select2 display without triggering change
                            apartmentSelect.trigger('select2:select');
                        }
                        
                        // Re-attach change handler (with debounce)
                        apartmentSelect.off('change').on('change', function() {
                            updateAllRoomDropdowns();
                        });
                    }
                });
            }, 150); // 150ms debounce delay
        }

        // Remove Expense Room Row
        function removeExpenseRoomRow(rowId) {
            const $row = $(`#${rowId}`);
            $row.animate({ opacity: 0, transform: 'translateX(-20px)' }, 300, function() {
                $row.remove();
                
                // ✅ Update all dropdowns after removing a row
                updateAllRoomDropdowns();
                
                // ✅ Recalculate total after removing a row
                calculateTotalFromRooms();
                
                if ($('#expenseRoomsBody tr').length === 0) {
                    $('#expenseRoomsTable').hide();
                    $('#emptyRoomsMessage').show();
                }
            });
        }

        // Form Submit Handler
        $('#expenseForm').on('submit', async function(e) {
            e.preventDefault();

            if (!currentHotelCode) {
                showNotification('⚠️ يرجى اختيار الفندق أولاً', 'warning');
                return;
            }

            try {
                showLoading();

                let expenseDate = $('#expenseDate').val();
                if (!expenseDate) {
                    showNotification('⚠️ يرجى اختيار التاريخ', 'warning');
                    hideLoading();
                    return;
                }

                // Convert date format - use current date/time (like created_at)
                let dateTime;
                if (expenseDate.includes('-')) {
                    // Format: yyyy-mm-dd - use selected date with current time
                    const selectedDate = new Date(expenseDate + 'T00:00:00');
                    const now = new Date();
                    // Set the date from selected date, but keep current time
                    selectedDate.setHours(now.getHours());
                    selectedDate.setMinutes(now.getMinutes());
                    selectedDate.setSeconds(now.getSeconds());
                    dateTime = selectedDate;
                } else {
                    // Try to parse as is, or use current date/time
                    dateTime = new Date(expenseDate);
                    if (isNaN(dateTime.getTime())) {
                        dateTime = new Date(); // Use current date/time as fallback
                    }
                }
                
                if (isNaN(dateTime.getTime())) {
                    // Fallback to current date/time
                    dateTime = new Date();
                }
                const categoryId = $('#expenseCategorySelect').val() || null;
                
                // ✅ Validate expense category is required
                if (!categoryId || categoryId === '') {
                    showNotification('⚠️ يرجى اختيار فئة المصروف', 'warning');
                    hideLoading();
                    // Focus on category select
                    $('#expenseCategorySelect').select2('open');
                    return;
                }
                
                const comment = $('#expenseComment').val() || null;
                const totalAmount = parseFloat($('#totalAmount').val());

                if (!totalAmount || totalAmount <= 0) {
                    showNotification('⚠️ يرجى إدخال المبلغ الإجمالي', 'warning');
                    hideLoading();
                    return;
                }

                // Get tax information - ensure tax is calculated if checkbox is checked
                const includeTax = $('#includeTaxCheckbox').is(':checked');
                let taxRateValue = null;
                let taxAmountValue = null;
                
                if (includeTax) {
                    // Get tax amount from input (may be calculated or manually entered)
                    const taxAmountInput = parseFloat($('#taxAmount').val()) || 0;
                    
                    if (taxRate > 0 && totalAmount > 0) {
                        // Tax rate is loaded - use it and recalculate to ensure accuracy
                        const baseAmount = totalAmount / (1 + (taxRate / 100));
                        const calculatedTax = totalAmount - baseAmount;
                        taxRateValue = taxRate;
                        taxAmountValue = calculatedTax > 0 ? calculatedTax : (taxAmountInput > 0 ? taxAmountInput : null);
                    } else if (taxAmountInput > 0 && totalAmount > 0) {
                        // Tax rate not loaded but user entered tax amount manually
                        // Calculate tax rate from amount: taxRate = (taxAmount / (totalAmount - taxAmount)) * 100
                        const baseAmount = totalAmount - taxAmountInput;
                        if (baseAmount > 0) {
                            const calculatedRate = (taxAmountInput / baseAmount) * 100;
                            taxRateValue = calculatedRate > 0 ? parseFloat(calculatedRate.toFixed(2)) : null;
                            taxAmountValue = taxAmountInput;
                        } else {
                            taxRateValue = null;
                            taxAmountValue = taxAmountInput;
                        }
                    } else if (taxAmountInput > 0) {
                        // Tax amount entered but total is 0 or invalid
                        taxRateValue = null;
                        taxAmountValue = taxAmountInput;
                    } else {
                        // Checkbox checked but no tax amount - set to null
                        taxRateValue = null;
                        taxAmountValue = null;
                    }
                } else {
                    // If checkbox is unchecked, explicitly set to null
                    taxRateValue = null;
                    taxAmountValue = null;
                }
                
                // Debug: Log tax values to ensure they're being set
                console.log('📊 Tax values:', { 
                    includeTax, 
                    taxRate, 
                    totalAmount, 
                    taxAmountInput: parseFloat($('#taxAmount').val()) || 0, 
                    taxRateValue, 
                    taxAmountValue 
                });

                // Get due date if provided, otherwise set to today
                let dueDateValue = null;
                const dueDateInput = $('#dueDate').val();
                if (dueDateInput && dueDateInput.trim() !== '') {
                    // ✅ Fix timezone issue: Use local date directly without timezone conversion
                    // Extract year, month, day directly from input (format: YYYY-MM-DD)
                    const dateParts = dueDateInput.trim().split('-');
                    if (dateParts.length === 3) {
                        const year = parseInt(dateParts[0]);
                        const month = parseInt(dateParts[1]) - 1; // JavaScript months are 0-indexed
                        const day = parseInt(dateParts[2]);
                        const localDate = new Date(year, month, day);
                        // Format as YYYY-MM-DD using local date (not UTC)
                        dueDateValue = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    } else {
                        // Fallback to old method if format is different
                        const dueDate = new Date(dueDateInput + 'T00:00:00');
                        if (!isNaN(dueDate.getTime())) {
                            // Use local date parts instead of UTC
                            const localYear = dueDate.getFullYear();
                            const localMonth = String(dueDate.getMonth() + 1).padStart(2, '0');
                            const localDay = String(dueDate.getDate()).padStart(2, '0');
                            dueDateValue = `${localYear}-${localMonth}-${localDay}`;
                        }
                    }
                } else {
                    // ✅ Set to today if not provided
                    const today = new Date();
                    const todayYear = today.getFullYear();
                    const todayMonth = String(today.getMonth() + 1).padStart(2, '0');
                    const todayDay = String(today.getDate()).padStart(2, '0');
                    dueDateValue = `${todayYear}-${todayMonth}-${todayDay}`; // Use local date
                }

                // Collect expense rooms and calculate sum
                const expenseRooms = [];
                let expenseRoomsTotal = 0;
                $('#expenseRoomsBody tr').each(function() {
                    const rowId = $(this).data('row-id');
                    const zaaerId = $(`.apartment-select[data-row-id="${rowId}"]`).val(); // ✅ Use zaaerId instead of apartmentId
                    
                    if (zaaerId) {
                        const purpose = $(`.purpose-input[data-row-id="${rowId}"]`).val();
                        const amount = $(`.amount-input[data-row-id="${rowId}"]`).val() ? parseFloat($(`.amount-input[data-row-id="${rowId}"]`).val()) : null;
                        if (amount) {
                            expenseRoomsTotal += amount;
                        }
                        
                        // ✅ Handle category values (CAT_BUILDING, CAT_RECEPTION, CAT_CORRIDORS) vs room zaaerId
                        // Categories are strings, room IDs are integers
                        let expenseRoomData = {
                            purpose: purpose || null,
                            amount: amount || null
                        };
                        
                        if (zaaerId.toString().startsWith('CAT_')) {
                            // It's a category, send categoryCode instead of zaaerId
                            expenseRoomData.categoryCode = zaaerId.toString();
                            // Don't send zaaerId for categories
                        } else {
                            // It's a room ID, parse as integer and send zaaerId
                            expenseRoomData.zaaerId = parseInt(zaaerId);
                        }
                        
                        expenseRooms.push(expenseRoomData);
                    }
                });

                // ✅ Validate: sum of expense rooms amounts must match total amount
                if (expenseRooms.length > 0) {
                    const tolerance = 0.01; // Allow small floating point differences
                    if (Math.abs(expenseRoomsTotal - totalAmount) > tolerance) {
                        showNotification('⚠️ مجموع مبالغ الغرف (' + expenseRoomsTotal.toFixed(2) + ') يجب أن يساوي المبلغ الإجمالي (' + totalAmount.toFixed(2) + ')', 'warning');
                        hideLoading();
                        return;
                    }
                }

                // Build JSON payload (images will be handled separately)
                const payload = {
                    dateTime: dateTime.toISOString(),
                    dueDate: dueDateValue,
                    comment: comment || null,
                    expenseCategoryId: categoryId ? parseInt(categoryId) : null,
                    totalAmount: totalAmount,
                    taxRate: taxRateValue,
                    taxAmount: taxAmountValue,
                    expenseRooms: expenseRooms.length > 0 ? expenseRooms : null
                };

                // Debug: Log full payload including tax values
                console.log('📤 Sending expense data:', JSON.stringify(payload, null, 2));

                // ✅ الحصول على tenantCode من userInfo (من JWT Token)
                const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
                const authToken = localStorage.getItem('authToken');
                
                if (!currentHotelCode || !authToken) {
                    showNotification('⚠️ يرجى تسجيل الدخول أولاً', 'warning');
                    return;
                }
                
                // ✅ SECURITY: التأكد من أن currentHotelCode يطابق tenantCode من JWT Token
                if (currentHotelCode !== userInfo.tenantCode) {
                    console.error(`⚠️ SECURITY: Hotel code mismatch. Current: ${currentHotelCode}, Expected: ${userInfo.tenantCode}`);
                    showNotification('⚠️ خطأ في الأمان: لا يمكنك الوصول إلى هذا الفندق', 'error');
                    return;
                }
                
                // Check if we're editing an existing expense
                const editingExpenseId = $('#expenseForm').data('editing-expense-id');
                const isEditMode = editingExpenseId !== undefined && editingExpenseId !== null;
                
                // Send request with JSON (images will be uploaded separately later)
                // ExpenseController route: api/[controller] = api/Expense (singular)
                const url = isEditMode 
                    ? `${API_BASE_URL}/api/Expense/${editingExpenseId}`
                    : `${API_BASE_URL}/api/Expense`;
                
                const response = await fetch(url, {
                    method: isEditMode ? 'PUT' : 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`, // ✅ إضافة JWT Token
                        'X-Hotel-Code': currentHotelCode
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    const responseData = await response.json();
                    
                    // ✅ Debug: عرض الاستجابة الكاملة في console
                    console.log('📦 Full API Response:', JSON.stringify(responseData, null, 2));
                    
                    const expenseId = responseData.expenseId || responseData.ExpenseId;
                    const approvalStatus = responseData.approvalStatus || responseData.ApprovalStatus;
                    const approvalLink = responseData.approvalLink || responseData.ApprovalLink;
                    
                    console.log('🔍 Parsed values:', {
                        expenseId,
                        approvalStatus,
                        approvalLink
                    });
                    
                    // Upload images if any (don't fail the whole operation if images fail)
                    let imageUploadSuccess = true;
                    let imageUploadError = null;
                    if (selectedImages.length > 0 && expenseId) {
                        try {
                        await uploadExpenseImages(expenseId);
                            imageUploadSuccess = true;
                        } catch (error) {
                            console.error('Error uploading images:', error);
                            imageUploadSuccess = false;
                            imageUploadError = error.message || 'فشل رفع الصور';
                        }
                    }
                    
                    // ✅ عرض رابط الموافقة إذا كان المصروف في حالة pending
                    let successMessage = '';
                    if (approvalStatus === 'pending' && approvalLink) {
                        successMessage = `✅ تم حفظ المصروف بنجاح!<br><br>` +
                                      `⚠️ المصروف يحتاج موافقة المشرف (المبلغ > 50 ر.س)<br><br>` +
                                      `🔗 <a href="${approvalLink}" target="_blank" style="color: #007ACC; text-decoration: underline; font-weight: bold;">اضغط هنا للموافقة على المصروف</a><br><br>` +
                                      `📱 <button onclick="showWhatsAppModalForExpense('${approvalLink}', ${responseData.totalAmount || 0}, '${(responseData.hotelName || '').replace(/'/g, "\\'")}')" style="background: #25D366; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: 600; margin-top: 10px;"><i class="fab fa-whatsapp"></i> إرسال رابط الموافقة عبر WhatsApp</button>`;
                        if (!imageUploadSuccess && selectedImages.length > 0) {
                            successMessage += `<br><br>⚠️ <strong>ملاحظة:</strong> تم حفظ المصروف بنجاح، لكن فشل رفع الصور. يرجى المحاولة مرة أخرى لرفع الصور.`;
                        }
                        showNotificationWithHTML(successMessage, 'success');
                        
                        // ✅ أيضاً عرض رابط الموافقة في console للنسخ
                        console.log('🔗 Approval Link:', approvalLink);
                    } else if (approvalStatus === 'pending' && !approvalLink) {
                        // ✅ إذا كان pending لكن لا يوجد approvalLink، نعرض رسالة تحذير
                        console.warn('⚠️ Expense is pending but no approvalLink in response');
                        let msg = '✅ تم حفظ المصروف بنجاح! (في انتظار الموافقة - المبلغ > 50 ر.س)';
                        if (!imageUploadSuccess && selectedImages.length > 0) {
                            msg += '<br><br>⚠️ <strong>ملاحظة:</strong> تم حفظ المصروف بنجاح، لكن فشل رفع الصور. يرجى المحاولة مرة أخرى لرفع الصور.';
                        }
                        showNotification(msg, 'warning');
                    } else if (approvalStatus === 'auto-approved') {
                        let msg = '✅ تم حفظ المصروف بنجاح! (موافقة تلقائية - المبلغ ≤ 50 ر.س)';
                        if (!imageUploadSuccess && selectedImages.length > 0) {
                            msg += '<br><br>⚠️ <strong>ملاحظة:</strong> تم حفظ المصروف بنجاح، لكن فشل رفع الصور. يرجى المحاولة مرة أخرى لرفع الصور.';
                        }
                        showNotification(msg, 'success');
                    } else {
                        let msg = '✅ تم حفظ المصروف بنجاح!';
                        if (!imageUploadSuccess && selectedImages.length > 0) {
                            msg += '<br><br>⚠️ <strong>ملاحظة:</strong> تم حفظ المصروف بنجاح، لكن فشل رفع الصور. يرجى المحاولة مرة أخرى لرفع الصور.';
                        }
                        showNotification(msg, 'success');
                    }
                    
                    // ✅ Update visual stats after saving/updating expense
                    updateVisualStats();
                    
                    // If editing, reload expenses table and switch to it
                    if (isEditMode) {
                        // Clear edit mode
                        $('#expenseForm').removeData('editing-expense-id');
                        $('#expenseForm button[type="submit"]').html('<i class="fas fa-save"></i> إرسال المصروف');
                        
                        // Switch to all expenses tab and reload
                        $('.tab-btn[data-tab="all-expenses"]').click();
                    } else {
                        resetForm();
                    }
                } else {
                    const responseData = await response.json().catch(() => ({ message: 'فشل حفظ المصروف' }));
                    showNotification(`❌ خطأ: ${responseData.message || 'فشل حفظ المصروف'}`, 'error');
                }

            } catch (error) {
                console.error('Error submitting expense:', error);
                showNotification(`❌ خطأ: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        });

        // Reset Form
        function resetForm() {
            // Reset date picker to today
            try {
                if (typeof $.calendars !== 'undefined' && typeof $.calendars.instance !== 'undefined') {
                    const gregorianCalendar = $.calendars.instance();
                    const today = gregorianCalendar.today();
                    const todayFormatted = today.formatDate('yyyy-mm-dd');
                    
                    if (typeof $('#expenseDate').calendarsPicker === 'function') {
                        $('#expenseDate').calendarsPicker('setDate', today);
                    }
                    $('#expenseDate').val(todayFormatted);
                } else {
                    // Fallback: set today's date manually
                    const today = new Date();
                    const todayFormatted = today.toISOString().split('T')[0];
                    $('#expenseDate').val(todayFormatted);
                }
            } catch (error) {
                console.warn('⚠️ Warning resetting calendar date:', error);
                // Fallback: set today's date manually
                const today = new Date();
                const todayFormatted = today.toISOString().split('T')[0];
                $('#expenseDate').val(todayFormatted);
            }

            const categorySelect = $('#expenseCategorySelect');
            categorySelect.prop('selectedIndex', -1);
            categorySelect.val('').trigger('change');
            $('#expenseComment').val('');
            $('#totalAmount').val('');
            
            // Clear due date
            $('#dueDate').val('');

            // Clear expense rooms (no default row - user will add manually)
            $('#expenseRoomsBody').empty();
            expenseRoomRowCounter = 0;
            
            // Hide table if no apartments available
            if (apartments.length === 0) {
                $('#expenseRoomsTable').hide();
                $('#emptyRoomsMessage').show();
            } else {
                $('#expenseRoomsTable').show();
                $('#emptyRoomsMessage').hide();
            }

            // Clear images
            selectedImages = [];
            updateImagesPreview();
            $('#imageFiles').val('');
            
            // Clear edit mode
            $('#expenseForm').removeData('editing-expense-id');
            $('#expenseForm button[type="submit"]').html('<i class="fas fa-save"></i> إرسال المصروف');
            
            // Clear tax fields
            $('#includeTaxCheckbox').prop('checked', false);
            $('#taxInputGroup').hide();
            $('#taxAmount').val('');
            $('#taxInfo').hide();
        }

        // Load Tax Rate
        async function loadTaxRate() {
            if (!currentHotelCode) {
                return;
            }

            try {
                const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
                const authToken = localStorage.getItem('authToken');
                
                if (!currentHotelCode || !authToken) {
                    return;
                }
                
                const response = await fetch(`${API_BASE_URL}/api/Expense/tax-rate`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'X-Hotel-Code': currentHotelCode,
                        'Accept': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    taxRate = data.taxRate || 0;
                    if (taxRate > 0) {
                        console.log(`✅ Tax rate loaded: ${taxRate}% (Tax Name: ${data.taxName || 'N/A'}, Type: ${data.taxType || 'N/A'})`);
                    } else {
                        console.warn('⚠️ Tax rate is 0 or not found in database. Tax calculation will be disabled.');
                        console.warn('⚠️ Response data:', data);
                    }
                } else {
                    const errorText = await response.text();
                    console.error('❌ Failed to load tax rate:', response.status, errorText);
                    taxRate = 0;
                }
            } catch (error) {
                console.error('Error loading tax rate:', error);
                taxRate = 0;
            }
        }

        // Tax Calculation Functions
        function calculateTax() {
            const includeTax = $('#includeTaxCheckbox').is(':checked');
            const totalAmountInput = $('#totalAmount');
            const taxAmountInput = $('#taxAmount');
            const taxInfo = $('#taxInfo');
            const taxInputGroup = $('#taxInputGroup');
            
            const totalAmount = parseFloat(totalAmountInput.val()) || 0;
            
            // Hide tax input if checkbox is unchecked
            if (!includeTax) {
                taxInputGroup.hide();
                taxInfo.hide();
                return;
            }
            
            // Show tax input group when checkbox is checked (even if totalAmount is 0)
            taxInputGroup.show();
            
            // If total amount is 0, just show the input without calculation
            if (totalAmount <= 0) {
                taxAmountInput.val('');
                taxInfo.text('أدخل المبلغ الإجمالي أولاً لحساب الضريبة تلقائياً').show();
                return;
            }
            
            // If tax rate is loaded and > 0, calculate automatically
            if (taxRate > 0) {
                // Calculate: if total includes tax, calculate base and tax
                // Formula: base = total / (1 + taxRate/100)
                // tax = total - base
                const baseAmount = totalAmount / (1 + (taxRate / 100));
                const calculatedTax = totalAmount - baseAmount;
                
                taxAmountInput.val(calculatedTax.toFixed(2));
                const sarSymbol = '<span class="sar-symbol"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1124.14 1256.39"><path fill="#231f20" d="M699.62,1113.02h0c-20.06,44.48-33.32,92.75-38.4,143.37l424.51-90.24c20.06-44.47,33.31-92.75,38.4-143.37l-424.51,90.24Z"/><path fill="#231f20" d="M1085.73,895.8c20.06-44.47,33.32-92.75,38.4-143.37l-330.68,70.33v-135.2l292.27-62.11c20.06-44.47,33.32-92.75,38.4-143.37l-330.68,70.27V66.13c-50.67,28.45-95.67,66.32-132.25,110.99v403.35l-132.25,28.11V0c-50.67,28.44-95.67,66.32-132.25,110.99v525.69l-295.91,62.88c-20.06,44.47-33.33,92.75-38.42,143.37l334.33-71.05v170.26l-358.3,76.14c-20.06,44.47-33.32,92.75-38.4,143.37l375.04-79.7c30.53-6.35,56.77-24.4,73.83-49.24l68.78-101.97v-.02c7.14-10.55,11.3-23.27,11.3-36.97v-149.98l132.25-28.11v270.4l424.53-90.28Z"/></svg></span>';
                taxInfo.html(`المبلغ قبل الضريبة: ${baseAmount.toFixed(2)} ${sarSymbol} | نسبة الضريبة: ${taxRate}%`).show();
            } else {
                // Tax rate not loaded - show input but allow manual entry
                taxAmountInput.val('');
                taxInfo.text(`⚠️ لم يتم تحميل نسبة الضريبة من قاعدة البيانات. يمكنك إدخال قيمة الضريبة يدوياً.`).show();
                console.warn('⚠️ Tax rate not loaded (taxRate = 0). Tax input will be shown but calculation disabled.');
            }
        }

        // Load expense images for editing (silently, no popup)
        async function loadExpenseImagesForEdit(expenseId) {
            try {
                const headers = getApiHeaders();
                const response = await fetch(`${API_BASE_URL}/api/Expense/${expenseId}/images`, {
                    method: 'GET',
                    headers: headers
                });
                
                if (response.ok) {
                    const images = await response.json();
                    
                    if (images && images.length > 0) {
                        // Clear existing images
                        selectedImages = [];
                        
                        // Load images into selectedImages array
                        for (const image of images) {
                            const imageUrl = image.imageUrl || image.ImageUrl || image.image_path || image.url || image.Url;
                            if (imageUrl) {
                                const fullImageUrl = imageUrl.startsWith('http') ? imageUrl : `${API_BASE_URL}${imageUrl}`;
                                
                                // Fetch image and convert to File-like object
                                try {
                                    const imgResponse = await fetch(fullImageUrl);
                                    const blob = await imgResponse.blob();
                                    
                                    // Create a File object from blob
                                    const fileName = image.originalFilename || image.original_filename || `expense_${expenseId}_${Date.now()}.jpg`;
                                    const file = new File([blob], fileName, { type: blob.type });
                                    
                                    // Create data URL for preview
                                    const reader = new FileReader();
                                    reader.onload = function(e) {
                                        selectedImages.push({
                                            file: file,
                                            dataUrl: e.target.result,
                                            id: Date.now() + Math.random(),
                                            isExisting: true // ✅ Mark as existing image (already on server)
                                        });
                                        updateImagesPreview();
                                    };
                                    reader.readAsDataURL(file);
                                } catch (imgError) {
                                    console.log('Could not load image:', imageUrl);
                                    // Continue with other images - no popup
                                }
                            }
                        }
                    }
                }
                // Silently fail if images can't be loaded - no popup or warning
            } catch (error) {
                // Silently fail - no popup or warning
                console.log('Images not available for this expense or error loading:', error);
            }
        }

        // Loading Functions
        function showLoading() {
            $('#loadingOverlay').addClass('show');
        }

        function hideLoading() {
            $('#loadingOverlay').removeClass('show');
        }

        // Upload Expense Images
        async function uploadExpenseImages(expenseId) {
            if (selectedImages.length === 0 || !expenseId) {
                return { success: true };
            }

            try {
                // ✅ Check if we're in edit mode
                const isEditMode = $('#expenseForm').data('editing-expense-id') !== undefined && $('#expenseForm').data('editing-expense-id') !== null;
                
                // ✅ In edit mode, only upload NEW images (not existing ones that were already on server)
                // In create mode, upload all images
                const imagesToUpload = isEditMode 
                    ? selectedImages.filter(img => !img.isExisting) // Only new images in edit mode
                    : selectedImages; // All images in create mode
                
                if (imagesToUpload.length === 0) {
                    console.log('✅ No new images to upload (all images are existing)');
                    return { success: true };
                }

                const formData = new FormData();
                // Append only new images with proper name format for IFormFileCollection
                imagesToUpload.forEach((image) => {
                    formData.append('images', image.file);
                });

                // ✅ الحصول على tenantCode من userInfo (من JWT Token)
                const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
                const authToken = localStorage.getItem('authToken');
                
                if (!currentHotelCode || !authToken) {
                    console.error('⚠️ Missing authentication');
                    throw new Error('Missing authentication');
                }
                
                // ✅ SECURITY: التأكد من أن currentHotelCode يطابق tenantCode من JWT Token
                if (currentHotelCode !== userInfo.tenantCode) {
                    console.error(`⚠️ SECURITY: Hotel code mismatch. Current: ${currentHotelCode}, Expected: ${userInfo.tenantCode}`);
                    throw new Error('Hotel code mismatch');
                }
                
                const response = await fetch(`${API_BASE_URL}/api/Expense/${expenseId}/images`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`, // ✅ إضافة JWT Token
                        'X-Hotel-Code': currentHotelCode
                        // Don't set Content-Type - browser will set it with boundary for FormData
                    },
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('✅ Images uploaded successfully:', result);
                    return { success: true };
                } else {
                    const errorText = await response.text();
                    console.warn('⚠️ Failed to upload images:', response.status, errorText);
                    throw new Error(`Failed to upload images: ${response.status} - ${errorText}`);
                }
            } catch (error) {
                console.error('Error uploading images:', error);
                throw error; // Re-throw to be caught by caller
            }
        }

        // Notification function
        function showNotification(message, type = 'info') {
            // Simple alert for now - can be replaced with better notification system
            const bgColor = type === 'success' ? '#28A745' : type === 'error' ? '#DC3545' : type === 'warning' ? '#FF9800' : '#007ACC';
            const notification = $(`
                <div style="position: fixed; top: 20px; right: 20px; background: ${bgColor}; color: white; padding: 12px 20px; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 10000; animation: slideInRight 0.3s ease-out; max-width: 400px;">
                    ${message}
                </div>
            `);
            $('body').append(notification);
            setTimeout(() => {
                notification.fadeOut(300, function() {
                    $(this).remove();
                });
            }, 5000); // زيادة الوقت إلى 5 ثواني
        }

        // Notification function with HTML support (for links)
        function showNotificationWithHTML(htmlMessage, type = 'info') {
            const bgColor = type === 'success' ? '#28A745' : type === 'error' ? '#DC3545' : type === 'warning' ? '#FF9800' : '#007ACC';
            const notification = $(`
                <div style="position: fixed; top: 20px; right: 20px; background: ${bgColor}; color: white; padding: 15px 20px; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 10000; animation: slideInRight 0.3s ease-out; max-width: 500px; line-height: 1.6;">
                    ${htmlMessage}
                </div>
            `);
            $('body').append(notification);
            // زيادة الوقت إلى 10 ثواني للرسائل التي تحتوي على روابط
            setTimeout(() => {
                notification.fadeOut(300, function() {
                    $(this).remove();
                });
            }, 10000);
        }

        // ✅ WhatsApp Modal Functions for expenses.html
        function showWhatsAppModalForExpense(approvalLink, amount, hotelName) {
            // إنشاء modal بسيط
            const modal = `
                <div id="whatsappModalExpense" style="display: flex; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center;">
                    <div style="background: white; padding: 25px; border-radius: 8px; max-width: 500px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #E0E0E0;">
                            <h3 style="margin: 0; color: #007ACC; font-size: 20px;">
                                <i class="fab fa-whatsapp" style="color: #25D366;"></i> إرسال رابط الموافقة عبر WhatsApp
                            </h3>
                            <button onclick="closeWhatsAppModalExpense()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 5px;">رقم هاتف المشرف:</label>
                            <input type="text" id="supervisorPhoneExpense" placeholder="966XXXXXXXXX" maxlength="15" style="width: 100%; padding: 10px; border: 1px solid #E0E0E0; border-radius: 4px; font-size: 14px; box-sizing: border-box;" />
                            <small style="color: #666; font-size: 12px;">أدخل الرقم مع كود الدولة (مثال: 966541997799)</small>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 5px;">الرسالة:</label>
                            <textarea id="whatsappMessageExpense" readonly style="width: 100%; padding: 10px; border: 1px solid #E0E0E0; border-radius: 4px; font-size: 14px; min-height: 100px; resize: vertical; direction: rtl; box-sizing: border-box;"></textarea>
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button onclick="copyMessageExpense()" style="background: #007ACC; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                <i class="fas fa-copy"></i> نسخ الرسالة
                            </button>
                            <button onclick="sendWhatsAppMessageExpense('${approvalLink}', ${amount}, '${hotelName.replace(/'/g, "\\'")}')" style="background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                <i class="fab fa-whatsapp"></i> إرسال عبر WhatsApp
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            $('body').append(modal);
            
            // تعبئة الرسالة
            const date = new Date().toLocaleDateString('ar-SA', { year: 'numeric', month: 'long', day: 'numeric', calendar: 'gregory' });
            const message = `مرحباً،

يوجد مصروف يحتاج موافقتك:

🏨 الفندق: ${hotelName || 'غير محدد'}
💰 المبلغ: ${parseFloat(amount || 0).toFixed(2)} ر.س
📅 التاريخ: ${date}

🔗 رابط الموافقة:
${approvalLink}

يرجى مراجعة المصروف والموافقة عليه أو رفضه.

شكراً لك.`;
            
            $('#whatsappMessageExpense').val(message);
        }

        function closeWhatsAppModalExpense() {
            $('#whatsappModalExpense').remove();
        }

        function copyMessageExpense() {
            const message = $('#whatsappMessageExpense').val();
            navigator.clipboard.writeText(message).then(() => {
                showNotification('✅ تم نسخ الرسالة بنجاح!', 'success');
            }).catch(() => {
                const textArea = $('<textarea>').val(message).appendTo('body').select();
                document.execCommand('copy');
                textArea.remove();
                showNotification('✅ تم نسخ الرسالة بنجاح!', 'success');
            });
        }

        async function sendWhatsAppMessageExpense(approvalLink, amount, hotelName) {
            const phone = $('#supervisorPhoneExpense').val().trim();
            const message = $('#whatsappMessageExpense').val();

            if (!phone) {
                showNotification('⚠️ يرجى إدخال رقم هاتف المشرف', 'error');
                return;
            }

            // const phoneRegex = /^966\d{9}$/;
            // if (!phoneRegex.test(phone)) {
            //     showNotification('⚠️ رقم الهاتف غير صحيح. يجب أن يكون بصيغة: 966XXXXXXXXX', 'error');
            //     return;
            // }

            try {
                showLoading();

                // ✅ SECURITY: Use backend endpoint instead of direct API call
                const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
                const authToken = localStorage.getItem('authToken');
                
                if (!authToken) {
                    showNotification('⚠️ يرجى تسجيل الدخول أولاً', 'error');
                    hideLoading();
                    return;
                }

                console.log('📤 Sending WhatsApp message to:', phone);

                // Call backend endpoint
                const response = await fetch(`${API_BASE_URL}/api/WhatsApp/send`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        phoneNumber: phone,
                        message: message
                    })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showNotification('✅ تم إرسال الرسالة بنجاح عبر WhatsApp!', 'success');
                    closeWhatsAppModalExpense();
                } else {
                    const errorMsg = result.error || 'خطأ غير معروف';
                    showNotification(`❌ فشل إرسال الرسالة: ${errorMsg}`, 'error');
                }
            } catch (error) {
                console.error('Error sending WhatsApp message:', error);
                showNotification(`❌ خطأ في إرسال الرسالة: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        // Initialize empty state
        $(document).ready(function() {
            $('#expenseRoomsTable').hide();
            $('#emptyRoomsMessage').show();
            $('#emptyImagesMessage').show();
            
            // Initialize tabs
            initializeTabs();
            
            // Initialize tax checkbox handler
            $('#includeTaxCheckbox').on('change', function() {
                console.log('✅ Tax checkbox changed:', $(this).is(':checked'));
                calculateTax();
            });
            
            // ✅ When user manually changes totalAmount, don't auto-update from rooms
            // But still calculate tax if checkbox is checked
            $('#totalAmount').on('input', function() {
                if ($('#includeTaxCheckbox').is(':checked')) {
                    calculateTax();
                }
            });
            
            // Also trigger calculation when tax amount input changes (for manual entry)
            $(document).on('input', '#taxAmount', function() {
                // Allow manual entry - don't recalculate if user is typing
            });
            
            // ✅ Add event delegation for dynamically added amount inputs
            $(document).on('input', '.amount-input', function() {
                calculateTotalFromRooms();
            });
        });

        // ==================== Tabs Functionality ====================
        function initializeTabs() {
            $('.tab-btn').on('click', function() {
                const targetTab = $(this).data('tab');
                
                // Remove active class from all tabs and contents
                $('.tab-btn').removeClass('active');
                $('.tab-content').removeClass('active');
                
                // Add active class to clicked tab and corresponding content
                $(this).addClass('active');
                $(`#${targetTab}-tab`).addClass('active');
                
                // Load expenses when switching to all-expenses tab
                if (targetTab === 'all-expenses') {
                    // Initialize filter datepickers if not already initialized
                    if (!$('#filterDateFrom').hasClass('calendar-initialized')) {
                        waitForCalendars(function() {
                            initializeFilterDatePickers();
                        });
                    }
                    loadAllExpenses();
                }
            });
        }
        
        // ==================== Initialize Filter Date Pickers ====================
        function initializeFilterDatePickers() {
            try {
                if (typeof $.calendars === 'undefined' || typeof $.calendars.instance === 'undefined') {
                    console.warn('⚠️ Calendars not loaded, using HTML5 date inputs');
                    $('#filterDateFrom').attr('type', 'date');
                    $('#filterDateTo').attr('type', 'date');
                    // Set default dates (first and last day of current month)
                    const now = new Date();
                    const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
                    const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    $('#filterDateFrom').val(firstDay.toISOString().split('T')[0]);
                    $('#filterDateTo').val(lastDay.toISOString().split('T')[0]);
                    return;
                }
                
                const gregorianCalendar = $.calendars.instance();
                
                // Get first and last day of current month
                const now = new Date();
                const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
                const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                
                const firstDayCal = gregorianCalendar.fromJSDate(firstDay);
                const lastDayCal = gregorianCalendar.fromJSDate(lastDay);
                
                const firstDayFormatted = firstDayCal.formatDate('yyyy-mm-dd');
                const lastDayFormatted = lastDayCal.formatDate('yyyy-mm-dd');
                
                // Initialize date picker for "From" date
                $('#filterDateFrom').calendarsPicker({
                    calendar: gregorianCalendar,
                    dateFormat: 'yyyy-mm-dd',
                    showOnFocus: true,
                    defaultDate: firstDayCal,
                    onSelect: function(dates) {
                        if (dates && dates.length > 0 && dates[0]) {
                            const selectedDate = dates[0].formatDate('yyyy-mm-dd');
                            $('#filterDateFrom').val(selectedDate);
                        }
                    }
                });
                $('#filterDateFrom').val(firstDayFormatted);
                $('#filterDateFrom').addClass('calendar-initialized');
                
                // Initialize date picker for "To" date
                $('#filterDateTo').calendarsPicker({
                    calendar: gregorianCalendar,
                    dateFormat: 'yyyy-mm-dd',
                    showOnFocus: true,
                    defaultDate: lastDayCal,
                    onSelect: function(dates) {
                        if (dates && dates.length > 0 && dates[0]) {
                            const selectedDate = dates[0].formatDate('yyyy-mm-dd');
                            $('#filterDateTo').val(selectedDate);
                        }
                    }
                });
                $('#filterDateTo').val(lastDayFormatted);
                $('#filterDateTo').addClass('calendar-initialized');
                
                console.log('✅ Filter date pickers initialized');
            } catch (error) {
                console.error('❌ Error initializing filter date pickers:', error);
                // Fallback to HTML5 date inputs
                $('#filterDateFrom').attr('type', 'date');
                $('#filterDateTo').attr('type', 'date');
                const now = new Date();
                const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
                const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                $('#filterDateFrom').val(firstDay.toISOString().split('T')[0]);
                $('#filterDateTo').val(lastDay.toISOString().split('T')[0]);
            }
        }
        
        // ==================== Date Filter Function ====================
        let dateFilterFrom = null;
        let dateFilterTo = null;
        
        function applyDateFilter() {
            const fromDate = $('#filterDateFrom').val();
            const toDate = $('#filterDateTo').val();
            
            if (!fromDate || !toDate) {
                showNotification('⚠️ يرجى اختيار تاريخ البداية والنهاية', 'warning');
                return;
            }
            
            // Convert dates to Date objects for comparison
            const from = new Date(fromDate + 'T00:00:00');
            const to = new Date(toDate + 'T23:59:59');
            
            if (from > to) {
                showNotification('⚠️ تاريخ البداية يجب أن يكون قبل تاريخ النهاية', 'warning');
                return;
            }
            
            dateFilterFrom = fromDate;
            dateFilterTo = toDate;
            
            showNotification('✅ تم تطبيق التصفية بنجاح', 'success');
            loadAllExpenses();
        }
        
        // ==================== Export Functions ====================
        function exportToPDF() {
            try {
                const table = document.getElementById('expensesTable');
                if (!table) {
                    showNotification('⚠️ لا توجد بيانات للتصدير', 'warning');
                    return;
                }
                
                const rows = table.querySelectorAll('tbody tr');
                if (rows.length === 0 || (rows.length === 1 && rows[0].querySelector('.empty-expenses'))) {
                    showNotification('⚠️ لا توجد بيانات للتصدير', 'warning');
                    return;
                }
                
                // Check if jsPDF is loaded
                if (typeof window.jspdf === 'undefined') {
                    showNotification('⚠️ مكتبة PDF غير محملة. يرجى إعادة تحميل الصفحة', 'error');
                    return;
                }
                
                showLoading();
                
                // Get hotel name from userInfo
                const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
                const hotelName = userInfo.tenantName || userInfo.tenantCode || 'غير محدد';
                
                // Format print date in Gregorian
                const printDate = new Date();
                const printDateFormatted = printDate.toLocaleDateString('en-GB', { 
                    year: 'numeric', 
                    month: '2-digit', 
                    day: '2-digit' 
                });
                
                // Format date range if filters are applied
                let dateRangeText = '';
                if (dateFilterFrom && dateFilterTo) {
                    const fromDate = new Date(dateFilterFrom);
                    const toDate = new Date(dateFilterTo);
                    const fromFormatted = fromDate.toLocaleDateString('en-GB', { 
                        year: 'numeric', 
                        month: '2-digit', 
                        day: '2-digit' 
                    });
                    const toFormatted = toDate.toLocaleDateString('en-GB', { 
                        year: 'numeric', 
                        month: '2-digit', 
                        day: '2-digit' 
                    });
                    dateRangeText = `الفترة: من ${fromFormatted} إلى ${toFormatted}`;
                }
                
                // Clone table and prepare for printing
                const tableClone = table.cloneNode(true);
                
                // Remove SAR symbol from amount cells
                const amountCells = tableClone.querySelectorAll('tbody tr td:nth-child(4)');
                amountCells.forEach(cell => {
                    const sarSymbols = cell.querySelectorAll('.sar-symbol, svg');
                    sarSymbols.forEach(el => el.remove());
                });
                
                // Remove action buttons/icons and images column
                const actionCells = tableClone.querySelectorAll('td:last-child');
                actionCells.forEach(cell => {
                    const buttons = cell.querySelectorAll('button, svg, .action-btn, .image-link-label');
                    buttons.forEach(btn => btn.remove());
                });
                
                const imageCells = tableClone.querySelectorAll('tbody tr td:nth-last-child(2)');
                imageCells.forEach(cell => {
                    const links = cell.querySelectorAll('a, svg, .image-link-label');
                    links.forEach(link => link.remove());
                });
                
                // Remove action and images column headers
                const headerRow = tableClone.querySelector('thead tr');
                if (headerRow) {
                    const headers = headerRow.querySelectorAll('th');
                    if (headers.length > 0) headers[headers.length - 1].remove();
                    if (headers.length > 1) headers[headers.length - 2].remove();
                }
                
                // Remove action and images columns from all rows
                const allRows = tableClone.querySelectorAll('tbody tr');
                allRows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length > 0) cells[cells.length - 1].remove();
                    if (cells.length > 1) cells[cells.length - 2].remove();
                });
                
                // Create a temporary container for the PDF content
                const printContainer = document.createElement('div');
                printContainer.style.position = 'absolute';
                printContainer.style.left = '-9999px';
                printContainer.style.width = '297mm'; // A4 landscape width
                printContainer.style.padding = '20px';
                printContainer.style.backgroundColor = 'white';
                printContainer.style.fontFamily = "'Cairo', Arial, sans-serif";
                printContainer.style.direction = 'rtl';
                printContainer.innerHTML = `
                    <style>
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-family: 'Cairo', Arial, sans-serif; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: right; font-size: 12px; }
                        th { background-color: #007ACC; color: white; font-weight: 600; }
                        tr:nth-child(even) { background-color: #f9f9f9; }
                    </style>
                    <h1 style="text-align: center; color: #333; margin-bottom: 10px; font-size: 24px; font-family: 'Cairo', Arial, sans-serif;">تقرير المصروفات</h1>
                    <div style="text-align: center; color: #666; margin-bottom: 20px; font-size: 14px; font-family: 'Cairo', Arial, sans-serif;">
                        <p style="margin: 5px 0;"><strong>الفندق:</strong> ${hotelName}</p>
                        <p style="margin: 5px 0;"><strong>تاريخ الطباعة:</strong> ${printDateFormatted}</p>
                        ${dateRangeText ? `<p style="margin: 5px 0;">${dateRangeText}</p>` : ''}
                    </div>
                    ${tableClone.outerHTML}
                `;
                
                document.body.appendChild(printContainer);
                
                // Use html2canvas to capture the content
                if (typeof html2canvas !== 'undefined') {
                    html2canvas(printContainer, {
                        scale: 2,
                        useCORS: true,
                        logging: false,
                        backgroundColor: '#ffffff'
                    }).then(canvas => {
                        const imgData = canvas.toDataURL('image/png');
                        const { jsPDF } = window.jspdf;
                        const doc = new jsPDF('l', 'mm', 'a4');
                        
                        const imgWidth = doc.internal.pageSize.getWidth();
                        const imgHeight = (canvas.height * imgWidth) / canvas.width;
                        
                        let heightLeft = imgHeight;
                        let position = 0;
                        
                        doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= doc.internal.pageSize.getHeight();
                        
                        while (heightLeft > 0) {
                            position = heightLeft - imgHeight;
                            doc.addPage();
                            doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                            heightLeft -= doc.internal.pageSize.getHeight();
                        }
                        
                        const fileName = `expenses_${new Date().toISOString().split('T')[0]}.pdf`;
                        doc.save(fileName);
                        
                        document.body.removeChild(printContainer);
                        hideLoading();
                        showNotification('✅ تم تصدير البيانات إلى PDF بنجاح', 'success');
                    }).catch(error => {
                        document.body.removeChild(printContainer);
                        hideLoading();
                        console.error('Error with html2canvas:', error);
                        showNotification('❌ خطأ في تصدير PDF: ' + error.message, 'error');
                    });
                } else {
                    // Fallback to original method if html2canvas is not available
                    document.body.removeChild(printContainer);
                    hideLoading();
                    showNotification('⚠️ مكتبة html2canvas غير محملة. يرجى إعادة تحميل الصفحة', 'error');
                }
            } catch (error) {
                hideLoading();
                console.error('Error exporting to PDF:', error);
                showNotification('❌ خطأ في تصدير PDF: ' + error.message, 'error');
            }
        }
        
        function exportToExcel() {
            try {
                const table = document.getElementById('expensesTable');
                if (!table) {
                    showNotification('⚠️ لا توجد بيانات للتصدير', 'warning');
                    return;
                }
                
                // Get all expenses data
                const rows = table.querySelectorAll('tbody tr');
                if (rows.length === 0 || (rows.length === 1 && rows[0].querySelector('.empty-expenses'))) {
                    showNotification('⚠️ لا توجد بيانات للتصدير', 'warning');
                    return;
                }
                
                // Check if XLSX is loaded
                if (typeof XLSX === 'undefined') {
                    showNotification('⚠️ مكتبة Excel غير محملة. يرجى إعادة تحميل الصفحة', 'error');
                    return;
                }
                
                // Get hotel name from userInfo
                const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
                const hotelName = userInfo.tenantName || userInfo.tenantCode || 'غير محدد';
                
                // Format print date in Gregorian
                const printDate = new Date();
                const printDateFormatted = printDate.toLocaleDateString('en-GB', { 
                    year: 'numeric', 
                    month: '2-digit', 
                    day: '2-digit' 
                });
                
                // Prepare data array
                const data = [];
                
                // Add header row
                data.push(['رقم المصروف', 'التاريخ', 'فئة المصروف', 'المبلغ الإجمالي', 'حالة الموافقة', 'الملاحظات']);
                
                // Add data rows - extract clean text without HTML/SVG
                rows.forEach(row => {
                    if (row.querySelector('.empty-expenses')) return;
                    
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 6) {
                        // Extract text content, removing HTML tags and SVG
                        const expenseId = cells[0].textContent.trim().replace(/#/g, '');
                        const date = cells[1].textContent.trim();
                        const category = cells[2].textContent.trim();
                        // Extract amount without SAR symbol SVG
                        const amountCell = cells[3].cloneNode(true);
                        amountCell.querySelectorAll('.sar-symbol, svg').forEach(el => el.remove());
                        const amount = amountCell.textContent.trim().replace(/ر\.س/g, '').trim();
                        // Extract status text without SVG icons
                        const statusCell = cells[4].cloneNode(true);
                        statusCell.querySelectorAll('svg').forEach(svg => svg.remove());
                        const status = statusCell.textContent.trim();
                        const notes = cells[5]?.textContent.trim() || '-';
                        
                        data.push([expenseId, date, category, amount, status, notes]);
                    }
                });
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(data);
                
                // Set column widths
                ws['!cols'] = [
                    { wch: 15 }, // رقم المصروف
                    { wch: 15 }, // التاريخ
                    { wch: 30 }, // فئة المصروف
                    { wch: 18 }, // المبلغ الإجمالي
                    { wch: 20 }, // حالة الموافقة
                    { wch: 40 }  // الملاحظات
                ];
                
                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(wb, ws, 'المصروفات');
                
                // Add info sheet
                const infoData = [
                    ['تقرير المصروفات'],
                    [''],
                    ['الفندق:', hotelName],
                    ['تاريخ التصدير:', printDateFormatted]
                ];
                
                if (dateFilterFrom && dateFilterTo) {
                    const fromDate = new Date(dateFilterFrom);
                    const toDate = new Date(dateFilterTo);
                    const fromFormatted = fromDate.toLocaleDateString('en-GB', { 
                        year: 'numeric', 
                        month: '2-digit', 
                        day: '2-digit' 
                    });
                    const toFormatted = toDate.toLocaleDateString('en-GB', { 
                        year: 'numeric', 
                        month: '2-digit', 
                        day: '2-digit' 
                    });
                    infoData.push(['الفترة:', `من ${fromFormatted} إلى ${toFormatted}`]);
                }
                
                const infoWs = XLSX.utils.aoa_to_sheet(infoData);
                XLSX.utils.book_append_sheet(wb, infoWs, 'معلومات التقرير');
                
                // Generate file and download
                const fileName = `expenses_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showNotification('✅ تم تصدير البيانات إلى Excel بنجاح', 'success');
            } catch (error) {
                console.error('Error exporting to Excel:', error);
                showNotification('❌ خطأ في تصدير Excel: ' + error.message, 'error');
            }
        }
        
        function printExpenses() {
            try {
                const table = document.getElementById('expensesTable');
                if (!table) {
                    showNotification('⚠️ لا توجد بيانات للطباعة', 'warning');
                    return;
                }
                
                const rows = table.querySelectorAll('tbody tr');
                if (rows.length === 0 || (rows.length === 1 && rows[0].querySelector('.empty-expenses'))) {
                    showNotification('⚠️ لا توجد بيانات للطباعة', 'warning');
                    return;
                }
                
                // Get hotel name from userInfo
                const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
                const hotelName = userInfo.tenantName || userInfo.tenantCode || 'غير محدد';
                
                // Format print date in Gregorian
                const printDate = new Date();
                const printDateFormatted = printDate.toLocaleDateString('en-GB', { 
                    year: 'numeric', 
                    month: '2-digit', 
                    day: '2-digit' 
                });
                
                // Format date range if filters are applied - get directly from input fields
                let dateRangeText = '';
                const filterDateFromValue = $('#filterDateFrom').val();
                const filterDateToValue = $('#filterDateTo').val();
                
                if (filterDateFromValue && filterDateToValue) {
                    const fromDate = new Date(filterDateFromValue + 'T00:00:00');
                    const toDate = new Date(filterDateToValue + 'T00:00:00');
                    // ✅ Format dates in Gregorian calendar (en-GB format: DD/MM/YYYY)
                    const fromFormatted = fromDate.toLocaleDateString('en-GB', { 
                        year: 'numeric', 
                        month: '2-digit', 
                        day: '2-digit' 
                    });
                    const toFormatted = toDate.toLocaleDateString('en-GB', { 
                        year: 'numeric', 
                        month: '2-digit', 
                        day: '2-digit' 
                    });
                    dateRangeText = `<p style="text-align: center; color: #666; margin: 5px 0; font-weight: 600;"><strong>من تاريخ:</strong> ${fromFormatted} <strong>إلى تاريخ:</strong> ${toFormatted}</p>`;
                }
                
                // Clone table and remove action buttons/icons and images column
                const tableClone = table.cloneNode(true);
                
                // Remove SAR symbol from amount cells (5th column - المبلغ الإجمالي, after adding DueDate column)
                const amountCells = tableClone.querySelectorAll('tbody tr td:nth-child(5)');
                amountCells.forEach(cell => {
                    // Remove SAR symbol SVG elements and keep only the amount text
                    const sarSymbols = cell.querySelectorAll('.sar-symbol, svg');
                    sarSymbols.forEach(el => el.remove());
                    // Also remove any span wrapper if it only contains the symbol
                    const textContent = cell.textContent.trim();
                    // Keep only numeric value with decimal point
                    const amountMatch = textContent.match(/[\d.]+/);
                    if (amountMatch) {
                        cell.innerHTML = `<strong>${amountMatch[0]}</strong>`;
                    }
                });
                
                // Remove action buttons/icons from all action cells
                const actionCells = tableClone.querySelectorAll('td:last-child');
                actionCells.forEach(cell => {
                    // Remove all buttons and SVG icons from actions column
                    const buttons = cell.querySelectorAll('button, svg, .action-btn, .image-link-label');
                    buttons.forEach(btn => btn.remove());
                });
                
                // Remove images column (second to last column)
                const imageCells = tableClone.querySelectorAll('tbody tr td:nth-last-child(2)');
                imageCells.forEach(cell => {
                    // Remove all links and SVG icons from images column
                    const links = cell.querySelectorAll('a, svg, .image-link-label');
                    links.forEach(link => link.remove());
                });
                
                // Remove action column header and images column header
                const headerRow = tableClone.querySelector('thead tr');
                if (headerRow) {
                    const headers = headerRow.querySelectorAll('th');
                    // Remove last header (الإجراءات)
                    if (headers.length > 0) {
                        headers[headers.length - 1].remove();
                    }
                    // Remove second to last header (الصور)
                    if (headers.length > 1) {
                        headers[headers.length - 2].remove();
                    }
                }
                
                // Remove action and images columns from all rows
                const allRows = tableClone.querySelectorAll('tbody tr');
                allRows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    // Remove last cell (actions)
                    if (cells.length > 0) {
                        cells[cells.length - 1].remove();
                    }
                    // Remove second to last cell (images)
                    if (cells.length > 1) {
                        cells[cells.length - 2].remove();
                    }
                });
                
                // Create print window
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html dir="rtl" lang="ar">
                    <head>
                        <meta charset="UTF-8">
                        <title>طباعة المصروفات</title>
                        <style>
                            body { font-family: 'Cairo', Arial, sans-serif; padding: 20px; direction: rtl; }
                            h1 { text-align: center; color: #333; margin-bottom: 10px; }
                            .print-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
                            .print-date { text-align: left; color: #666; font-size: 14px; }
                            .print-info { text-align: center; color: #666; margin-bottom: 20px; }
                            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                            th, td { border: 1px solid #ddd; padding: 8px; text-align: right; }
                            th { background-color: #007ACC; color: white; font-weight: 600; }
                            tr:nth-child(even) { background-color: #f9f9f9; }
                            @media print { body { padding: 0; } }
                        </style>
                    </head>
                    <body>
                        <div class="print-header">
                            <div class="print-date">
                                <p style="margin: 0;"><strong>تاريخ الطباعة:</strong> ${printDateFormatted}</p>
                            </div>
                            <div style="flex: 1;"></div>
                        </div>
                        <h1>تقرير المصروفات</h1>
                        <div class="print-info">
                            <p style="margin: 5px 0;"><strong>الفندق:</strong> ${hotelName}</p>
                            ${dateRangeText}
                        </div>
                        ${tableClone.outerHTML}
                    </body>
                    </html>
                `);
                printWindow.document.close();
                printWindow.focus();
                setTimeout(() => {
                    printWindow.print();
                    printWindow.close();
                }, 250);
            } catch (error) {
                console.error('Error printing expenses:', error);
                showNotification('❌ خطأ في الطباعة', 'error');
            }
        }
        
        // ==================== Update Visual Stats ====================
        async function updateVisualStats() {
            try {
                const headers = getApiHeaders();
                const response = await fetch(`${API_BASE_URL}/api/Expense`, {
                    method: 'GET',
                    headers: headers
                });
                
                if (response.ok) {
                    const expenses = await response.json();
                    updateVisualStatsFromExpenses(expenses);
                }
            } catch (error) {
                console.error('Error updating visual stats:', error);
            }
        }
        
        function updateVisualStatsFromExpenses(expenses) {
            if (!expenses || !Array.isArray(expenses)) {
                return;
            }
            
            // Get current month start and end dates
            const now = new Date();
            const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            lastDayOfMonth.setHours(23, 59, 59, 999);
            
            // Filter expenses for current month
            const monthlyExpenses = expenses.filter(expense => {
                const expenseDate = new Date(expense.dateTime || expense.DateTime || expense.date_time);
                return expenseDate >= firstDayOfMonth && expenseDate <= lastDayOfMonth;
            });
            
            // Calculate monthly total
            const monthlyTotal = monthlyExpenses.reduce((sum, expense) => {
                return sum + (parseFloat(expense.totalAmount || expense.TotalAmount || expense.total_amount || 0));
            }, 0);
            
            // Count pending expenses
            const pendingCount = expenses.filter(expense => {
                const status = (expense.approvalStatus || expense.ApprovalStatus || expense.approval_status || '').toLowerCase();
                return status === 'pending';
            }).length;
            
            // Count rejected expenses
            const rejectedCount = expenses.filter(expense => {
                const status = (expense.approvalStatus || expense.ApprovalStatus || expense.approval_status || '').toLowerCase();
                return status === 'rejected';
            }).length;
            
            // Update UI
            const sarSymbol = '<span class="sar-symbol"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1124.14 1256.39"><path fill="#231f20" d="M699.62,1113.02h0c-20.06,44.48-33.32,92.75-38.4,143.37l424.51-90.24c20.06-44.47,33.31-92.75,38.4-143.37l-424.51,90.24Z"/><path fill="#231f20" d="M1085.73,895.8c20.06-44.47,33.32-92.75,38.4-143.37l-330.68,70.33v-135.2l292.27-62.11c20.06-44.47,33.32-92.75,38.4-143.37l-330.68,70.27V66.13c-50.67,28.45-95.67,66.32-132.25,110.99v403.35l-132.25,28.11V0c-50.67,28.44-95.67,66.32-132.25,110.99v525.69l-295.91,62.88c-20.06,44.47-33.33,92.75-38.42,143.37l334.33-71.05v170.26l-358.3,76.14c-20.06,44.47-33.32,92.75-38.4,143.37l375.04-79.7c30.53-6.35,56.77-24.4,73.83-49.24l68.78-101.97v-.02c7.14-10.55,11.3-23.27,11.3-36.97v-149.98l132.25-28.11v270.4l424.53-90.28Z"/></svg></span>';
            $('#statMonthlyExpenses strong').html(`${monthlyTotal.toFixed(2)} ${sarSymbol}`);
            $('#statPendingExpenses strong').text(`${pendingCount} معلّقة`);
            $('#statRejectedExpenses strong').text(`${rejectedCount} مرفوضة`);
        }

        // ==================== Pagination Variables ====================
        let currentPage = 1;
        const itemsPerPage = 25;
        let allExpensesData = [];
        
        // Track read notifications
        let readNotifications = JSON.parse(localStorage.getItem('readNotifications') || '[]');
        
        // ==================== Get API Headers Helper ====================
        function getApiHeaders() {
            const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
            const authToken = localStorage.getItem('authToken');
            
            if (!currentHotelCode || !authToken) {
                throw new Error('No hotel selected or not authenticated');
            }
            
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`,
                'X-Hotel-Code': currentHotelCode
            };
        }

        // ==================== Load All Expenses ====================
        async function loadAllExpenses() {
            const tbody = document.getElementById('expensesTableBody');
            
            try {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-expenses"><svg class="spinner-svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10" stroke-opacity="0.25"></circle><path d="M12 2 A10 10 0 0 1 22 12" stroke-linecap="round"></path></svg><p>جاري التحميل...</p></td></tr>';
                
                const headers = getApiHeaders();
                let url = `${API_BASE_URL}/api/Expense`;
                
                // Add date filter parameters if set
                if (dateFilterFrom && dateFilterTo) {
                    url += `?fromDate=${dateFilterFrom}&toDate=${dateFilterTo}`;
                }
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: headers
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load expenses');
                }
                
                let expenses = await response.json();
                
                // Client-side filtering if API doesn't support date filtering
                if (dateFilterFrom && dateFilterTo && expenses && Array.isArray(expenses)) {
                    const from = new Date(dateFilterFrom + 'T00:00:00');
                    const to = new Date(dateFilterTo + 'T23:59:59');
                    
                    expenses = expenses.filter(expense => {
                        const expenseDate = new Date(expense.dateTime || expense.DateTime || expense.date_time);
                        return expenseDate >= from && expenseDate <= to;
                    });
                }
                
                // Store all expenses data
                allExpensesData = expenses || [];
                
                if (!allExpensesData || allExpensesData.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="empty-expenses">
                                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="color: #d1d5db; margin-bottom: 16px;">
                                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                                </svg>
                                <h3>لا توجد مصروفات</h3>
                                <p>لم يتم إضافة أي مصروفات بعد</p>
                            </td>
                        </tr>
                    `;
                    document.getElementById('expensesPagination').style.display = 'none';
                    return;
                }
                
                // Reset to first page when loading new data
                currentPage = 1;
                
                // Render expenses with pagination
                renderExpensesWithPagination();
                
                // ✅ Update visual stats after loading expenses
                updateVisualStatsFromExpenses(allExpensesData);
                
                // Update notification count
                updateNotificationCount();
                
            } catch (error) {
                console.error('Error loading expenses:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-expenses">
                            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="color: #f59e0b; margin-bottom: 16px;">
                                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                                <line x1="12" y1="9" x2="12" y2="13"></line>
                                <line x1="12" y1="17" x2="12.01" y2="17"></line>
                            </svg>
                            <h3>خطأ في التحميل</h3>
                            <p>${error.message}</p>
                        </td>
                    </tr>
                `;
                document.getElementById('expensesPagination').style.display = 'none';
                showNotification(`❌ خطأ في تحميل المصروفات: ${error.message}`, 'error');
            }
        }
        
        // ==================== Render Expenses with Pagination ====================
        function renderExpensesWithPagination() {
            const tbody = document.getElementById('expensesTableBody');
            tbody.innerHTML = '';
            
            // Sort expenses by expenseId descending (newest first)
            const sortedExpenses = [...allExpensesData].sort((a, b) => {
                const idA = a.expenseId || a.ExpenseId || a.expense_id || 0;
                const idB = b.expenseId || b.ExpenseId || b.expense_id || 0;
                return idB - idA;
            });
            
            // Calculate pagination
            const totalItems = sortedExpenses.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
            const currentPageExpenses = sortedExpenses.slice(startIndex, endIndex);
            
            // Render current page expenses
            currentPageExpenses.forEach(expense => {
                const row = createExpenseRow(expense);
                tbody.appendChild(row);
            });
            
            // Update pagination UI
            updatePaginationUI(totalItems, totalPages, startIndex, endIndex);
        }
        
        // ==================== Update Pagination UI ====================
        function updatePaginationUI(totalItems, totalPages, startIndex, endIndex) {
            const pagination = document.getElementById('expensesPagination');
            const paginationInfo = document.getElementById('paginationInfo');
            const paginationControls = document.getElementById('paginationControls');
            
            if (totalItems === 0) {
                pagination.style.display = 'none';
                return;
            }
            
            pagination.style.display = 'flex';
            
            // Update info text
            paginationInfo.textContent = `عرض ${startIndex + 1} إلى ${endIndex} من ${totalItems} نتيجة`;
            
            // Clear previous controls
            paginationControls.innerHTML = '';
            
            // Previous button
            const prevBtn = document.createElement('button');
            prevBtn.className = 'pagination-btn';
            prevBtn.innerHTML = '&lt;';
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderExpensesWithPagination();
                }
            };
            paginationControls.appendChild(prevBtn);
            
            // Page number buttons
            const maxVisiblePages = 7;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage < maxVisiblePages - 1) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            if (startPage > 1) {
                const firstBtn = document.createElement('button');
                firstBtn.className = 'pagination-btn';
                firstBtn.textContent = '1';
                firstBtn.onclick = () => {
                    currentPage = 1;
                    renderExpensesWithPagination();
                };
                paginationControls.appendChild(firstBtn);
                
                if (startPage > 2) {
                    const ellipsis = document.createElement('span');
                    ellipsis.className = 'pagination-btn';
                    ellipsis.textContent = '...';
                    ellipsis.style.cursor = 'default';
                    ellipsis.style.pointerEvents = 'none';
                    paginationControls.appendChild(ellipsis);
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = 'pagination-btn';
                if (i === currentPage) {
                    pageBtn.classList.add('active');
                }
                pageBtn.textContent = i.toString();
                pageBtn.onclick = () => {
                    currentPage = i;
                    renderExpensesWithPagination();
                };
                paginationControls.appendChild(pageBtn);
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsis = document.createElement('span');
                    ellipsis.className = 'pagination-btn';
                    ellipsis.textContent = '...';
                    ellipsis.style.cursor = 'default';
                    ellipsis.style.pointerEvents = 'none';
                    paginationControls.appendChild(ellipsis);
                }
                
                const lastBtn = document.createElement('button');
                lastBtn.className = 'pagination-btn';
                lastBtn.textContent = totalPages.toString();
                lastBtn.onclick = () => {
                    currentPage = totalPages;
                    renderExpensesWithPagination();
                };
                paginationControls.appendChild(lastBtn);
            }
            
            // Next button
            const nextBtn = document.createElement('button');
            nextBtn.className = 'pagination-btn';
            nextBtn.innerHTML = '&gt;';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    renderExpensesWithPagination();
                }
            };
            paginationControls.appendChild(nextBtn);
        }

        // ==================== Create Expense Row ====================
        function createExpenseRow(expense) {
            const tr = document.createElement('tr');
            
            // Get expense ID - ensure correct field name
            const expenseId = expense.expenseId || expense.ExpenseId || expense.expense_id;
            
            // Format date in Gregorian format (not Arabic Hijri) - date only (no time)
            const date = new Date(expense.dateTime || expense.DateTime || expense.date_time);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const formattedDate = `${day}/${month}/${year}`;
            
            // Format due date
            let formattedDueDate = '-';
            if (expense.dueDate || expense.DueDate || expense.due_date) {
                const dueDate = new Date(expense.dueDate || expense.DueDate || expense.due_date);
                if (!isNaN(dueDate.getTime())) {
                    const dueYear = dueDate.getFullYear();
                    const dueMonth = String(dueDate.getMonth() + 1).padStart(2, '0');
                    const dueDay = String(dueDate.getDate()).padStart(2, '0');
                    formattedDueDate = `${dueDay}/${dueMonth}/${dueYear}`;
                }
            }
            
            // Format amount
            const amount = (expense.totalAmount || expense.TotalAmount || expense.total_amount || 0).toFixed(2);
            
            // Get approval status
            const approvalStatus = (expense.approvalStatus || expense.ApprovalStatus || expense.approval_status || '').toLowerCase();
            
            // Get rejection reason
            const rejectionReason = expense.rejectionReason || expense.RejectionReason || expense.rejection_reason || null;
            
            // Get approval status badge
            const statusBadge = getApprovalStatusBadge(approvalStatus, rejectionReason, expenseId);
            
            // Get comment (truncate if too long)
            const commentText = expense.comment || expense.Comment || '';
            const comment = commentText ? (commentText.length > 50 ? commentText.substring(0, 50) + '...' : commentText) : '-';
            const commentDisplay = comment;
            
            // Determine if edit button should be shown
            // Only show for auto-approved and accepted expenses
            const canEdit = approvalStatus === 'auto-approved' || approvalStatus === 'accepted';
            
            // Get hotel code for view details
            const hotelCode = expense.hotelCode || expense.HotelCode || currentHotelCode || '';
            const hotelCodeEscaped = hotelCode.replace(/'/g, "\\'");
            
            // Build action buttons HTML with SVG icons - Smaller professional size
            let actionButtonsHtml = '';
            // View Details button - always shown (icon only)
            actionButtonsHtml += `
                    <button class="action-btn action-btn-view" onclick="viewExpenseDetails(${expenseId}, '${hotelCodeEscaped}')" title="عرض التفاصيل">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                            <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                    </button>`;
            if (canEdit) {
                actionButtonsHtml += `
                    <button class="action-btn action-btn-edit" onclick="editExpense(${expenseId})" title="تعديل">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                    </button>`;
            }
            // Delete button is always shown
            actionButtonsHtml += `
                    <button class="action-btn action-btn-delete" onclick="deleteExpense(${expenseId})" title="حذف">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            <line x1="10" y1="11" x2="10" y2="17"></line>
                            <line x1="14" y1="11" x2="14" y2="17"></line>
                        </svg>
                    </button>`;
            
            tr.innerHTML = `
                <td><strong>#${expenseId}</strong></td>
                <td>${formattedDate}</td>
                <td>${formattedDueDate}</td>
                <td>${expense.expenseCategoryName || expense.ExpenseCategoryName || expense.expense_category_name || 'غير محدد'}</td>
                <td><strong style="color: var(--primary-blue); font-size: 14px;">${amount} <span class="sar-symbol sar-symbol-large"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1124.14 1256.39"><path fill="#231f20" d="M699.62,1113.02h0c-20.06,44.48-33.32,92.75-38.4,143.37l424.51-90.24c20.06-44.47,33.31-92.75,38.4-143.37l-424.51,90.24Z"/><path fill="#231f20" d="M1085.73,895.8c20.06-44.47,33.32-92.75,38.4-143.37l-330.68,70.33v-135.2l292.27-62.11c20.06-44.47,33.32-92.75,38.4-143.37l-330.68,70.27V66.13c-50.67,28.45-95.67,66.32-132.25,110.99v403.35l-132.25,28.11V0c-50.67,28.44-95.67,66.32-132.25,110.99v525.69l-295.91,62.88c-20.06,44.47-33.33,92.75-38.42,143.37l334.33-71.05v170.26l-358.3,76.14c-20.06,44.47-33.32,92.75-38.4,143.37l375.04-79.7c30.53-6.35,56.77-24.4,73.83-49.24l68.78-101.97v-.02c7.14-10.55,11.3-23.27,11.3-36.97v-149.98l132.25-28.11v270.4l424.53-90.28Z"/></svg></span></strong></td>
                <td>${statusBadge}</td>
                <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${commentText || '-'}">${commentDisplay}</td>
                <td class="action-buttons-cell">
                    ${actionButtonsHtml}
                </td>
            `;
            
            return tr;
        }

        // ==================== Get Approval Status Badge ====================
        function getApprovalStatusBadge(status, rejectionReason = null, expenseId = null) {
            const statusLower = (status || '').toLowerCase();
            let badgeClass = '';
            let icon = '';
            let text = '';
            let clickable = '';
            let onclickAttr = '';
            
            switch(statusLower) {
                case 'auto-approved':
                    badgeClass = 'status-auto-approved';
                    icon = '<i class="fas fa-check-circle"></i>';
                    text = 'موافقة تلقائية';
                    break;
                case 'pending':
                    badgeClass = 'status-pending';
                    icon = '<i class="fas fa-clock"></i>';
                    text = 'في انتظار المشرف';
                    break;
                case 'awaiting-manager':
                    badgeClass = 'status-awaiting-manager';
                    icon = '<i class="fas fa-user-tie"></i>';
                    text = 'في انتظار مدير العمليات';
                    break;
            case 'awaiting-accountant':
                badgeClass = 'status-awaiting-accountant';
                icon = '<i class="fas fa-calculator"></i>';
                text = 'في انتظار المحاسب';
                break;
            case 'awaiting-admin':
                badgeClass = 'status-awaiting-admin';
                icon = '<i class="fas fa-user-shield"></i>';
                text = 'في انتظار المدير العام';
                break;
                case 'accepted':
                    badgeClass = 'status-accepted';
                    icon = '<i class="fas fa-check"></i>';
                    text = 'مقبول';
                    break;
                case 'rejected':
                    badgeClass = 'status-rejected';
                    icon = '<i class="fas fa-times-circle"></i>';
                    text = 'مرفوض';
                    // Make badge clickable if there's a rejection reason
                    if (rejectionReason && rejectionReason !== '-' && rejectionReason.trim() !== '') {
                        clickable = 'clickable';
                        onclickAttr = `onclick="showRejectionReason('${rejectionReason.replace(/'/g, "\\'")}')"`;
                    }
                    break;
                default:
                    badgeClass = 'status-pending';
                    icon = '<i class="fas fa-question-circle"></i>';
                    text = status || 'غير محدد';
            }
            
            return `<span class="approval-status-badge ${badgeClass} ${clickable}" ${onclickAttr} title="${statusLower === 'rejected' && rejectionReason ? 'انقر لعرض سبب الرفض' : ''}">${icon} ${text}</span>`;
        }

        // Show Rejection Reason
        function showRejectionReason(reason) {
            Swal.fire({
                icon: 'error',
                title: 'سبب الرفض',
                html: `<div style="text-align: right; padding: 10px; font-size: 14px;">${reason}</div>`,
                confirmButtonText: 'حسناً',
                confirmButtonColor: '#DC3545',
                customClass: {
                    popup: 'swal2-rtl'
                }
            });
        }
        
        // ==================== User Profile Functions ====================
        // Toggle User Dropdown
        function toggleUserDropdown(event) {
            if (event) {
                event.stopPropagation();
            }
            const dropdown = document.getElementById('userDropdownMenu');
            const notificationsDropdown = document.getElementById('notificationsDropdown');
            
            if (dropdown) {
                if (dropdown.classList.contains('active')) {
                    dropdown.classList.remove('active');
                } else {
                    // Close notifications if open
                    if (notificationsDropdown) {
                        notificationsDropdown.classList.remove('active');
                    }
                    dropdown.classList.add('active');
                }
            }
        }

        // Close User Dropdown when clicking outside
        $(document).on('click', function(event) {
            const dropdown = document.getElementById('userDropdownMenu');
            const userDisplay = document.querySelector('.user-name-display');
            
            if (dropdown && userDisplay && !dropdown.contains(event.target) && !userDisplay.contains(event.target)) {
                dropdown.classList.remove('active');
            }
        });

        // Parse JWT Token
        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) {
                return null;
            }
        }

        // Load User Info
        async function loadUserInfo() {
            try {
                const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
                const authToken = localStorage.getItem('authToken');
                
                if (!authToken) {
                    return;
                }

                // First, try to display from userInfo (from login response)
                // This ensures we show data immediately without waiting for API call
                if (userInfo && (userInfo.fullName || userInfo.username)) {
                    displayUserInfo(userInfo);
                }

                // Get user ID from JWT token or userInfo
                const userId = userInfo.userId || userInfo.UserId;
                if (!userId) {
                    console.warn('User ID not found in userInfo');
                    // Try to get from JWT token
                    const tokenData = parseJwt(authToken);
                    if (tokenData && tokenData.userId) {
                        await fetchUserProfile(tokenData.userId);
                    } else {
                        // Already displayed from userInfo above
                    }
                    return;
                }

                // Fetch fresh data from API to ensure we have the latest info
                await fetchUserProfile(userId);
            } catch (error) {
                console.error('Error loading user info:', error);
                // Fallback: display from userInfo
                const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
                displayUserInfo(userInfo);
            }
        }

        // Fetch User Profile from API
        async function fetchUserProfile(userId) {
            try {
                const authToken = localStorage.getItem('authToken');
                if (!authToken) {
                    return;
                }

                const response = await fetch(`/api/MasterUser/${userId}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const userData = await response.json();
                    displayUserInfo(userData);
                } else {
                    console.warn('Failed to fetch user profile, using cached info');
                    const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
                    displayUserInfo(userInfo);
                }
            } catch (error) {
                console.error('Error fetching user profile:', error);
                const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
                displayUserInfo(userInfo);
            }
        }

        // Display User Info
        function displayUserInfo(userData) {
            console.log('📋 [displayUserInfo] User data received:', userData);
            
            // Always prioritize FullName, use username only as fallback if FullName is not available
            const fullName = userData.fullName || userData.FullName;
            const displayName = fullName ? fullName : (userData.username || userData.Username || 'المستخدم');
            const email = userData.email || userData.Email || userData.username || userData.Username || '-';
            const employeeNumber = userData.employeeNumber || userData.EmployeeNumber || null;
            
            console.log('📋 [displayUserInfo] Extracted values:', {
                fullName: fullName,
                displayName: displayName,
                email: email,
                employeeNumber: employeeNumber
            });
            
            // Update header display - Use FullName if available, otherwise username
            const userNameElement = document.getElementById('userFullName');
            if (userNameElement) {
                userNameElement.textContent = displayName;
                console.log('✅ [displayUserInfo] Updated header name to:', displayName);
            }

            // Update dropdown header
            const dropdownUserName = document.getElementById('dropdownUserName');
            const dropdownUserEmail = document.getElementById('dropdownUserEmail');
            const dropdownEmployeeNumber = document.getElementById('dropdownEmployeeNumber');
            
            if (dropdownUserName) {
                dropdownUserName.textContent = displayName;
                console.log('✅ [displayUserInfo] Updated dropdown name to:', displayName);
            }
            if (dropdownUserEmail) {
                dropdownUserEmail.textContent = email;
                console.log('✅ [displayUserInfo] Updated dropdown email to:', email);
            }
            if (dropdownEmployeeNumber) {
                if (employeeNumber) {
                    dropdownEmployeeNumber.textContent = `الرقم الوظيفي: ${employeeNumber}`;
                    dropdownEmployeeNumber.style.display = 'block';
                    console.log('✅ [displayUserInfo] Updated dropdown employee number to:', employeeNumber);
                } else {
                    dropdownEmployeeNumber.style.display = 'none';
                }
            }

            // Store in global variable for profile modal
            window.currentUserData = userData;
        }

        // Open Profile Modal
        function openProfileModal() {
            const modal = document.getElementById('profileModal');
            const userData = window.currentUserData || JSON.parse(localStorage.getItem('userInfo') || '{}');
            
            if (modal) {
                // Populate form
                $('#profileUsername').val(userData.username || userData.Username || '');
                $('#profileFullName').val(userData.fullName || userData.FullName || '');
                $('#profileEmail').val(userData.email || userData.Email || '');
                $('#profilePhoneNumber').val(userData.phoneNumber || userData.PhoneNumber || '');
                $('#profileEmployeeNumber').val(userData.employeeNumber || userData.EmployeeNumber || '');
                $('#profileTenantName').val(userData.tenantName || userData.TenantName || userData.tenantCode || userData.TenantCode || '');
                
                modal.style.display = 'flex';
                $('#userDropdownMenu').removeClass('active');
            }
        }

        // Close Profile Modal
        function closeProfileModal() {
            $('#profileModal').hide();
        }

        // Open Change Password Modal
        function openChangePasswordModal() {
            const modal = document.getElementById('changePasswordModal');
            if (modal) {
                // Reset form
                $('#changePasswordForm')[0].reset();
                modal.style.display = 'flex';
                $('#userDropdownMenu').removeClass('active');
            }
        }

        // Close Change Password Modal
        function closeChangePasswordModal() {
            $('#changePasswordModal').hide();
        }

        // Handle Profile Form Submit
        $(document).ready(function() {
            $('#profileForm').on('submit', async function(e) {
                e.preventDefault();
                
                try {
                    const authToken = localStorage.getItem('authToken');
                    const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
                    const userId = userInfo.userId || userInfo.UserId || parseJwt(authToken)?.userId;
                    
                    if (!userId || !authToken) {
                        showNotification('⚠️ يجب تسجيل الدخول أولاً', 'error');
                        return;
                    }

                    const formData = {
                        fullName: $('#profileFullName').val() || null,
                        email: $('#profileEmail').val() || null,
                        phoneNumber: $('#profilePhoneNumber').val() || null,
                        employeeNumber: $('#profileEmployeeNumber').val() || null
                    };

                    const response = await fetch(`/api/MasterUser/${userId}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });

                    if (response.ok) {
                        const updatedUser = await response.json();
                        displayUserInfo(updatedUser);
                        window.currentUserData = updatedUser;
                        closeProfileModal();
                        showNotification('✅ تم تحديث الملف الشخصي بنجاح', 'success');
                    } else {
                        const error = await response.json().catch(() => ({ error: 'فشل تحديث الملف الشخصي' }));
                        showNotification(`❌ ${error.error || 'فشل تحديث الملف الشخصي'}`, 'error');
                    }
                } catch (error) {
                    console.error('Error updating profile:', error);
                    showNotification(`❌ خطأ: ${error.message}`, 'error');
                }
            });

            // Handle Change Password Form Submit
            $('#changePasswordForm').on('submit', async function(e) {
                e.preventDefault();
                
                const newPassword = $('#newPassword').val();
                const confirmPassword = $('#confirmPassword').val();
                
                if (newPassword !== confirmPassword) {
                    showNotification('❌ كلمة المرور الجديدة وتأكيدها غير متطابقين', 'error');
                    return;
                }

                if (newPassword.length < 6) {
                    showNotification('❌ كلمة المرور يجب أن تكون 6 أحرف على الأقل', 'error');
                    return;
                }

                try {
                    const authToken = localStorage.getItem('authToken');
                    const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
                    const userId = userInfo.userId || userInfo.UserId || parseJwt(authToken)?.userId;
                    
                    if (!userId || !authToken) {
                        showNotification('⚠️ يجب تسجيل الدخول أولاً', 'error');
                        return;
                    }

                    const formData = {
                        password: newPassword
                    };

                    const response = await fetch(`/api/MasterUser/${userId}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });

                    if (response.ok) {
                        closeChangePasswordModal();
                        showNotification('✅ تم تغيير كلمة المرور بنجاح', 'success');
                    } else {
                        const error = await response.json().catch(() => ({ error: 'فشل تغيير كلمة المرور' }));
                        showNotification(`❌ ${error.error || 'فشل تغيير كلمة المرور'}`, 'error');
                    }
                } catch (error) {
                    console.error('Error changing password:', error);
                    showNotification(`❌ خطأ: ${error.message}`, 'error');
                }
            });
        });
        
        // ==================== Notification Functions ====================
        // Update Notification Count
        function updateNotificationCount() {
            // Count all expenses with pending or awaiting status
            const pendingExpenses = allExpensesData.filter(expense => {
                const status = (expense.approvalStatus || expense.ApprovalStatus || expense.approval_status || '').toLowerCase();
                return status === 'pending' || 
                       status === 'awaiting-manager' || 
                       status === 'awaiting-accountant' || 
                       status === 'awaiting-admin';
            });
            
            // Check if all expenses are accepted or rejected
            const allProcessed = allExpensesData.length > 0 && allExpensesData.every(expense => {
                const status = (expense.approvalStatus || expense.ApprovalStatus || expense.approval_status || '').toLowerCase();
                return status === 'accepted' || status === 'rejected';
            });
            
            // Filter out read notifications
            const unreadCount = pendingExpenses.filter(expense => {
                const expenseId = expense.expenseId || expense.ExpenseId || expense.expense_id;
                return !readNotifications.includes(expenseId);
            }).length;
            
            const notificationCount = document.getElementById('notificationCount');
            if (notificationCount) {
                // If all are processed (accepted/rejected), show 0 with green
                if (allProcessed && pendingExpenses.length === 0) {
                    notificationCount.textContent = '0';
                    notificationCount.style.display = 'flex';
                    notificationCount.classList.add('read');
                } else if (unreadCount > 0) {
                    // Show count with red badge
                    notificationCount.textContent = unreadCount;
                    notificationCount.style.display = 'flex';
                    notificationCount.classList.remove('read');
                } else if (pendingExpenses.length > 0 && unreadCount === 0) {
                    // All pending expenses are read, show 0 with green
                    notificationCount.textContent = '0';
                    notificationCount.style.display = 'flex';
                    notificationCount.classList.add('read');
                } else {
                    // No pending expenses
                    notificationCount.style.display = 'none';
                    notificationCount.classList.remove('read');
                }
            }
        }
        
        // Load and Display Notifications
        function loadNotifications() {
            const notificationsList = document.getElementById('notificationsList');
            if (!notificationsList) return;
            
            const pendingExpenses = allExpensesData.filter(expense => {
                const status = (expense.approvalStatus || expense.ApprovalStatus || expense.approval_status || '').toLowerCase();
                return status === 'pending' || 
                       status === 'awaiting-manager' || 
                       status === 'awaiting-accountant' || 
                       status === 'awaiting-admin';
            });
            
            if (!pendingExpenses || pendingExpenses.length === 0) {
                notificationsList.innerHTML = `
                    <div class="notifications-empty">
                        <i class="fas fa-check-circle"></i>
                        <p>لا توجد إشعارات</p>
                    </div>
                `;
                return;
            }
            
            // Sort by date (newest first)
            const sortedExpenses = [...pendingExpenses].sort((a, b) => {
                const dateA = new Date(a.dateTime || a.DateTime || a.date_time);
                const dateB = new Date(b.dateTime || b.DateTime || b.date_time);
                return dateB - dateA;
            });
            
            notificationsList.innerHTML = sortedExpenses.map(expense => {
                const expenseId = expense.expenseId || expense.ExpenseId || expense.expense_id;
                const hotelName = expense.hotelName || expense.HotelName || 'غير محدد';
                const amount = (expense.totalAmount || expense.TotalAmount || expense.total_amount || 0).toFixed(2);
                const date = new Date(expense.dateTime || expense.DateTime || expense.date_time);
                const formattedDate = `${String(date.getDate()).padStart(2, '0')}/${String(date.getMonth() + 1).padStart(2, '0')}/${date.getFullYear()}`;
                const formattedTime = `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
                const isRead = readNotifications.includes(expenseId);
                
                return `
                    <div class="notification-item ${isRead ? 'read' : ''}" onclick="markNotificationAsRead(${expenseId})">
                        <div class="notification-item-title">
                            <i class="fas fa-file-invoice-dollar"></i>
                            طلب مصروف #${expenseId}
                        </div>
                        <div class="notification-item-content">
                            طلب من <strong>${hotelName}</strong> يحتوي على مبلغ <strong>${amount} <img src="logo/sar-symbol.svg" style="width: 14px; height: 14px; vertical-align: middle;" alt="SAR" /></strong>
                        </div>
                        <div class="notification-item-date">
                            ${formattedDate} ${formattedTime}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Toggle Notifications Dropdown
        function toggleNotifications() {
            const dropdown = document.getElementById('notificationsDropdown');
            if (!dropdown) return;
            
            if (dropdown.classList.contains('active')) {
                closeNotifications();
            } else {
                loadNotifications();
                dropdown.classList.add('active');
                // Mark all as read when opened
                markAllNotificationsAsRead();
            }
        }
        
        // Close Notifications Dropdown
        function closeNotifications(event) {
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }
            const dropdown = document.getElementById('notificationsDropdown');
            if (dropdown) {
                dropdown.classList.remove('active');
            }
        }
        
        // Mark Notification as Read
        function markNotificationAsRead(expenseId) {
            if (!readNotifications.includes(expenseId)) {
                readNotifications.push(expenseId);
                localStorage.setItem('readNotifications', JSON.stringify(readNotifications));
                updateNotificationCount();
                loadNotifications();
            }
        }
        
        // Mark All Notifications as Read
        function markAllNotificationsAsRead() {
            const pendingExpenses = allExpensesData.filter(expense => {
                const status = (expense.approvalStatus || expense.ApprovalStatus || expense.approval_status || '').toLowerCase();
                return status === 'pending' || 
                       status === 'awaiting-manager' || 
                       status === 'awaiting-accountant' || 
                       status === 'awaiting-admin';
            });
            
            pendingExpenses.forEach(expense => {
                const expenseId = expense.expenseId || expense.ExpenseId || expense.expense_id;
                if (!readNotifications.includes(expenseId)) {
                    readNotifications.push(expenseId);
                }
            });
            
            localStorage.setItem('readNotifications', JSON.stringify(readNotifications));
            updateNotificationCount();
            loadNotifications();
        }

        // ==================== Edit Expense ====================
        function editExpense(expenseId) {
            // Ensure expenseId is a number
            expenseId = parseInt(expenseId);
            if (isNaN(expenseId)) {
                showNotification('❌ معرف المصروف غير صحيح', 'error');
                return;
            }
            
            // Switch to add expense tab
            $('.tab-btn[data-tab="add-expense"]').click();
            
            // Load expense data into form
            loadExpenseForEdit(expenseId);
        }

        async function loadExpenseForEdit(expenseId) {
            try {
                showLoading();
                
                const headers = getApiHeaders();
                const response = await fetch(`${API_BASE_URL}/api/Expense/${expenseId}`, {
                    method: 'GET',
                    headers: headers
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load expense');
                }
                
                const expense = await response.json();
                
                // Fill form with expense data
                if (expense.dateTime || expense.DateTime) {
                    const date = new Date(expense.dateTime || expense.DateTime);
                    const formattedDate = date.toISOString().split('T')[0];
                    $('#expenseDate').val(formattedDate);
                }
                
                // Fill due date if available
                if (expense.dueDate || expense.DueDate) {
                    const dueDate = new Date(expense.dueDate || expense.DueDate);
                    const formattedDueDate = dueDate.toISOString().split('T')[0];
                    $('#dueDate').val(formattedDueDate);
                } else {
                    $('#dueDate').val('');
                }
                
                if (expense.expenseCategoryId || expense.ExpenseCategoryId) {
                    $('#expenseCategorySelect').val(expense.expenseCategoryId || expense.ExpenseCategoryId).trigger('change');
                }
                
                if (expense.totalAmount || expense.TotalAmount) {
                    $('#totalAmount').val(expense.totalAmount || expense.TotalAmount);
                }
                
                if (expense.comment || expense.Comment) {
                    $('#expenseComment').val(expense.comment || expense.Comment);
                }
                
                // Load tax information
                const expenseTaxRate = expense.taxRate || expense.TaxRate || null;
                const expenseTaxAmount = expense.taxAmount || expense.TaxAmount || null;
                
                if (expenseTaxRate && expenseTaxRate > 0) {
                    $('#includeTaxCheckbox').prop('checked', true);
                    $('#taxInputGroup').show();
                    if (expenseTaxAmount) {
                        $('#taxAmount').val(expenseTaxAmount.toFixed(2));
                        const totalAmount = parseFloat($('#totalAmount').val()) || 0;
                        const baseAmount = totalAmount - expenseTaxAmount;
                        const sarSymbol = '<span class="sar-symbol"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1124.14 1256.39"><path fill="#231f20" d="M699.62,1113.02h0c-20.06,44.48-33.32,92.75-38.4,143.37l424.51-90.24c20.06-44.47,33.31-92.75,38.4-143.37l-424.51,90.24Z"/><path fill="#231f20" d="M1085.73,895.8c20.06-44.47,33.32-92.75,38.4-143.37l-330.68,70.33v-135.2l292.27-62.11c20.06-44.47,33.32-92.75,38.4-143.37l-330.68,70.27V66.13c-50.67,28.45-95.67,66.32-132.25,110.99v403.35l-132.25,28.11V0c-50.67,28.44-95.67,66.32-132.25,110.99v525.69l-295.91,62.88c-20.06,44.47-33.33,92.75-38.42,143.37l334.33-71.05v170.26l-358.3,76.14c-20.06,44.47-33.32,92.75-38.4,143.37l375.04-79.7c30.53-6.35,56.77-24.4,73.83-49.24l68.78-101.97v-.02c7.14-10.55,11.3-23.27,11.3-36.97v-149.98l132.25-28.11v270.4l424.53-90.28Z"/></svg></span>';
                        $('#taxInfo').html(`المبلغ قبل الضريبة: ${baseAmount.toFixed(2)} ${sarSymbol} | نسبة الضريبة: ${expenseTaxRate}%`).show();
                    }
                } else {
                    $('#includeTaxCheckbox').prop('checked', false);
                    $('#taxInputGroup').hide();
                }
                
                // Load existing images for this expense (silently, no popup)
                await loadExpenseImagesForEdit(expenseId);
                
                // ✅ Load expense rooms if they exist
                const expenseRooms = expense.expenseRooms || expense.ExpenseRooms || [];
                if (expenseRooms && expenseRooms.length > 0) {
                    // Clear existing rows
                    $('#expenseRoomsBody').empty();
                    
                    // ✅ Ensure expense categories (including room categories) are loaded first
                    // This ensures roomCategories array is populated before we try to load expense rooms
                    if (expenseCategories.length === 0 || roomCategories.length === 0) {
                        await loadExpenseCategories();
                    }
                    
                    // Ensure apartments are loaded too (for actual room selections)
                    if (apartments.length === 0) {
                        await loadApartments();
                    }
                    
                    // Load each expense room
                    for (const room of expenseRooms) {
                        // ✅ Get categoryCode or zaaerId from room (categoryCode takes priority for categories)
                        let zaaerId = null;
                        const categoryCode = room.categoryCode || room.CategoryCode;
                        
                        if (categoryCode && categoryCode.startsWith('CAT_')) {
                            // ✅ It's a category - use categoryCode
                            zaaerId = categoryCode;
                        } else {
                            // It's a room - use zaaerId
                            zaaerId = room.zaaerId || room.ZaaerId || room.zaaer_id;
                            zaaerId = zaaerId ? zaaerId.toString() : null;
                        }
                        
                        const purpose = room.purpose || room.Purpose || '';
                        const amount = room.amount || room.Amount || 0;
                        
                        // Add a new row (this will increment expenseRoomRowCounter)
                        addExpenseRoomRow();
                        
                        // Get the row counter that was just used (after increment)
                        const rowCounter = expenseRoomRowCounter;
                        
                        // Fill in the room data after a short delay to ensure Select2 is initialized and categories are added
                        setTimeout(function() {
                            // Get apartment select element
                            const apartmentSelect = $(`.apartment-select[data-row-id="${rowCounter}"]`);
                            
                            // ✅ Ensure categories are in dropdown (they should be added by addExpenseRoomRow, but double-check)
                            // Check if the option exists, if not, add categories
                            let needSelect2Refresh = false;
                            if (zaaerId && zaaerId.startsWith('CAT_')) {
                                const categoryExists = apartmentSelect.find(`option[value="${zaaerId}"]`).length > 0;
                                if (!categoryExists) {
                                    // Add categories if they don't exist (from API or fallback)
                                    const categoryOptions = getRoomCategories();
                                    categoryOptions.forEach(cat => {
                                        if (apartmentSelect.find(`option[value="${cat.value}"]`).length === 0) {
                                            apartmentSelect.append(`<option value="${cat.value}">${cat.text}</option>`);
                                            needSelect2Refresh = true;
                                        }
                                    });
                                }
                            }
                            
                            // ✅ If we added options after Select2 initialization, refresh Select2
                            if (needSelect2Refresh && apartmentSelect.hasClass('select2-hidden-accessible')) {
                                apartmentSelect.select2('destroy');
                                apartmentSelect.select2({
                                    theme: 'default',
                                    dir: 'rtl',
                                    width: '100%',
                                    placeholder: 'اختر الغرفة...',
                                    allowClear: true,
                                    language: {
                                        noResults: function() { return "لا توجد نتائج"; },
                                        searching: function() { return "جاري البحث..."; }
                                    },
                                    dropdownCssClass: 'select2-dropdown-custom'
                                });
                            }
                            
                            // Set apartment selection (using zaaerId - can be category string or room ID string)
                            if (zaaerId) {
                                // Convert to string to match option values
                                const valueToSet = zaaerId.toString();
                                apartmentSelect.val(valueToSet);
                                // If Select2 is initialized, update it too
                                if (apartmentSelect.hasClass('select2-hidden-accessible')) {
                                    apartmentSelect.trigger('change.select2');
                                } else {
                                    apartmentSelect.trigger('change');
                                }
                            }
                            
                            // Set purpose
                            $(`.purpose-input[data-row-id="${rowCounter}"]`).val(purpose);
                            
                            // Set amount (without triggering calculateTotalFromRooms during load)
                            const amountInput = $(`.amount-input[data-row-id="${rowCounter}"]`);
                            amountInput.off('input'); // Temporarily remove input handler
                            amountInput.val(amount || '');
                            amountInput.on('input', function() {
                                calculateTotalFromRooms();
                            }); // Re-add input handler
                        }, 500); // Increased delay to ensure Select2 and categories are fully loaded
                    }
                    
                    // Show the table
                    $('#expenseRoomsTable').show();
                    $('#emptyRoomsMessage').hide();
                    
                    // Update total from rooms (but don't override the total amount from API)
                    // The total amount field already has the correct value from expense.totalAmount
                } else {
                    // No expense rooms - hide table and show empty message
                    $('#expenseRoomsTable').hide();
                    $('#expenseRoomsBody').empty();
                }
                
                // Store expense ID for update
                $('#expenseForm').data('editing-expense-id', expenseId);
                
                // Change submit button text
                $('#expenseForm button[type="submit"]').html('<i class="fas fa-save"></i> تحديث المصروف');
                
                showNotification('✅ تم تحميل بيانات المصروف للتعديل', 'success');
                
            } catch (error) {
                console.error('Error loading expense for edit:', error);
                showNotification(`❌ خطأ في تحميل المصروف: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        // ==================== View Expense Images ====================
        async function viewExpenseImages(expenseId) {
            // Ensure expenseId is a number
            expenseId = parseInt(expenseId);
            if (isNaN(expenseId)) {
                showNotification('❌ معرف المصروف غير صحيح', 'error');
                return;
            }
            
            try {
                showLoading();
                
                const headers = getApiHeaders();
                const response = await fetch(`${API_BASE_URL}/api/Expense/${expenseId}/images`, {
                    method: 'GET',
                    headers: headers
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load images');
                }
                
                const images = await response.json();
                const imagesGrid = document.getElementById('imagesGrid');
                
                if (!images || images.length === 0) {
                    imagesGrid.innerHTML = `
                        <div class="no-images-message">
                            <i class="fas fa-image" style="font-size: 48px; color: #d1d5db; margin-bottom: 16px;"></i>
                            <p>لا توجد صور لهذا المصروف</p>
                        </div>
                    `;
                } else {
                    imagesGrid.innerHTML = '';
                    images.forEach(image => {
                        const imageUrl = image.imageUrl || image.ImageUrl || image.image_path || image.url || image.Url;
                        if (imageUrl) {
                            const imageItem = document.createElement('div');
                            imageItem.className = 'image-item';
                            // Handle relative paths
                            const fullImageUrl = imageUrl.startsWith('http') ? imageUrl : `${API_BASE_URL}${imageUrl}`;
                            imageItem.innerHTML = `<img src="${fullImageUrl}" alt="Expense Image" onclick="window.open('${fullImageUrl}', '_blank')">`;
                            imagesGrid.appendChild(imageItem);
                        }
                    });
                }
                
                // Show modal
                document.getElementById('imagesModal').classList.add('active');
                
            } catch (error) {
                console.error('Error loading images:', error);
                showNotification(`❌ خطأ في تحميل الصور: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        // ==================== Close Images Modal ====================
        function closeImagesModal() {
            document.getElementById('imagesModal').classList.remove('active');
        }

        // ==================== View Expense Details ====================
        async function viewExpenseDetails(expenseId, hotelCode) {
            try {
                showLoading();
                
                const headers = getApiHeaders();
                // Add X-Hotel-Code header if provided
                if (hotelCode) {
                    headers['X-Hotel-Code'] = hotelCode;
                    console.log('✅ [viewExpenseDetails] Sending X-Hotel-Code header:', hotelCode);
                } else if (currentHotelCode) {
                    headers['X-Hotel-Code'] = currentHotelCode;
                    console.log('✅ [viewExpenseDetails] Using currentHotelCode:', currentHotelCode);
                }
                
                const response = await fetch(`${API_BASE_URL}/api/Expense/${expenseId}`, {
                    method: 'GET',
                    headers: headers
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load expense details');
                }
                
                const expense = await response.json();
                
                // Load images
                const imagesResponse = await fetch(`${API_BASE_URL}/api/Expense/${expenseId}/images`, {
                    method: 'GET',
                    headers: headers
                });
                
                let images = [];
                if (imagesResponse.ok) {
                    images = await imagesResponse.json();
                }
                
                // Render expense details
                renderExpenseDetails(expense, images);
                
                // Show modal
                document.getElementById('expenseDetailsModal').classList.add('active');
                
            } catch (error) {
                console.error('Error loading expense details:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'خطأ',
                    text: `فشل تحميل تفاصيل المصروف: ${error.message}`,
                    confirmButtonText: 'حسناً',
                    confirmButtonColor: '#007ACC',
                    customClass: {
                        popup: 'swal2-rtl'
                    }
                });
            } finally {
                hideLoading();
            }
        }

        // ==================== Render Expense Details ====================
        function renderExpenseDetails(expense, images) {
            const content = document.getElementById('expenseDetailsContent');
            
            const expenseId = expense.expenseId || expense.ExpenseId;
            const date = new Date(expense.dateTime || expense.DateTime);
            const formattedDate = `${String(date.getDate()).padStart(2, '0')}/${String(date.getMonth() + 1).padStart(2, '0')}/${date.getFullYear()}`;
            const formattedTime = `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
            const dueDate = expense.dueDate || expense.DueDate;
            const formattedDueDate = dueDate ? (() => {
                const d = new Date(dueDate);
                return `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()}`;
            })() : '-';
            const amount = (expense.totalAmount || expense.TotalAmount || 0).toFixed(2);
            const taxAmount = (expense.taxAmount || expense.TaxAmount || 0).toFixed(2);
            const taxRate = (expense.taxRate || expense.TaxRate || 0).toFixed(2);
            const status = (expense.approvalStatus || expense.ApprovalStatus || '').toLowerCase();
            const rejectionReason = expense.rejectionReason || expense.RejectionReason || null;
            const statusBadge = getApprovalStatusBadge(status, rejectionReason, expenseId);
            const approvedBy = expense.approvedBy || expense.ApprovedBy;
            const approvedAt = expense.approvedAt || expense.ApprovedAt;
            const formattedApprovedAt = approvedAt ? (() => {
                const d = new Date(approvedAt);
                const dateStr = `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()}`;
                const timeStr = `${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}:${String(d.getSeconds()).padStart(2, '0')}`;
                return `${dateStr} ${timeStr}`;
            })() : '-';
            const expenseRooms = expense.expenseRooms || expense.ExpenseRooms || [];
            
            content.innerHTML = `
                <!-- Basic Information -->
                <div class="expense-details-section">
                    <div class="expense-details-section-title">
                        <i class="fas fa-info-circle"></i>
                        المعلومات الأساسية
                    </div>
                    <div class="expense-details-grid">
                        <div class="expense-detail-item">
                            <span class="expense-detail-label">رقم المصروف</span>
                            <span class="expense-detail-value"><strong>#${expenseId}</strong></span>
                        </div>
                        <div class="expense-detail-item">
                            <span class="expense-detail-label">الفندق</span>
                            <span class="expense-detail-value">${expense.hotelName || expense.HotelName || 'غير محدد'}</span>
                        </div>
                        <div class="expense-detail-item">
                            <span class="expense-detail-label">التاريخ</span>
                            <span class="expense-detail-value">${formattedDate} ${formattedTime}</span>
                        </div>
                        <div class="expense-detail-item">
                            <span class="expense-detail-label">تاريخ الاستحقاق</span>
                            <span class="expense-detail-value">${formattedDueDate}</span>
                        </div>
                        <div class="expense-detail-item">
                            <span class="expense-detail-label">فئة المصروف</span>
                            <span class="expense-detail-value">${expense.expenseCategoryName || expense.ExpenseCategoryName || 'غير محدد'}</span>
                        </div>
                        <div class="expense-detail-item">
                            <span class="expense-detail-label">حالة الموافقة</span>
                            <span class="expense-detail-value">${statusBadge}</span>
                        </div>
                    </div>
                </div>

                <!-- Financial Information -->
                <div class="expense-details-section">
                    <div class="expense-details-section-title">
                        <i class="fas fa-money-bill-wave"></i>
                        المعلومات المالية
                    </div>
                    <div class="expense-details-grid">
                        <div class="expense-detail-item">
                            <span class="expense-detail-label">المبلغ الإجمالي</span>
                            <span class="expense-detail-value" style="font-size: 18px; font-weight: 700; color: var(--primary-blue);">${amount} <span class="sar-symbol sar-symbol-large"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1124.14 1256.39"><path fill="#231f20" d="M699.62,1113.02h0c-20.06,44.48-33.32,92.75-38.4,143.37l424.51-90.24c20.06-44.47,33.31-92.75,38.4-143.37l-424.51,90.24Z"/><path fill="#231f20" d="M1085.73,895.8c20.06-44.47,33.32-92.75,38.4-143.37l-330.68,70.33v-135.2l292.27-62.11c20.06-44.47,33.32-92.75,38.4-143.37l-330.68,70.27V66.13c-50.67,28.45-95.67,66.32-132.25,110.99v403.35l-132.25,28.11V0c-50.67,28.44-95.67,66.32-132.25,110.99v525.69l-295.91,62.88c-20.06,44.47-33.33,92.75-38.42,143.37l334.33-71.05v170.26l-358.3,76.14c-20.06,44.47-33.32,92.75-38.4,143.37l375.04-79.7c30.53-6.35,56.77-24.4,73.83-49.24l68.78-101.97v-.02c7.14-10.55,11.3-23.27,11.3-36.97v-149.98l132.25-28.11v270.4l424.53-90.28Z"/></svg></span></span>
                        </div>
                        <div class="expense-detail-item">
                            <span class="expense-detail-label">نسبة الضريبة</span>
                            <span class="expense-detail-value">${taxRate}%</span>
                        </div>
                        <div class="expense-detail-item">
                            <span class="expense-detail-label">مبلغ الضريبة</span>
                            <span class="expense-detail-value">${taxAmount} <span class="sar-symbol sar-symbol-large"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1124.14 1256.39"><path fill="#231f20" d="M699.62,1113.02h0c-20.06,44.48-33.32,92.75-38.4,143.37l424.51-90.24c20.06-44.47,33.31-92.75,38.4-143.37l-424.51,90.24Z"/><path fill="#231f20" d="M1085.73,895.8c20.06-44.47,33.32-92.75,38.4-143.37l-330.68,70.33v-135.2l292.27-62.11c20.06-44.47,33.32-92.75,38.4-143.37l-330.68,70.27V66.13c-50.67,28.45-95.67,66.32-132.25,110.99v403.35l-132.25,28.11V0c-50.67,28.44-95.67,66.32-132.25,110.99v525.69l-295.91,62.88c-20.06,44.47-33.33,92.75-38.42,143.37l334.33-71.05v170.26l-358.3,76.14c-20.06,44.47-33.32,92.75-38.4,143.37l375.04-79.7c30.53-6.35,56.77-24.4,73.83-49.24l68.78-101.97v-.02c7.14-10.55,11.3-23.27,11.3-36.97v-149.98l132.25-28.11v270.4l424.53-90.28Z"/></svg></span></span>
                        </div>
                    </div>
                </div>

                <!-- Notes -->
                ${expense.comment || expense.Comment ? `
                <div class="expense-details-section">
                    <div class="expense-details-section-title">
                        <i class="fas fa-sticky-note"></i>
                        الملاحظات
                    </div>
                    <div class="expense-detail-value" style="padding: 12px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
                        ${expense.comment || expense.Comment}
                    </div>
                </div>
                ` : ''}

                <!-- Approval Information -->
                ${status === 'rejected' || status === 'accepted' ? `
                <div class="expense-details-section">
                    <div class="expense-details-section-title">
                        <i class="fas fa-check-circle"></i>
                        معلومات الموافقة/الرفض
                    </div>
                    <div class="expense-details-grid">
                        <div class="expense-detail-item">
                            <span class="expense-detail-label">تمت الموافقة/الرفض بواسطة</span>
                            <span class="expense-detail-value">${approvedBy || '-'}</span>
                        </div>
                        <div class="expense-detail-item">
                            <span class="expense-detail-label">تاريخ الموافقة/الرفض</span>
                            <span class="expense-detail-value">${formattedApprovedAt}</span>
                        </div>
                        ${status === 'rejected' && rejectionReason ? `
                        <div class="expense-detail-item" style="grid-column: 1 / -1;">
                            <span class="expense-detail-label">سبب الرفض</span>
                            <span class="expense-detail-value" style="padding: 12px; background: #fee; border-radius: 8px; border: 1px solid #fcc; color: var(--danger-red);">
                                ${rejectionReason}
                            </span>
                        </div>
                        ` : ''}
                    </div>
                </div>
                ` : ''}

                <!-- Expense Rooms -->
                ${expenseRooms && expenseRooms.length > 0 ? `
                <div class="expense-details-section">
                    <div class="expense-details-section-title">
                        <i class="fas fa-door-open"></i>
                        الغرف المرتبطة (${expenseRooms.length})
                    </div>
                    <div class="expense-rooms-list">
                        ${expenseRooms.map((room, index) => `
                            <div class="expense-room-item">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong>#${index + 1}</strong>
                                        ${room.apartmentName || room.ApartmentName ? `
                                            <span style="margin: 0 10px; color: var(--primary-blue);">
                                                <i class="fas fa-door-open"></i> ${room.apartmentName || room.ApartmentName}
                                                ${room.apartmentCode || room.ApartmentCode ? `(${room.apartmentCode || room.ApartmentCode})` : ''}
                                            </span>
                                        ` : ''}
                                    </div>
                                    <span style="font-weight: 700; color: var(--primary-blue);">${(room.amount || room.Amount || 0).toFixed(2)} <span class="sar-symbol sar-symbol-large"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1124.14 1256.39"><path fill="#231f20" d="M699.62,1113.02h0c-20.06,44.48-33.32,92.75-38.4,143.37l424.51-90.24c20.06-44.47,33.31-92.75,38.4-143.37l-424.51,90.24Z"/><path fill="#231f20" d="M1085.73,895.8c20.06-44.47,33.32-92.75,38.4-143.37l-330.68,70.33v-135.2l292.27-62.11c20.06-44.47,33.32-92.75,38.4-143.37l-330.68,70.27V66.13c-50.67,28.45-95.67,66.32-132.25,110.99v403.35l-132.25,28.11V0c-50.67,28.44-95.67,66.32-132.25,110.99v525.69l-295.91,62.88c-20.06,44.47-33.33,92.75-38.42,143.37l334.33-71.05v170.26l-358.3,76.14c-20.06,44.47-33.32,92.75-38.4,143.37l375.04-79.7c30.53-6.35,56.77-24.4,73.83-49.24l68.78-101.97v-.02c7.14-10.55,11.3-23.27,11.3-36.97v-149.98l132.25-28.11v270.4l424.53-90.28Z"/></svg></span></span>
                                </div>
                                ${room.purpose || room.Purpose ? `
                                    <div style="margin-top: 8px; color: #6b7280; font-size: 13px;">
                                        ${room.purpose || room.Purpose}
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}

                <!-- Images -->
                ${images && images.length > 0 ? `
                <div class="expense-details-section">
                    <div class="expense-details-section-title">
                        <i class="fas fa-images"></i>
                        الصور (${images.length})
                    </div>
                    <div class="expense-images-list">
                        ${images.map((image, index) => {
                            const imageUrl = image.imageUrl || image.ImageUrl || image.image_path || image.url || image.Url;
                            const fullImageUrl = imageUrl.startsWith('http') ? imageUrl : `${API_BASE_URL}${imageUrl}`;
                            return `
                                <div class="expense-image-item">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <strong>صورة #${index + 1}</strong>
                                        ${image.originalFilename || image.OriginalFilename ? `
                                            <span style="color: #6b7280; font-size: 12px;">${image.originalFilename || image.OriginalFilename}</span>
                                        ` : ''}
                                    </div>
                                    <img src="${fullImageUrl}" alt="Expense Image ${index + 1}" onclick="window.open('${fullImageUrl}', '_blank')" />
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
                ` : `
                <div class="expense-details-section">
                    <div class="expense-details-section-title">
                        <i class="fas fa-images"></i>
                        الصور
                    </div>
                    <div style="text-align: center; padding: 20px; color: #6b7280;">
                        <i class="fas fa-image" style="font-size: 48px; color: #d1d5db; margin-bottom: 10px;"></i>
                        <p>لا توجد صور لهذا المصروف</p>
                    </div>
                </div>
                `}
            `;
        }

        // ==================== Close Expense Details Modal ====================
        function closeExpenseDetailsModal() {
            document.getElementById('expenseDetailsModal').classList.remove('active');
        }

        // Show Category Details Modal
        function showCategoryDetailsModal(categoryName, details) {
            $('#categoryDetailsTitle').text(categoryName);
            $('#categoryDetailsText').text(details);
            $('#categoryDetailsModal').addClass('active');
        }

        // Close Category Details Modal
        function closeCategoryDetailsModal() {
            $('#categoryDetailsModal').removeClass('active');
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const imagesModal = document.getElementById('imagesModal');
            if (event.target === imagesModal) {
                closeImagesModal();
            }
            
            const detailsModal = document.getElementById('expenseDetailsModal');
            if (event.target === detailsModal) {
                closeExpenseDetailsModal();
            }
            
            // Close notifications when clicking outside
            const notificationBadge = document.querySelector('.notification-badge');
            const dropdown = document.getElementById('notificationsDropdown');
            const closeButton = document.querySelector('.notifications-close');
            
            // Don't close if clicking on the notification badge itself (to toggle)
            // Don't close if clicking on the close button (it handles its own close)
            if (dropdown && notificationBadge && 
                !notificationBadge.contains(event.target) && 
                !(closeButton && closeButton.contains(event.target))) {
                closeNotifications();
            }
        });

        // ==================== Delete Expense ====================
        async function deleteExpense(expenseId) {
            // Ensure expenseId is a number
            expenseId = parseInt(expenseId);
            if (isNaN(expenseId)) {
                showNotification('❌ معرف المصروف غير صحيح', 'error');
                return;
            }
            
            // Use SweetAlert2 for confirmation
            const result = await Swal.fire({
                title: 'هل أنت متأكد؟',
                text: 'هل أنت متأكد من حذف هذا المصروف؟ لا يمكن التراجع عن هذه العملية.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'نعم، احذف',
                cancelButtonText: 'إلغاء',
                reverseButtons: true,
                customClass: {
                    popup: 'swal2-rtl'
                }
            });
            
            if (!result.isConfirmed) {
                return;
            }
            
            try {
                showLoading();
                
                const headers = getApiHeaders();
                const response = await fetch(`${API_BASE_URL}/api/Expense/${expenseId}`, {
                    method: 'DELETE',
                    headers: headers
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || errorData.error || 'Failed to delete expense');
                }
                
                // Reload expenses table first
                await loadAllExpenses();
                
                // Show success message with SweetAlert2
                await Swal.fire({
                    title: 'تم الحذف!',
                    text: 'تم حذف المصروف بنجاح',
                    icon: 'success',
                    confirmButtonText: 'حسناً',
                    customClass: {
                        popup: 'swal2-rtl'
                    }
                });
                
            } catch (error) {
                console.error('Error deleting expense:', error);
                
                // Show error message with SweetAlert2
                await Swal.fire({
                    title: 'خطأ!',
                    text: `فشل حذف المصروف: ${error.message}`,
                    icon: 'error',
                    confirmButtonText: 'حسناً',
                    customClass: {
                        popup: 'swal2-rtl'
                    }
                });
            } finally {
                hideLoading();
            }
        }
    </script>
</body>
</html>