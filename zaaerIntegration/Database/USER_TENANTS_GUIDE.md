# ๐ ุฏููู ูุธุงู ุงูุตูุงุญูุงุช - UserTenants

## ๐ ูุธุฑุฉ ุนุงูุฉ

ุชู ุชุทุจูู ูุธุงู ุตูุงุญูุงุช ููููุงุฏู ุจูุงุกู ุนูู ุงูุฃุฏูุงุฑ (Roles) ูุงููุณุชุฎุฏููู. ุงููุธุงู ูุณุชุฎุฏู ุฌุฏูู `UserTenants` ูุชุญุฏูุฏ ุฃู ููุงุฏู ูููู ูููุณุชุฎุฏู ุงููุตูู ุฅูููุง.

---

## ๐ฏ ูุธุงู ุงูุตูุงุญูุงุช

| ุงูุฏูุฑ           | ุตูุงุญูุฉ ุงูููุงุฏู               |
| --------------- | ---------------------------- |
| **Admin**       | ูู ุงูููุงุฏู                   |
| **Manager**     | ูู ุงูููุงุฏู                   |
| **Accountant**  | ูู ุงูููุงุฏู                   |
| **Supervisor**  | ูุฌููุนุฉ ููุงุฏู ุญุณุจ UserTenants |
| **Staff**       | ููุฏู ูุงุญุฏ ููุท (ูู UserTenants)|
| **ReadOnly**    | ุญุณุจ UserTenants              |

---

## ๐ ุงูุฌุฏุงูู ุงููุณุชุฎุฏูุฉ

### 1. **UserTenants** (ุฌุฏูู ุฌุฏูุฏ)
```sql
- Id (PK)
- UserId (FK โ MasterUsers)
- TenantId (FK โ Tenants)
- CreatedAt
```

### 2. **MasterUsers**
- ุงููุณุชุฎุฏููู ุงูุฑุฆูุณููู

### 3. **Roles**
- ุงูุฃุฏูุงุฑ (Admin, Manager, Accountant, Supervisor, Staff, ReadOnly)

### 4. **UserRoles**
- ุฑุจุท ุงููุณุชุฎุฏููู ุจุงูุฃุฏูุงุฑ

### 5. **Tenants**
- ุงูููุงุฏู ุงููุชุงุญุฉ

---

## ๐ ุฎุทูุงุช ุงูุฅุนุฏุงุฏ

### 1. ุฅูุดุงุก ุฌุฏูู UserTenants

ูู ุจุชุดุบูู SQL Script:
```sql
zaaerIntegration/Database/CreateUserTenantsTable.sql
```

**ููุงุญุธุฉ:** ูู ุจุชุบููุฑ `[YourDatabaseName]` ุฅูู ุงุณู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุฑุฆูุณูุฉ (Master DB).

---

### 2. ุฅุถุงูุฉ ุงูููุงุฏู ูููุณุชุฎุฏููู

#### ูุซุงู 1: ููุธู ุงุณุชูุจุงู (Staff) - ููุฏู ูุงุญุฏ ููุท

```sql
-- user12 ูู ููุธู ุงุณุชูุจุงู ูู Riyadh3 (TenantId = 9)
INSERT INTO UserTenants (UserId, TenantId)
VALUES (12, 9);   -- 9 = Riyadh3 (ูู ุฌุฏูู Tenants)
```

#### ูุซุงู 2: ูุดุฑู (Supervisor) - ุนุฏุฉ ููุงุฏู

```sql
-- user15 ูู ูุดุฑู ูุนุฏุฉ ููุงุฏู
INSERT INTO UserTenants (UserId, TenantId)
VALUES 
    (15, 1),  -- Dammam1
    (15, 2),  -- Dammam2
    (15, 9);  -- Riyadh3
```

#### ูุซุงู 3: Admin/Manager/Accountant

**ูุง ุญุงุฌุฉ ูุฅุถุงูุฉ ุฃู ุดูุก ูู UserTenants** - ูุคูุงุก ุงููุณุชุฎุฏููู ูุฑูู ูู ุงูููุงุฏู ุชููุงุฆูุงู.

---

## ๐ง ููููุฉ ุนูู ุงููุธุงู

### 1. API Endpoint: `/api/tenant/hotels`

**ุงููุชุทูุจุงุช:**
- โ JWT Token ูู Authorization Header
- โ `[Authorize]` attribute

**ุงูููุทู:**
1. ุงุณุชุฎุฑุงุฌ `userId` ู `roles` ูู JWT Token
2. ุงูุชุญูู ูู ุงูุฏูุฑ:
   - ุฅุฐุง ูุงู **Admin/Manager/Accountant** โ ุฅุฑุฌุงุน ูู ุงูููุงุฏู
   - ุฅุฐุง ูุงู **Supervisor/Staff/ReadOnly** โ ุฅุฑุฌุงุน ุงูููุงุฏู ูู `UserTenants` ููุท

**Logging:**
- โ ุชุณุฌูู ุงุณู ุงููุณุชุฎุฏู ูุงูุฏูุฑ
- โ ุชุณุฌูู ุนุฏุฏ ุงูููุงุฏู ุงูููุฑุฌุนุฉ
- โ ุชุณุฌูู ุฃููุงุฏ ุงูููุงุฏู (ูููุณุชุฎุฏููู ูุญุฏูุฏู ุงูุตูุงุญูุฉ)
- โ ุชุญุฐูุฑ ุฅุฐุง ูู ููู ูุฏู ุงููุณุชุฎุฏู ุฃู ููุงุฏู

---

### 2. ุงููุงุฌูุฉ ุงูุฃูุงููุฉ (expenses.html)

**ุงูุณููู:**
- โ ุฅุฑุณุงู JWT Token ูู Authorization Header
- โ ุฅุฐุง ูุงู ุงููุณุชุฎุฏู ูุฏูู **ููุฏู ูุงุญุฏ ููุท** โ ุชุนุทูู ุงูู dropdown ุชููุงุฆูุงู
- โ ุฅุฐุง ูุงู ูุฏูู **ุฃูุซุฑ ูู ููุฏู** โ ุงูุณูุงุญ ุจุงูุงุฎุชูุงุฑ
- โ ุฅุฐุง ูู ููู ูุฏูู **ุฃู ููุงุฏู** โ ุนุฑุถ ุฑุณุงูุฉ ุชุญุฐูุฑ

---

## ๐ ุฃูุซูุฉ SQL

### ุฅุถุงูุฉ ููุฏู ูุงุญุฏ ูููุธู ุงุณุชูุจุงู

```sql
-- ุงูุชุญูู ูู UserId ู TenantId ุฃููุงู
SELECT Id, Username FROM MasterUsers WHERE Username = 'user12';
SELECT Id, Code, Name FROM Tenants WHERE Code = 'Riyadh3';

-- ุฅุถุงูุฉ ุงูููุฏู ูููุณุชุฎุฏู
INSERT INTO UserTenants (UserId, TenantId)
VALUES (12, 9);
```

### ุฅุถุงูุฉ ุนุฏุฉ ููุงุฏู ููุดุฑู

```sql
-- ุฅุถุงูุฉ 3 ููุงุฏู ููุณุชุฎุฏู ูุงุญุฏ
INSERT INTO UserTenants (UserId, TenantId)
VALUES 
    (15, 1),  -- Dammam1
    (15, 2),  -- Dammam2
    (15, 9);  -- Riyadh3
```

### ุญุฐู ููุฏู ูู ูุณุชุฎุฏู

```sql
-- ุญุฐู ููุฏู ูุนูู ูู ูุณุชุฎุฏู
DELETE FROM UserTenants 
WHERE UserId = 15 AND TenantId = 2;
```

### ุนุฑุถ ุงูููุงุฏู ุงูุฎุงุตุฉ ุจูุณุชุฎุฏู

```sql
-- ุนุฑุถ ุฌููุน ุงูููุงุฏู ุงูุฎุงุตุฉ ุจูุณุชุฎุฏู ูุนูู
SELECT 
    ut.Id,
    u.Username,
    t.Code AS HotelCode,
    t.Name AS HotelName,
    ut.CreatedAt
FROM UserTenants ut
INNER JOIN MasterUsers u ON ut.UserId = u.Id
INNER JOIN Tenants t ON ut.TenantId = t.Id
WHERE u.Username = 'user15';
```

---

## โ๏ธ ููุงุญุธุงุช ูููุฉ

1. **Admin/Manager/Accountant** ูุง ูุญุชุงุฌูู ุฅุฏุฎุงูุงุช ูู `UserTenants` - ูุฑูู ูู ุงูููุงุฏู ุชููุงุฆูุงู.

2. **Staff (Reception Staff)** ูุฌุจ ุฃู ูููู ูุฏููู **ููุฏู ูุงุญุฏ ููุท** ูู `UserTenants`.

3. **Supervisor** ูููู ุฃู ูููู ูุฏููู **ุนุฏุฉ ููุงุฏู** ูู `UserTenants`.

4. **Unique Constraint:** ูุง ูููู ุฅุถุงูุฉ ููุณ ุงูููุฏู ูููุณ ุงููุณุชุฎุฏู ูุฑุชูู.

5. **Cascade Delete:** ุนูุฏ ุญุฐู ูุณุชุฎุฏูุ ูุชู ุญุฐู ุฌููุน ุณุฌูุงุช `UserTenants` ุงูุฎุงุตุฉ ุจู ุชููุงุฆูุงู.

---

## ๐ Troubleshooting

### ุงููุดููุฉ: ุงููุณุชุฎุฏู ูุง ูุฑู ุฃู ููุงุฏู

**ุงูุญู:**
1. ุชุญูู ูู ุฃู ุงููุณุชุฎุฏู ูุฏูู ุฏูุฑ ุตุญูุญ
2. ุชุญูู ูู ูุฌูุฏ ุณุฌูุงุช ูู `UserTenants`:
   ```sql
   SELECT * FROM UserTenants WHERE UserId = [USER_ID];
   ```
3. ุชุญูู ูู ุฃู `TenantId` ููุฌูุฏ ูู ุฌุฏูู `Tenants`

### ุงููุดููุฉ: Admin ูุง ูุฑู ูู ุงูููุงุฏู

**ุงูุญู:**
1. ุชุญูู ูู ุฃู ุงูุฏูุฑ ููุฌูุฏ ูู JWT Token
2. ุชุญูู ูู ุฃู ุงุณู ุงูุฏูุฑ ูุทุงุจู ุชูุงูุงู: `"Admin"` (case-sensitive ูู ุจุนุถ ุงูุญุงูุงุช)

---

## ๐ ุงููููุงุช ุงููุนุฏูุฉ

1. โ `Models/UserTenant.cs` - Model ุฌุฏูุฏ
2. โ `Data/MasterDbContext.cs` - ุฅุถุงูุฉ DbSet ูุชูููู ุงูุนูุงูุงุช
3. โ `Controllers/TenantController.cs` - ุชุนุฏูู API ูุน Authorization ู Logging
4. โ `wwwroot/expenses.html` - ุชุญุฏูุซ ุงููุงุฌูุฉ ุงูุฃูุงููุฉ
5. โ `Database/CreateUserTenantsTable.sql` - SQL Script ูุฅูุดุงุก ุงูุฌุฏูู

---

## โ ุฌุงูุฒ ููุงุณุชุฎุฏุงู!

ุงููุธุงู ุฌุงูุฒ ุงูุขู. ูู ุจู:
1. ุชุดุบูู SQL Script ูุฅูุดุงุก ุงูุฌุฏูู
2. ุฅุถุงูุฉ ุงูููุงุฏู ูููุณุชุฎุฏููู ูู `UserTenants`
3. ุงุฎุชุจุงุฑ ุงููุธุงู ูุน ูุณุชุฎุฏููู ูุฎุชูููู

